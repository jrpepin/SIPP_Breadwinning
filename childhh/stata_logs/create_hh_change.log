-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_logs/create_hh_change.log
  log type:  text
 opened on:   5 Dec 2019, 18:12:21

. 
. 
. * I would love to turn off line wrap so the state is a single
. * continuous string.  This seems not to be possible.  The best
. * we can do is set the line length to 255.  That's about 20 times
. * too short so why bother.
. *
. * Also, I considered saving the state as a note in the dataset
. * but this generic do file can't assume there is a dataset at all.
. display "Starting random number generator state"
Starting random number generator state

. display "`c(rngstate)'"
XAA0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
> 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
> 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
> 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
> 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
> 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
> 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
> 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
> 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
> 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
> 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
> 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
> 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
> 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
> 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
> 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
> 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
> 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
> 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
> 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
> 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
> 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
> 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
> 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
> 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
> 000000000000000000000000000000000000000000000000000000000000000000000001000001391839

. 
. 
. set varabbrev off

. 
. macro list
S_FNDATE:        5 Dec 2019 17:54
S_FN:           C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/SIPP08_Processed/comp_change.dta
ReS_jv2:        1 2 3
ReS_Call:       version 15.1:
max_tc:         1
refmon:         4
adult_age:      18
penultimate_wave:
                14
second_wave:    2
final_wave:     15
first_wave:     1
replace:        replace
SIPP08keep:     C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/SIPP08_Processed
tempdir:        C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp
results:        C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//results
sipp2008_logs:  C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_logs
sipp2008_code:  C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//SIPP2008
childhh_base_code:
                C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh/
SIPP2008:       C:\Users\Joanna/Dropbox/Data/SIPP/SIPP2008
homedir:        C:\Users\Joanna
S_level:        95
F1:             help advice;
F2:             describe;
F7:             save
F8:             use
S_ADO:          BASE;SITE;.;PERSONAL;PLUS;OLDPLACE
S_StataMP:      MP
S_StataSE:      SE
S_FLAVOR:       Intercooled
S_OS:           Windows
S_OSDTL:        64-bit
S_MACH:         PC (64-bit x86-64)
_fname:         create_hh_change
_logdir:        C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_logs
_2:             create_hh_change
_1:             C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_logs
_0:             "C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_logs" "create_hh_change"

. 
. pwd
C:\Users\Joanna\Dropbox\Repositories\SIPP_Breadwinning\childhh

. 
end of do-file

. 
. 
. do "`codedir'/`fname'"

. //==============================================================================
. //===== Children's Household Instability Project                                                    
. //===== Dataset: SIPP2008                                                                               
. //===== Purpose: Create a database with comp_change, addr_change, and sociodemographic characteristics
. //===== One record per person per wave.
. //===== create_comp_change generates the variable comp_change. This file adds addr_change
. //===== and reshapes the data to long form.
. //===== Note: this code depends on macros set in project_macros and create_comp_change
. //==============================================================================
. 
. use "$SIPP08keep/comp_change.dta", clear

. 
. #delimit ; 
delimiter now ;
. label define addr_change          0 "No move"
>                                   1 "Move";

.          #delimit cr
delimiter now cr
. 
. ********************************************************************************
. * Function Propagate shhadid_members forard into prev_SHHADID for missing waves.
. ********************************************************************************
. 
. gen prev_SHHADID$first_wave = .
(130,851 missing values generated)

. forvalues wave = $second_wave/$final_wave {
  2.     local prev_wave = `wave' - 1
  3.     gen prev_SHHADID`wave' = SHHADID`prev_wave' if (missing(SHHADID`wave') & missing(prev_SHHADID`prev_wave'))
  4.     replace prev_SHHADID`wave' = prev_SHHADID`prev_wave' if (missing(SHHADID`wave') & (!missing(prev_SHHADID`prev_wave')))
  5. }
SHHADID1 not found
r(111);

end of do-file
r(111);

end of do-file
r(111);

end of do-file

r(111);

. clear

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. //==============================================================================
. //===== Children's Household Instability Project                                                    
. //===== Dataset: SIPP2008                                                                               
. //===== Purpose: Create a database with comp_change, addr_change, and sociodemographic characteristics
. //===== One record per person per wave.
. //===== create_comp_change generates the variable comp_change. This file adds addr_change
. //===== and reshapes the data to long form.
. //===== Note: this code depends on macros set in project_macros and create_comp_change
. //==============================================================================
. 
. use "$SIPP08keep/comp_change.dta", clear

. 
. #delimit ; 
delimiter now ;
. label define addr_change          0 "No move"
>                                   1 "Move";

.          #delimit cr
delimiter now cr
. 
. ********************************************************************************
. * Function Propagate shhadid_members forard into prev_shhadid for missing waves.
. ********************************************************************************
. 
. gen prev_shhadid$first_wave = .
(130,851 missing values generated)

. forvalues wave = $second_wave/$final_wave {
  2.     local prev_wave = `wave' - 1
  3.     gen prev_shhadid`wave' = shhadid`prev_wave' if (missing(shhadid`wave') & missing(prev_shhadid`prev_wave'))
  4.     replace prev_shhadid`wave' = prev_shhadid`prev_wave' if (missing(shhadid`wave') & (!missing(prev_shhadid`prev_wave')))
  5. }
(121,076 missing values generated)
(0 real changes made)
(121,734 missing values generated)
(6,452 real changes made)
(120,593 missing values generated)
(11,849 real changes made)
(122,296 missing values generated)
(16,558 real changes made)
(121,736 missing values generated)
(20,424 real changes made)
(121,402 missing values generated)
(24,735 real changes made)
(122,789 missing values generated)
(28,779 real changes made)
(122,485 missing values generated)
(32,288 real changes made)
(121,949 missing values generated)
(36,288 real changes made)
(123,409 missing values generated)
(40,336 real changes made)
(123,479 missing values generated)
(42,570 real changes made)
(122,899 missing values generated)
(44,775 real changes made)
(123,748 missing values generated)
(47,901 real changes made)
(124,971 missing values generated)
(52,497 real changes made)

. 
. ********************************************************************************
. ** Function:  Propagate shhadid_members backward into future_hh_members for missing waves.  
. ********************************************************************************
. 
. gen future_shhadid$final_wave = .
(130,851 missing values generated)

. forvalues wave = $penultimate_wave (-1) $first_wave {
  2.     local next_wave = `wave' + 1
  3.     gen future_shhadid`wave' = shhadid`next_wave' if (missing(shhadid`wave') & missing(future_shhadid`next_wave'))
  4.     replace future_shhadid`wave' = future_shhadid`next_wave' if (missing(shhadid`wave') & (!missing(future_shhadid`next_wave')))
  5. }
(127,415 missing values generated)
(0 real changes made)
(124,864 missing values generated)
(1,076 real changes made)
(124,152 missing values generated)
(4,486 real changes made)
(124,293 missing values generated)
(7,994 real changes made)
(124,629 missing values generated)
(11,047 real changes made)
(124,888 missing values generated)
(12,530 real changes made)
(124,625 missing values generated)
(14,061 real changes made)
(123,786 missing values generated)
(16,111 real changes made)
(124,169 missing values generated)
(17,691 real changes made)
(124,049 missing values generated)
(19,074 real changes made)
(123,038 missing values generated)
(20,783 real changes made)
(124,626 missing values generated)
(22,046 real changes made)
(124,986 missing values generated)
(22,726 real changes made)
(128,235 missing values generated)
(22,572 real changes made)

. 
. ********************************************************************************
. ** Function: walk backward through the waves and for each wave in which ego is missing  compare prev_SHHAIDD to see if we find anyone
. ********************************************************************************
. 
. gen found_prev_shhadid$first_wave = .
(130,851 missing values generated)

. forvalues wave = $final_wave (-1) $second_wave {
  2.         gen found_prev_shhadid`wave'= 0 if (missing(shhadid`wave'))
  3.         gen found_prev_shhadid_in_gap`wave'=0 if (missing(shhadid`wave'))
  4.         replace found_prev_shhadid`wave' = 1 if ((missing(shhadid`wave')) & (strpos(ssuid_shhadid`wave', " " + string(prev_shhadid`wave') + " ") != 0))
  5.         replace found_prev_shhadid_in_gap`wave' = 1 if ((missing(shhadid`wave')) & (strpos(ssuid_shhadid`wave', " " + string(prev_shhadid`wave') + " ") !=0))
  6.         if (`wave' < $final_wave) {
  7.                 local next_wave = `wave' + 1
  8.                 replace found_prev_shhadid_in_gap`wave' = 1 if ((missing(shhadid`wave')) & (found_prev_shhadid_in_gap`next_wave' == 1))
  9.         }
 10. }
(72,474 missing values generated)
(72,474 missing values generated)
(6,815 real changes made)
(6,815 real changes made)
(74,918 missing values generated)
(74,918 missing values generated)
(6,630 real changes made)
(6,630 real changes made)
(249 real changes made)
(76,034 missing values generated)
(76,034 missing values generated)
(6,400 real changes made)
(6,400 real changes made)
(375 real changes made)
(77,287 missing values generated)
(77,287 missing values generated)
(6,097 real changes made)
(6,097 real changes made)
(612 real changes made)
(78,101 missing values generated)
(78,101 missing values generated)
(5,800 real changes made)
(5,800 real changes made)
(684 real changes made)
(79,321 missing values generated)
(79,321 missing values generated)
(5,466 real changes made)
(5,466 real changes made)
(696 real changes made)
(82,260 missing values generated)
(82,260 missing values generated)
(5,097 real changes made)
(5,097 real changes made)
(649 real changes made)
(84,400 missing values generated)
(84,400 missing values generated)
(4,648 real changes made)
(4,648 real changes made)
(645 real changes made)
(85,397 missing values generated)
(85,397 missing values generated)
(4,207 real changes made)
(4,207 real changes made)
(587 real changes made)
(88,164 missing values generated)
(88,164 missing values generated)
(3,720 real changes made)
(3,720 real changes made)
(467 real changes made)
(90,477 missing values generated)
(90,477 missing values generated)
(3,153 real changes made)
(3,153 real changes made)
(412 real changes made)
(91,219 missing values generated)
(91,219 missing values generated)
(2,560 real changes made)
(2,560 real changes made)
(388 real changes made)
(95,252 missing values generated)
(95,252 missing values generated)
(1,876 real changes made)
(1,876 real changes made)
(264 real changes made)
(98,504 missing values generated)
(98,504 missing values generated)
(1,082 real changes made)
(1,082 real changes made)
(152 real changes made)

. 
. ********************************************************************************
. ** Function: walk forward through the waves 
. ********************************************************************************
. 
. gen found_future_shhadid$final_wave = .
(130,851 missing values generated)

. forvalues wave = $first_wave/$penultimate_wave {
  2.         gen found_future_shhadid`wave'= 0 if (missing(shhadid`wave'))
  3.         gen found_future_shhadid_in_gap`wave'=0 if (missing(shhadid`wave'))
  4.         replace found_future_shhadid`wave' = 1 if ((missing(shhadid`wave')) & (strpos(ssuid_shhadid`wave', " " + string(prev_shhadid`wave') + " ") != 0))
  5.         replace found_future_shhadid_in_gap`wave' = 1 if ((missing(shhadid`wave')) & (strpos(ssuid_shhadid`wave', " " + string(prev_shhadid`wave') + " ") !=0))
  6.         if (`wave' > $final_wave) {
  7.                 local prev_wave = `wave' - 1
  8.                 replace found_future_shhadid_in_gap`wave' = 1 if ((missing(shhadid`wave')) & (found_future_shhadid_in_gap`prev_wave' == 1))
  9.         }
 10. }
(105,663 missing values generated)
(105,663 missing values generated)
(0 real changes made)
(0 real changes made)
(98,504 missing values generated)
(98,504 missing values generated)
(1,082 real changes made)
(1,082 real changes made)
(95,252 missing values generated)
(95,252 missing values generated)
(1,876 real changes made)
(1,876 real changes made)
(91,219 missing values generated)
(91,219 missing values generated)
(2,560 real changes made)
(2,560 real changes made)
(90,477 missing values generated)
(90,477 missing values generated)
(3,153 real changes made)
(3,153 real changes made)
(88,164 missing values generated)
(88,164 missing values generated)
(3,720 real changes made)
(3,720 real changes made)
(85,397 missing values generated)
(85,397 missing values generated)
(4,207 real changes made)
(4,207 real changes made)
(84,400 missing values generated)
(84,400 missing values generated)
(4,648 real changes made)
(4,648 real changes made)
(82,260 missing values generated)
(82,260 missing values generated)
(5,097 real changes made)
(5,097 real changes made)
(79,321 missing values generated)
(79,321 missing values generated)
(5,466 real changes made)
(5,466 real changes made)
(78,101 missing values generated)
(78,101 missing values generated)
(5,800 real changes made)
(5,800 real changes made)
(77,287 missing values generated)
(77,287 missing values generated)
(6,097 real changes made)
(6,097 real changes made)
(76,034 missing values generated)
(76,034 missing values generated)
(6,400 real changes made)
(6,400 real changes made)
(74,918 missing values generated)
(74,918 missing values generated)
(6,630 real changes made)
(6,630 real changes made)

. 
. *******************************************************************************
. ** Function: Compute address change.
. *******************************************************************************
. 
. forvalues wave = $first_wave/$penultimate_wave {
  2.     local next_wave = `wave' + 1
  3. 
.     * Start by assuming this wave is not interesting.
.     gen addr_change`wave' = .
  4. 
.     * If we have data in both waves, just compare HH members.
.     replace addr_change`wave' = (shhadid`wave' != shhadid`next_wave') if ((!missing(shhadid`wave')) & (!missing(shhadid`next_wave')))
  5. 
.     * If we are moving from a wave in which ego is missing to one in which ego is present
.     * there is an address change if we have seen the future shhadid in the gap during which ego was missing
.     * UNLESS this is ego's birth.
.     * We also need to populate age and weight from the next wave since ego has no data in this wave.
.     replace addr_change`wave' = 1 if ((missing(shhadid`wave')) & (!missing(shhadid`next_wave')) & (found_future_shhadid_in_gap`wave' == 1))
  6.     replace adj_age`wave' = adj_age`next_wave' if ((missing(shhadid`wave')) & (!missing(shhadid`next_wave')) & (found_future_shhadid_in_gap`wave' == 1))
  7.     replace WPFINWGT`wave' = WPFINWGT`next_wave' if ((missing(shhadid`wave')) & (!missing(shhadid`next_wave')) & (found_future_shhadid_in_gap`wave' == 1))
  8.     * Undo those changes if this is birth.
.     replace addr_change`wave' = . if ((`next_wave' == my_first_wave) & (adj_age`next_wave' == 0))
  9.     replace adj_age`wave' = . if ((`next_wave' == my_first_wave) & (adj_age`next_wave' == 0))
 10.     replace WPFINWGT`wave' = . if ((`next_wave' == my_first_wave) & (adj_age`next_wave' == 0))
 11. 
.     * If we are moving from a wave in which ego is present to one in which ego is missing
.     * there is an address change if we have seen the current shhadid in the gap 
.     * during which ego is missing as we look forward.
.     replace addr_change`wave' = 1 if ((!missing(shhadid`wave')) & (missing(shhadid`next_wave')) & (found_prev_shhadid_in_gap`next_wave' == 1))
 12. 
.     * If we are moving from a wave in which ego is present to one in which ego is missing
.     * and we do not see the current shhadid in the gap looking forward,
.     * we compare the current shhadid to the future shhadid as if we move into the
.     * future household in the first missing wave, unless there is no future shhadid
.     * (ego's last appearance).
.     replace addr_change`wave' = (shhadid`wave' != future_shhadid`next_wave') if ((!missing(shhadid`wave')) & (missing(shhadid`next_wave')) & (!missing(future_shhadid`next_wave')) & (found_prev_shha
> did_in_gap`next_wave' != 1))
 13. 
. 
.     * Tab "original" addr_change and comp_change variables.
.     tab addr_change`wave' comp_change`wave', m
 14. 
.     * We once forced them up to have the same denominator by setting to zero if missing and the other variable is not missing.
.         * but this is not appropriate. Sometimes we can know if there was an address change even if we don't know household composition
.         * Keeping this here to document.
. *    replace addr_change`wave' = 0 if (missing(addr_change`wave') & (!missing(comp_change`wave')))
. *    replace comp_change`wave' = 0 if (missing(comp_change`wave') & (!missing(addr_change`wave')))
. 
. *    tab addr_change`wave' comp_change`wave', m
. }
(130,851 missing values generated)
(95,888 real changes made)
(0 real changes made)
(0 real changes made)
variable WPFINWGT1 not found
r(111);

end of do-file

r(111);

. clear

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. //==============================================================================
. //===== Children's Household Instability Project                                                    
. //===== Dataset: SIPP2008                                                                               
. //===== Purpose: Create a database with comp_change, addr_change, and sociodemographic characteristics
. //===== One record per person per wave.
. //===== create_comp_change generates the variable comp_change. This file adds addr_change
. //===== and reshapes the data to long form.
. //===== Note: this code depends on macros set in project_macros and create_comp_change
. //==============================================================================
. 
. use "$SIPP08keep/comp_change.dta", clear

. 
. #delimit ; 
delimiter now ;
. label define addr_change          0 "No move"
>                                   1 "Move";

.          #delimit cr
delimiter now cr
. 
. ********************************************************************************
. * Function Propagate shhadid_members forard into prev_shhadid for missing waves.
. ********************************************************************************
. 
. gen prev_shhadid$first_wave = .
(130,851 missing values generated)

. forvalues wave = $second_wave/$final_wave {
  2.     local prev_wave = `wave' - 1
  3.     gen prev_shhadid`wave' = shhadid`prev_wave' if (missing(shhadid`wave') & missing(prev_shhadid`prev_wave'))
  4.     replace prev_shhadid`wave' = prev_shhadid`prev_wave' if (missing(shhadid`wave') & (!missing(prev_shhadid`prev_wave')))
  5. }
(121,076 missing values generated)
(0 real changes made)
(121,734 missing values generated)
(6,452 real changes made)
(120,593 missing values generated)
(11,849 real changes made)
(122,296 missing values generated)
(16,558 real changes made)
(121,736 missing values generated)
(20,424 real changes made)
(121,402 missing values generated)
(24,735 real changes made)
(122,789 missing values generated)
(28,779 real changes made)
(122,485 missing values generated)
(32,288 real changes made)
(121,949 missing values generated)
(36,288 real changes made)
(123,409 missing values generated)
(40,336 real changes made)
(123,479 missing values generated)
(42,570 real changes made)
(122,899 missing values generated)
(44,775 real changes made)
(123,748 missing values generated)
(47,901 real changes made)
(124,971 missing values generated)
(52,497 real changes made)

. 
. ********************************************************************************
. ** Function:  Propagate shhadid_members backward into future_hh_members for missing waves.  
. ********************************************************************************
. 
. gen future_shhadid$final_wave = .
(130,851 missing values generated)

. forvalues wave = $penultimate_wave (-1) $first_wave {
  2.     local next_wave = `wave' + 1
  3.     gen future_shhadid`wave' = shhadid`next_wave' if (missing(shhadid`wave') & missing(future_shhadid`next_wave'))
  4.     replace future_shhadid`wave' = future_shhadid`next_wave' if (missing(shhadid`wave') & (!missing(future_shhadid`next_wave')))
  5. }
(127,415 missing values generated)
(0 real changes made)
(124,864 missing values generated)
(1,076 real changes made)
(124,152 missing values generated)
(4,486 real changes made)
(124,293 missing values generated)
(7,994 real changes made)
(124,629 missing values generated)
(11,047 real changes made)
(124,888 missing values generated)
(12,530 real changes made)
(124,625 missing values generated)
(14,061 real changes made)
(123,786 missing values generated)
(16,111 real changes made)
(124,169 missing values generated)
(17,691 real changes made)
(124,049 missing values generated)
(19,074 real changes made)
(123,038 missing values generated)
(20,783 real changes made)
(124,626 missing values generated)
(22,046 real changes made)
(124,986 missing values generated)
(22,726 real changes made)
(128,235 missing values generated)
(22,572 real changes made)

. 
. ********************************************************************************
. ** Function: walk backward through the waves and for each wave in which ego is missing  compare prev_SHHAIDD to see if we find anyone
. ********************************************************************************
. 
. gen found_prev_shhadid$first_wave = .
(130,851 missing values generated)

. forvalues wave = $final_wave (-1) $second_wave {
  2.         gen found_prev_shhadid`wave'= 0 if (missing(shhadid`wave'))
  3.         gen found_prev_shhadid_in_gap`wave'=0 if (missing(shhadid`wave'))
  4.         replace found_prev_shhadid`wave' = 1 if ((missing(shhadid`wave')) & (strpos(ssuid_shhadid`wave', " " + string(prev_shhadid`wave') + " ") != 0))
  5.         replace found_prev_shhadid_in_gap`wave' = 1 if ((missing(shhadid`wave')) & (strpos(ssuid_shhadid`wave', " " + string(prev_shhadid`wave') + " ") !=0))
  6.         if (`wave' < $final_wave) {
  7.                 local next_wave = `wave' + 1
  8.                 replace found_prev_shhadid_in_gap`wave' = 1 if ((missing(shhadid`wave')) & (found_prev_shhadid_in_gap`next_wave' == 1))
  9.         }
 10. }
(72,474 missing values generated)
(72,474 missing values generated)
(6,815 real changes made)
(6,815 real changes made)
(74,918 missing values generated)
(74,918 missing values generated)
(6,630 real changes made)
(6,630 real changes made)
(249 real changes made)
(76,034 missing values generated)
(76,034 missing values generated)
(6,400 real changes made)
(6,400 real changes made)
(375 real changes made)
(77,287 missing values generated)
(77,287 missing values generated)
(6,097 real changes made)
(6,097 real changes made)
(612 real changes made)
(78,101 missing values generated)
(78,101 missing values generated)
(5,800 real changes made)
(5,800 real changes made)
(684 real changes made)
(79,321 missing values generated)
(79,321 missing values generated)
(5,466 real changes made)
(5,466 real changes made)
(696 real changes made)
(82,260 missing values generated)
(82,260 missing values generated)
(5,097 real changes made)
(5,097 real changes made)
(649 real changes made)
(84,400 missing values generated)
(84,400 missing values generated)
(4,648 real changes made)
(4,648 real changes made)
(645 real changes made)
(85,397 missing values generated)
(85,397 missing values generated)
(4,207 real changes made)
(4,207 real changes made)
(587 real changes made)
(88,164 missing values generated)
(88,164 missing values generated)
(3,720 real changes made)
(3,720 real changes made)
(467 real changes made)
(90,477 missing values generated)
(90,477 missing values generated)
(3,153 real changes made)
(3,153 real changes made)
(412 real changes made)
(91,219 missing values generated)
(91,219 missing values generated)
(2,560 real changes made)
(2,560 real changes made)
(388 real changes made)
(95,252 missing values generated)
(95,252 missing values generated)
(1,876 real changes made)
(1,876 real changes made)
(264 real changes made)
(98,504 missing values generated)
(98,504 missing values generated)
(1,082 real changes made)
(1,082 real changes made)
(152 real changes made)

. 
. ********************************************************************************
. ** Function: walk forward through the waves 
. ********************************************************************************
. 
. gen found_future_shhadid$final_wave = .
(130,851 missing values generated)

. forvalues wave = $first_wave/$penultimate_wave {
  2.         gen found_future_shhadid`wave'= 0 if (missing(shhadid`wave'))
  3.         gen found_future_shhadid_in_gap`wave'=0 if (missing(shhadid`wave'))
  4.         replace found_future_shhadid`wave' = 1 if ((missing(shhadid`wave')) & (strpos(ssuid_shhadid`wave', " " + string(prev_shhadid`wave') + " ") != 0))
  5.         replace found_future_shhadid_in_gap`wave' = 1 if ((missing(shhadid`wave')) & (strpos(ssuid_shhadid`wave', " " + string(prev_shhadid`wave') + " ") !=0))
  6.         if (`wave' > $final_wave) {
  7.                 local prev_wave = `wave' - 1
  8.                 replace found_future_shhadid_in_gap`wave' = 1 if ((missing(shhadid`wave')) & (found_future_shhadid_in_gap`prev_wave' == 1))
  9.         }
 10. }
(105,663 missing values generated)
(105,663 missing values generated)
(0 real changes made)
(0 real changes made)
(98,504 missing values generated)
(98,504 missing values generated)
(1,082 real changes made)
(1,082 real changes made)
(95,252 missing values generated)
(95,252 missing values generated)
(1,876 real changes made)
(1,876 real changes made)
(91,219 missing values generated)
(91,219 missing values generated)
(2,560 real changes made)
(2,560 real changes made)
(90,477 missing values generated)
(90,477 missing values generated)
(3,153 real changes made)
(3,153 real changes made)
(88,164 missing values generated)
(88,164 missing values generated)
(3,720 real changes made)
(3,720 real changes made)
(85,397 missing values generated)
(85,397 missing values generated)
(4,207 real changes made)
(4,207 real changes made)
(84,400 missing values generated)
(84,400 missing values generated)
(4,648 real changes made)
(4,648 real changes made)
(82,260 missing values generated)
(82,260 missing values generated)
(5,097 real changes made)
(5,097 real changes made)
(79,321 missing values generated)
(79,321 missing values generated)
(5,466 real changes made)
(5,466 real changes made)
(78,101 missing values generated)
(78,101 missing values generated)
(5,800 real changes made)
(5,800 real changes made)
(77,287 missing values generated)
(77,287 missing values generated)
(6,097 real changes made)
(6,097 real changes made)
(76,034 missing values generated)
(76,034 missing values generated)
(6,400 real changes made)
(6,400 real changes made)
(74,918 missing values generated)
(74,918 missing values generated)
(6,630 real changes made)
(6,630 real changes made)

. 
. *******************************************************************************
. ** Function: Compute address change.
. *******************************************************************************
. 
. forvalues wave = $first_wave/$penultimate_wave {
  2.     local next_wave = `wave' + 1
  3. 
.     * Start by assuming this wave is not interesting.
.     gen addr_change`wave' = .
  4. 
.     * If we have data in both waves, just compare HH members.
.     replace addr_change`wave' = (shhadid`wave' != shhadid`next_wave') if ((!missing(shhadid`wave')) & (!missing(shhadid`next_wave')))
  5. 
.     * If we are moving from a wave in which ego is missing to one in which ego is present
.     * there is an address change if we have seen the future shhadid in the gap during which ego was missing
.     * UNLESS this is ego's birth.
.     * We also need to populate age and weight from the next wave since ego has no data in this wave.
.     replace addr_change`wave' = 1 if ((missing(shhadid`wave')) & (!missing(shhadid`next_wave')) & (found_future_shhadid_in_gap`wave' == 1))
  6.     replace adj_age`wave' = adj_age`next_wave' if ((missing(shhadid`wave')) & (!missing(shhadid`next_wave')) & (found_future_shhadid_in_gap`wave' == 1))
  7.     replace wpfinwgt`wave' = wpfinwgt`next_wave' if ((missing(shhadid`wave')) & (!missing(shhadid`next_wave')) & (found_future_shhadid_in_gap`wave' == 1))
  8.     * Undo those changes if this is birth.
.     replace addr_change`wave' = . if ((`next_wave' == my_first_wave) & (adj_age`next_wave' == 0))
  9.     replace adj_age`wave' = . if ((`next_wave' == my_first_wave) & (adj_age`next_wave' == 0))
 10.     replace wpfinwgt`wave' = . if ((`next_wave' == my_first_wave) & (adj_age`next_wave' == 0))
 11. 
.     * If we are moving from a wave in which ego is present to one in which ego is missing
.     * there is an address change if we have seen the current shhadid in the gap 
.     * during which ego is missing as we look forward.
.     replace addr_change`wave' = 1 if ((!missing(shhadid`wave')) & (missing(shhadid`next_wave')) & (found_prev_shhadid_in_gap`next_wave' == 1))
 12. 
.     * If we are moving from a wave in which ego is present to one in which ego is missing
.     * and we do not see the current shhadid in the gap looking forward,
.     * we compare the current shhadid to the future shhadid as if we move into the
.     * future household in the first missing wave, unless there is no future shhadid
.     * (ego's last appearance).
.     replace addr_change`wave' = (shhadid`wave' != future_shhadid`next_wave') if ((!missing(shhadid`wave')) & (missing(shhadid`next_wave')) & (!missing(future_shhadid`next_wave')) & (found_prev_shha
> did_in_gap`next_wave' != 1))
 13. 
. 
.     * Tab "original" addr_change and comp_change variables.
.     tab addr_change`wave' comp_change`wave', m
 14. 
.     * We once forced them up to have the same denominator by setting to zero if missing and the other variable is not missing.
.         * but this is not appropriate. Sometimes we can know if there was an address change even if we don't know household composition
.         * Keeping this here to document.
. *    replace addr_change`wave' = 0 if (missing(addr_change`wave') & (!missing(comp_change`wave')))
. *    replace comp_change`wave' = 0 if (missing(comp_change`wave') & (!missing(addr_change`wave')))
. 
. *    tab addr_change`wave' comp_change`wave', m
. }
(130,851 missing values generated)
(95,888 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1,234 real changes made)
(5,690 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e1 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    90,236      6,890          0 |    97,126 
         1 |     2,776      2,910          0 |     5,686 
         . |         0      2,422     25,617 |    28,039 
-----------+---------------------------------+----------
     Total |    93,012     12,222     25,617 |   130,851 
(130,851 missing values generated)
(89,387 real changes made)
(109 real changes made)
(32 real changes made)
(65 real changes made)
(0 real changes made)
(406 real changes made, 406 to missing)
(0 real changes made)
(1,166 real changes made)
(5,223 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e2 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    83,757      5,964          0 |    89,721 
         1 |     2,870      3,229         65 |     6,164 
         . |         0      2,532     32,434 |    34,966 
-----------+---------------------------------+----------
     Total |    86,627     11,725     32,499 |   130,851 
(130,851 missing values generated)
(84,994 real changes made)
(172 real changes made)
(100 real changes made)
(102 real changes made)
(0 real changes made)
(406 real changes made, 406 to missing)
(0 real changes made)
(1,210 real changes made)
(6,203 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e3 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    79,784      6,051          0 |    85,835 
         1 |     3,196      3,444        104 |     6,744 
         . |         0      2,604     35,668 |    38,272 
-----------+---------------------------------+----------
     Total |    82,980     12,099     35,772 |   130,851 
(130,851 missing values generated)
(82,664 real changes made)
(212 real changes made)
(45 real changes made)
(138 real changes made)
(0 real changes made)
(415 real changes made, 415 to missing)
(0 real changes made)
(1,099 real changes made)
(4,848 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e4 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    77,925      5,523          0 |    83,448 
         1 |     2,439      2,798        138 |     5,375 
         . |         0      2,375     39,653 |    42,028 
-----------+---------------------------------+----------
     Total |    80,364     10,696     39,791 |   130,851 
(130,851 missing values generated)
(81,362 real changes made)
(162 real changes made)
(55 real changes made)
(86 real changes made)
(0 real changes made)
(357 real changes made, 357 to missing)
(0 real changes made)
(1,091 real changes made)
(5,084 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e5 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    76,851      5,246          0 |    82,097 
         1 |     2,750      2,765         87 |     5,602 
         . |         0      2,321     40,831 |    43,152 
-----------+---------------------------------+----------
     Total |    79,601     10,332     40,918 |   130,851 
(130,851 missing values generated)
(78,715 real changes made)
(184 real changes made)
(87 real changes made)
(87 real changes made)
(0 real changes made)
(330 real changes made, 330 to missing)
(0 real changes made)
(1,155 real changes made)
(5,218 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e6 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    74,707      4,978          0 |    79,685 
         1 |     2,621      2,878         88 |     5,587 
         . |         0      2,092     43,487 |    45,579 
-----------+---------------------------------+----------
     Total |    77,328      9,948     43,575 |   130,851 
(130,851 missing values generated)
(77,335 real changes made)
(217 real changes made)
(39 real changes made)
(103 real changes made)
(0 real changes made)
(298 real changes made, 298 to missing)
(0 real changes made)
(1,047 real changes made)
(4,011 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e7 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    73,515      4,591          0 |    78,106 
         1 |     2,008      2,392        104 |     4,504 
         . |         0      1,871     46,370 |    48,241 
-----------+---------------------------------+----------
     Total |    75,523      8,854     46,474 |   130,851 
(130,851 missing values generated)
(76,034 real changes made)
(144 real changes made)
(43 real changes made)
(58 real changes made)
(0 real changes made)
(314 real changes made, 314 to missing)
(0 real changes made)
(1,001 real changes made)
(4,261 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e8 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    72,325      4,531          0 |    76,856 
         1 |     2,212      2,314         58 |     4,584 
         . |         0      1,940     47,471 |    49,411 
-----------+---------------------------------+----------
     Total |    74,537      8,785     47,529 |   130,851 
(130,851 missing values generated)
(73,358 real changes made)
(166 real changes made)
(69 real changes made)
(72 real changes made)
(0 real changes made)
(309 real changes made, 309 to missing)
(0 real changes made)
(1,031 real changes made)
(4,588 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e9 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    69,661      4,525          0 |    74,186 
         1 |     2,401      2,483         73 |     4,957 
         . |         0      1,845     49,863 |    51,708 
-----------+---------------------------------+----------
     Total |    72,062      8,853     49,936 |   130,851 
(130,851 missing values generated)
(71,879 real changes made)
(159 real changes made)
(19 real changes made)
(59 real changes made)
(0 real changes made)
(298 real changes made, 298 to missing)
(0 real changes made)
(911 real changes made)
(3,367 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
       e10 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    68,589      3,931          0 |    72,520 
         1 |     1,711      2,026         59 |     3,796 
         . |         0      1,556     52,979 |    54,535 
-----------+---------------------------------+----------
     Total |    70,300      7,513     53,038 |   130,851 
(130,851 missing values generated)
(70,729 real changes made)
(187 real changes made)
(41 real changes made)
(72 real changes made)
(0 real changes made)
(298 real changes made, 298 to missing)
(0 real changes made)
(882 real changes made)
(3,086 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
       e11 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    67,100      3,842          0 |    70,942 
         1 |     1,930      1,939         73 |     3,942 
         . |         0      1,464     54,503 |    55,967 
-----------+---------------------------------+----------
     Total |    69,030      7,245     54,576 |   130,851 
(130,851 missing values generated)
(69,335 real changes made)
(192 real changes made)
(84 real changes made)
(85 real changes made)
(0 real changes made)
(314 real changes made, 314 to missing)
(0 real changes made)
(797 real changes made)
(2,504 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
       e12 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    65,060      3,734          0 |    68,794 
         1 |     2,087      1,862         85 |     4,034 
         . |         0      1,682     56,341 |    58,023 
-----------+---------------------------------+----------
     Total |    67,147      7,278     56,426 |   130,851 
(130,851 missing values generated)
(68,931 real changes made)
(176 real changes made)
(28 real changes made)
(76 real changes made)
(0 real changes made)
(273 real changes made, 273 to missing)
(0 real changes made)
(770 real changes made)
(2,309 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
       e13 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    65,580      3,499          0 |    69,079 
         1 |     1,416      1,615         76 |     3,107 
         . |         0      1,309     57,356 |    58,665 
-----------+---------------------------------+----------
     Total |    66,996      6,423     57,432 |   130,851 
(130,851 missing values generated)
(69,038 real changes made)
(113 real changes made)
(13 real changes made)
(19 real changes made)
(0 real changes made)
(262 real changes made, 262 to missing)
(0 real changes made)
(701 real changes made)
(0 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
       e14 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    63,914      2,993          0 |    66,907 
         1 |     1,467      1,459         19 |     2,945 
         . |         0        996     60,003 |    60,999 
-----------+---------------------------------+----------
     Total |    65,381      5,448     60,022 |   130,851 

. 
. gen original=1 if !missing(shhadid1)
(25,188 missing values generated)

. gen agewave1=adj_age1 if original==1
(25,188 missing values generated)

. 
. keep ssuid epppnum shhadid* adj_age* comp_change* addr_change* comp_change_reason* original agewave1

. 
. reshape long shhadid adj_age comp_change addr_change comp_change_reason, i(ssuid epppnum) j(swave)
(note: j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15)
(note: comp_change15 not found)
(note: addr_change15 not found)
(note: comp_change_reason15 not found)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                   130851   -> 2.0e+06
Number of variables                  91   ->      25
j variable (15 values)                    ->   swave
xij variables:
        shhadid1 shhadid2 ... shhadid15   ->   shhadid
        adj_age1 adj_age2 ... adj_age15   ->   adj_age
comp_change1 comp_change2 ... comp_change15->  comp_change
addr_change1 addr_change2 ... addr_change15->  addr_change
comp_change_reason1 comp_change_reason2 ... comp_change_reason15->comp_change_reason
-----------------------------------------------------------------------------

. 
. merge 1:1 ssuid epppnum swave using "$tempdir/demo_long_all.dta"
variable swave not found
r(111);

end of do-file

r(111);

. clear

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. //==============================================================================
. //===== Children's Household Instability Project                                                    
. //===== Dataset: SIPP2008                                                                               
. //===== Purpose: Create a database with comp_change, addr_change, and sociodemographic characteristics
. //===== One record per person per wave.
. //===== create_comp_change generates the variable comp_change. This file adds addr_change
. //===== and reshapes the data to long form.
. //===== Note: this code depends on macros set in project_macros and create_comp_change
. //==============================================================================
. 
. use "$SIPP08keep/comp_change.dta", clear

. 
. #delimit ; 
delimiter now ;
. label define addr_change          0 "No move"
>                                   1 "Move";

.          #delimit cr
delimiter now cr
. 
. ********************************************************************************
. * Function Propagate shhadid_members forard into prev_shhadid for missing waves.
. ********************************************************************************
. 
. gen prev_shhadid$first_wave = .
(130,851 missing values generated)

. forvalues wave = $second_wave/$final_wave {
  2.     local prev_wave = `wave' - 1
  3.     gen prev_shhadid`wave' = shhadid`prev_wave' if (missing(shhadid`wave') & missing(prev_shhadid`prev_wave'))
  4.     replace prev_shhadid`wave' = prev_shhadid`prev_wave' if (missing(shhadid`wave') & (!missing(prev_shhadid`prev_wave')))
  5. }
(121,076 missing values generated)
(0 real changes made)
(121,734 missing values generated)
(6,452 real changes made)
(120,593 missing values generated)
(11,849 real changes made)
(122,296 missing values generated)
(16,558 real changes made)
(121,736 missing values generated)
(20,424 real changes made)
(121,402 missing values generated)
(24,735 real changes made)
(122,789 missing values generated)
(28,779 real changes made)
(122,485 missing values generated)
(32,288 real changes made)
(121,949 missing values generated)
(36,288 real changes made)
(123,409 missing values generated)
(40,336 real changes made)
(123,479 missing values generated)
(42,570 real changes made)
(122,899 missing values generated)
(44,775 real changes made)
(123,748 missing values generated)
(47,901 real changes made)
(124,971 missing values generated)
(52,497 real changes made)

. 
. ********************************************************************************
. ** Function:  Propagate shhadid_members backward into future_hh_members for missing waves.  
. ********************************************************************************
. 
. gen future_shhadid$final_wave = .
(130,851 missing values generated)

. forvalues wave = $penultimate_wave (-1) $first_wave {
  2.     local next_wave = `wave' + 1
  3.     gen future_shhadid`wave' = shhadid`next_wave' if (missing(shhadid`wave') & missing(future_shhadid`next_wave'))
  4.     replace future_shhadid`wave' = future_shhadid`next_wave' if (missing(shhadid`wave') & (!missing(future_shhadid`next_wave')))
  5. }
(127,415 missing values generated)
(0 real changes made)
(124,864 missing values generated)
(1,076 real changes made)
(124,152 missing values generated)
(4,486 real changes made)
(124,293 missing values generated)
(7,994 real changes made)
(124,629 missing values generated)
(11,047 real changes made)
(124,888 missing values generated)
(12,530 real changes made)
(124,625 missing values generated)
(14,061 real changes made)
(123,786 missing values generated)
(16,111 real changes made)
(124,169 missing values generated)
(17,691 real changes made)
(124,049 missing values generated)
(19,074 real changes made)
(123,038 missing values generated)
(20,783 real changes made)
(124,626 missing values generated)
(22,046 real changes made)
(124,986 missing values generated)
(22,726 real changes made)
(128,235 missing values generated)
(22,572 real changes made)

. 
. ********************************************************************************
. ** Function: walk backward through the waves and for each wave in which ego is missing  compare prev_SHHAIDD to see if we find anyone
. ********************************************************************************
. 
. gen found_prev_shhadid$first_wave = .
(130,851 missing values generated)

. forvalues wave = $final_wave (-1) $second_wave {
  2.         gen found_prev_shhadid`wave'= 0 if (missing(shhadid`wave'))
  3.         gen found_prev_shhadid_in_gap`wave'=0 if (missing(shhadid`wave'))
  4.         replace found_prev_shhadid`wave' = 1 if ((missing(shhadid`wave')) & (strpos(ssuid_shhadid`wave', " " + string(prev_shhadid`wave') + " ") != 0))
  5.         replace found_prev_shhadid_in_gap`wave' = 1 if ((missing(shhadid`wave')) & (strpos(ssuid_shhadid`wave', " " + string(prev_shhadid`wave') + " ") !=0))
  6.         if (`wave' < $final_wave) {
  7.                 local next_wave = `wave' + 1
  8.                 replace found_prev_shhadid_in_gap`wave' = 1 if ((missing(shhadid`wave')) & (found_prev_shhadid_in_gap`next_wave' == 1))
  9.         }
 10. }
(72,474 missing values generated)
(72,474 missing values generated)
(6,815 real changes made)
(6,815 real changes made)
(74,918 missing values generated)
(74,918 missing values generated)
(6,630 real changes made)
(6,630 real changes made)
(249 real changes made)
(76,034 missing values generated)
(76,034 missing values generated)
(6,400 real changes made)
(6,400 real changes made)
(375 real changes made)
(77,287 missing values generated)
(77,287 missing values generated)
(6,097 real changes made)
(6,097 real changes made)
(612 real changes made)
(78,101 missing values generated)
(78,101 missing values generated)
(5,800 real changes made)
(5,800 real changes made)
(684 real changes made)
(79,321 missing values generated)
(79,321 missing values generated)
(5,466 real changes made)
(5,466 real changes made)
(696 real changes made)
(82,260 missing values generated)
(82,260 missing values generated)
(5,097 real changes made)
(5,097 real changes made)
(649 real changes made)
(84,400 missing values generated)
(84,400 missing values generated)
(4,648 real changes made)
(4,648 real changes made)
(645 real changes made)
(85,397 missing values generated)
(85,397 missing values generated)
(4,207 real changes made)
(4,207 real changes made)
(587 real changes made)
(88,164 missing values generated)
(88,164 missing values generated)
(3,720 real changes made)
(3,720 real changes made)
(467 real changes made)
(90,477 missing values generated)
(90,477 missing values generated)
(3,153 real changes made)
(3,153 real changes made)
(412 real changes made)
(91,219 missing values generated)
(91,219 missing values generated)
(2,560 real changes made)
(2,560 real changes made)
(388 real changes made)
(95,252 missing values generated)
(95,252 missing values generated)
(1,876 real changes made)
(1,876 real changes made)
(264 real changes made)
(98,504 missing values generated)
(98,504 missing values generated)
(1,082 real changes made)
(1,082 real changes made)
(152 real changes made)

. 
. ********************************************************************************
. ** Function: walk forward through the waves 
. ********************************************************************************
. 
. gen found_future_shhadid$final_wave = .
(130,851 missing values generated)

. forvalues wave = $first_wave/$penultimate_wave {
  2.         gen found_future_shhadid`wave'= 0 if (missing(shhadid`wave'))
  3.         gen found_future_shhadid_in_gap`wave'=0 if (missing(shhadid`wave'))
  4.         replace found_future_shhadid`wave' = 1 if ((missing(shhadid`wave')) & (strpos(ssuid_shhadid`wave', " " + string(prev_shhadid`wave') + " ") != 0))
  5.         replace found_future_shhadid_in_gap`wave' = 1 if ((missing(shhadid`wave')) & (strpos(ssuid_shhadid`wave', " " + string(prev_shhadid`wave') + " ") !=0))
  6.         if (`wave' > $final_wave) {
  7.                 local prev_wave = `wave' - 1
  8.                 replace found_future_shhadid_in_gap`wave' = 1 if ((missing(shhadid`wave')) & (found_future_shhadid_in_gap`prev_wave' == 1))
  9.         }
 10. }
(105,663 missing values generated)
(105,663 missing values generated)
(0 real changes made)
(0 real changes made)
(98,504 missing values generated)
(98,504 missing values generated)
(1,082 real changes made)
(1,082 real changes made)
(95,252 missing values generated)
(95,252 missing values generated)
(1,876 real changes made)
(1,876 real changes made)
(91,219 missing values generated)
(91,219 missing values generated)
(2,560 real changes made)
(2,560 real changes made)
(90,477 missing values generated)
(90,477 missing values generated)
(3,153 real changes made)
(3,153 real changes made)
(88,164 missing values generated)
(88,164 missing values generated)
(3,720 real changes made)
(3,720 real changes made)
(85,397 missing values generated)
(85,397 missing values generated)
(4,207 real changes made)
(4,207 real changes made)
(84,400 missing values generated)
(84,400 missing values generated)
(4,648 real changes made)
(4,648 real changes made)
(82,260 missing values generated)
(82,260 missing values generated)
(5,097 real changes made)
(5,097 real changes made)
(79,321 missing values generated)
(79,321 missing values generated)
(5,466 real changes made)
(5,466 real changes made)
(78,101 missing values generated)
(78,101 missing values generated)
(5,800 real changes made)
(5,800 real changes made)
(77,287 missing values generated)
(77,287 missing values generated)
(6,097 real changes made)
(6,097 real changes made)
(76,034 missing values generated)
(76,034 missing values generated)
(6,400 real changes made)
(6,400 real changes made)
(74,918 missing values generated)
(74,918 missing values generated)
(6,630 real changes made)
(6,630 real changes made)

. 
. *******************************************************************************
. ** Function: Compute address change.
. *******************************************************************************
. 
. forvalues wave = $first_wave/$penultimate_wave {
  2.     local next_wave = `wave' + 1
  3. 
.     * Start by assuming this wave is not interesting.
.     gen addr_change`wave' = .
  4. 
.     * If we have data in both waves, just compare HH members.
.     replace addr_change`wave' = (shhadid`wave' != shhadid`next_wave') if ((!missing(shhadid`wave')) & (!missing(shhadid`next_wave')))
  5. 
.     * If we are moving from a wave in which ego is missing to one in which ego is present
.     * there is an address change if we have seen the future shhadid in the gap during which ego was missing
.     * UNLESS this is ego's birth.
.     * We also need to populate age and weight from the next wave since ego has no data in this wave.
.     replace addr_change`wave' = 1 if ((missing(shhadid`wave')) & (!missing(shhadid`next_wave')) & (found_future_shhadid_in_gap`wave' == 1))
  6.     replace adj_age`wave' = adj_age`next_wave' if ((missing(shhadid`wave')) & (!missing(shhadid`next_wave')) & (found_future_shhadid_in_gap`wave' == 1))
  7.     replace wpfinwgt`wave' = wpfinwgt`next_wave' if ((missing(shhadid`wave')) & (!missing(shhadid`next_wave')) & (found_future_shhadid_in_gap`wave' == 1))
  8.     * Undo those changes if this is birth.
.     replace addr_change`wave' = . if ((`next_wave' == my_first_wave) & (adj_age`next_wave' == 0))
  9.     replace adj_age`wave' = . if ((`next_wave' == my_first_wave) & (adj_age`next_wave' == 0))
 10.     replace wpfinwgt`wave' = . if ((`next_wave' == my_first_wave) & (adj_age`next_wave' == 0))
 11. 
.     * If we are moving from a wave in which ego is present to one in which ego is missing
.     * there is an address change if we have seen the current shhadid in the gap 
.     * during which ego is missing as we look forward.
.     replace addr_change`wave' = 1 if ((!missing(shhadid`wave')) & (missing(shhadid`next_wave')) & (found_prev_shhadid_in_gap`next_wave' == 1))
 12. 
.     * If we are moving from a wave in which ego is present to one in which ego is missing
.     * and we do not see the current shhadid in the gap looking forward,
.     * we compare the current shhadid to the future shhadid as if we move into the
.     * future household in the first missing wave, unless there is no future shhadid
.     * (ego's last appearance).
.     replace addr_change`wave' = (shhadid`wave' != future_shhadid`next_wave') if ((!missing(shhadid`wave')) & (missing(shhadid`next_wave')) & (!missing(future_shhadid`next_wave')) & (found_prev_shha
> did_in_gap`next_wave' != 1))
 13. 
. 
.     * Tab "original" addr_change and comp_change variables.
.     tab addr_change`wave' comp_change`wave', m
 14. 
.     * We once forced them up to have the same denominator by setting to zero if missing and the other variable is not missing.
.         * but this is not appropriate. Sometimes we can know if there was an address change even if we don't know household composition
.         * Keeping this here to document.
. *    replace addr_change`wave' = 0 if (missing(addr_change`wave') & (!missing(comp_change`wave')))
. *    replace comp_change`wave' = 0 if (missing(comp_change`wave') & (!missing(addr_change`wave')))
. 
. *    tab addr_change`wave' comp_change`wave', m
. }
(130,851 missing values generated)
(95,888 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1,234 real changes made)
(5,690 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e1 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    90,236      6,890          0 |    97,126 
         1 |     2,776      2,910          0 |     5,686 
         . |         0      2,422     25,617 |    28,039 
-----------+---------------------------------+----------
     Total |    93,012     12,222     25,617 |   130,851 
(130,851 missing values generated)
(89,387 real changes made)
(109 real changes made)
(32 real changes made)
(65 real changes made)
(0 real changes made)
(406 real changes made, 406 to missing)
(0 real changes made)
(1,166 real changes made)
(5,223 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e2 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    83,757      5,964          0 |    89,721 
         1 |     2,870      3,229         65 |     6,164 
         . |         0      2,532     32,434 |    34,966 
-----------+---------------------------------+----------
     Total |    86,627     11,725     32,499 |   130,851 
(130,851 missing values generated)
(84,994 real changes made)
(172 real changes made)
(100 real changes made)
(102 real changes made)
(0 real changes made)
(406 real changes made, 406 to missing)
(0 real changes made)
(1,210 real changes made)
(6,203 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e3 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    79,784      6,051          0 |    85,835 
         1 |     3,196      3,444        104 |     6,744 
         . |         0      2,604     35,668 |    38,272 
-----------+---------------------------------+----------
     Total |    82,980     12,099     35,772 |   130,851 
(130,851 missing values generated)
(82,664 real changes made)
(212 real changes made)
(45 real changes made)
(138 real changes made)
(0 real changes made)
(415 real changes made, 415 to missing)
(0 real changes made)
(1,099 real changes made)
(4,848 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e4 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    77,925      5,523          0 |    83,448 
         1 |     2,439      2,798        138 |     5,375 
         . |         0      2,375     39,653 |    42,028 
-----------+---------------------------------+----------
     Total |    80,364     10,696     39,791 |   130,851 
(130,851 missing values generated)
(81,362 real changes made)
(162 real changes made)
(55 real changes made)
(86 real changes made)
(0 real changes made)
(357 real changes made, 357 to missing)
(0 real changes made)
(1,091 real changes made)
(5,084 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e5 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    76,851      5,246          0 |    82,097 
         1 |     2,750      2,765         87 |     5,602 
         . |         0      2,321     40,831 |    43,152 
-----------+---------------------------------+----------
     Total |    79,601     10,332     40,918 |   130,851 
(130,851 missing values generated)
(78,715 real changes made)
(184 real changes made)
(87 real changes made)
(87 real changes made)
(0 real changes made)
(330 real changes made, 330 to missing)
(0 real changes made)
(1,155 real changes made)
(5,218 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e6 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    74,707      4,978          0 |    79,685 
         1 |     2,621      2,878         88 |     5,587 
         . |         0      2,092     43,487 |    45,579 
-----------+---------------------------------+----------
     Total |    77,328      9,948     43,575 |   130,851 
(130,851 missing values generated)
(77,335 real changes made)
(217 real changes made)
(39 real changes made)
(103 real changes made)
(0 real changes made)
(298 real changes made, 298 to missing)
(0 real changes made)
(1,047 real changes made)
(4,011 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e7 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    73,515      4,591          0 |    78,106 
         1 |     2,008      2,392        104 |     4,504 
         . |         0      1,871     46,370 |    48,241 
-----------+---------------------------------+----------
     Total |    75,523      8,854     46,474 |   130,851 
(130,851 missing values generated)
(76,034 real changes made)
(144 real changes made)
(43 real changes made)
(58 real changes made)
(0 real changes made)
(314 real changes made, 314 to missing)
(0 real changes made)
(1,001 real changes made)
(4,261 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e8 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    72,325      4,531          0 |    76,856 
         1 |     2,212      2,314         58 |     4,584 
         . |         0      1,940     47,471 |    49,411 
-----------+---------------------------------+----------
     Total |    74,537      8,785     47,529 |   130,851 
(130,851 missing values generated)
(73,358 real changes made)
(166 real changes made)
(69 real changes made)
(72 real changes made)
(0 real changes made)
(309 real changes made, 309 to missing)
(0 real changes made)
(1,031 real changes made)
(4,588 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e9 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    69,661      4,525          0 |    74,186 
         1 |     2,401      2,483         73 |     4,957 
         . |         0      1,845     49,863 |    51,708 
-----------+---------------------------------+----------
     Total |    72,062      8,853     49,936 |   130,851 
(130,851 missing values generated)
(71,879 real changes made)
(159 real changes made)
(19 real changes made)
(59 real changes made)
(0 real changes made)
(298 real changes made, 298 to missing)
(0 real changes made)
(911 real changes made)
(3,367 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
       e10 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    68,589      3,931          0 |    72,520 
         1 |     1,711      2,026         59 |     3,796 
         . |         0      1,556     52,979 |    54,535 
-----------+---------------------------------+----------
     Total |    70,300      7,513     53,038 |   130,851 
(130,851 missing values generated)
(70,729 real changes made)
(187 real changes made)
(41 real changes made)
(72 real changes made)
(0 real changes made)
(298 real changes made, 298 to missing)
(0 real changes made)
(882 real changes made)
(3,086 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
       e11 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    67,100      3,842          0 |    70,942 
         1 |     1,930      1,939         73 |     3,942 
         . |         0      1,464     54,503 |    55,967 
-----------+---------------------------------+----------
     Total |    69,030      7,245     54,576 |   130,851 
(130,851 missing values generated)
(69,335 real changes made)
(192 real changes made)
(84 real changes made)
(85 real changes made)
(0 real changes made)
(314 real changes made, 314 to missing)
(0 real changes made)
(797 real changes made)
(2,504 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
       e12 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    65,060      3,734          0 |    68,794 
         1 |     2,087      1,862         85 |     4,034 
         . |         0      1,682     56,341 |    58,023 
-----------+---------------------------------+----------
     Total |    67,147      7,278     56,426 |   130,851 
(130,851 missing values generated)
(68,931 real changes made)
(176 real changes made)
(28 real changes made)
(76 real changes made)
(0 real changes made)
(273 real changes made, 273 to missing)
(0 real changes made)
(770 real changes made)
(2,309 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
       e13 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    65,580      3,499          0 |    69,079 
         1 |     1,416      1,615         76 |     3,107 
         . |         0      1,309     57,356 |    58,665 
-----------+---------------------------------+----------
     Total |    66,996      6,423     57,432 |   130,851 
(130,851 missing values generated)
(69,038 real changes made)
(113 real changes made)
(13 real changes made)
(19 real changes made)
(0 real changes made)
(262 real changes made, 262 to missing)
(0 real changes made)
(701 real changes made)
(0 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
       e14 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    63,914      2,993          0 |    66,907 
         1 |     1,467      1,459         19 |     2,945 
         . |         0        996     60,003 |    60,999 
-----------+---------------------------------+----------
     Total |    65,381      5,448     60,022 |   130,851 

. 
. gen original=1 if !missing(shhadid1)
(25,188 missing values generated)

. gen agewave1=adj_age1 if original==1
(25,188 missing values generated)

. 
. keep ssuid epppnum swave shhadid* adj_age* comp_change* addr_change* comp_change_reason* original agewave1
variable swave not found
r(111);

end of do-file

r(111);

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. //==============================================================================
. //===== Children's Household Instability Project                                                    
. //===== Dataset: SIPP2008                                                                               
. //===== Purpose: Create a database with comp_change, addr_change, and sociodemographic characteristics
. //===== One record per person per wave.
. //===== create_comp_change generates the variable comp_change. This file adds addr_change
. //===== and reshapes the data to long form.
. //===== Note: this code depends on macros set in project_macros and create_comp_change
. //==============================================================================
. 
. use "$SIPP08keep/comp_change.dta", clear

. 
. #delimit ; 
delimiter now ;
. label define addr_change          0 "No move"
>                                   1 "Move";

.          #delimit cr
delimiter now cr
. 
. ********************************************************************************
. * Function Propagate shhadid_members forard into prev_shhadid for missing waves.
. ********************************************************************************
. 
. gen prev_shhadid$first_wave = .
(130,851 missing values generated)

. forvalues wave = $second_wave/$final_wave {
  2.     local prev_wave = `wave' - 1
  3.     gen prev_shhadid`wave' = shhadid`prev_wave' if (missing(shhadid`wave') & missing(prev_shhadid`prev_wave'))
  4.     replace prev_shhadid`wave' = prev_shhadid`prev_wave' if (missing(shhadid`wave') & (!missing(prev_shhadid`prev_wave')))
  5. }
(121,076 missing values generated)
(0 real changes made)
(121,734 missing values generated)
(6,452 real changes made)
(120,593 missing values generated)
(11,849 real changes made)
(122,296 missing values generated)
(16,558 real changes made)
(121,736 missing values generated)
(20,424 real changes made)
(121,402 missing values generated)
(24,735 real changes made)
(122,789 missing values generated)
(28,779 real changes made)
(122,485 missing values generated)
(32,288 real changes made)
(121,949 missing values generated)
(36,288 real changes made)
(123,409 missing values generated)
(40,336 real changes made)
(123,479 missing values generated)
(42,570 real changes made)
(122,899 missing values generated)
(44,775 real changes made)
(123,748 missing values generated)
(47,901 real changes made)
(124,971 missing values generated)
(52,497 real changes made)

. 
. ********************************************************************************
. ** Function:  Propagate shhadid_members backward into future_hh_members for missing waves.  
. ********************************************************************************
. 
. gen future_shhadid$final_wave = .
(130,851 missing values generated)

. forvalues wave = $penultimate_wave (-1) $first_wave {
  2.     local next_wave = `wave' + 1
  3.     gen future_shhadid`wave' = shhadid`next_wave' if (missing(shhadid`wave') & missing(future_shhadid`next_wave'))
  4.     replace future_shhadid`wave' = future_shhadid`next_wave' if (missing(shhadid`wave') & (!missing(future_shhadid`next_wave')))
  5. }
(127,415 missing values generated)
(0 real changes made)
(124,864 missing values generated)
(1,076 real changes made)
(124,152 missing values generated)
(4,486 real changes made)
(124,293 missing values generated)
(7,994 real changes made)
(124,629 missing values generated)
(11,047 real changes made)
(124,888 missing values generated)
(12,530 real changes made)
(124,625 missing values generated)
(14,061 real changes made)
(123,786 missing values generated)
(16,111 real changes made)
(124,169 missing values generated)
(17,691 real changes made)
(124,049 missing values generated)
(19,074 real changes made)
(123,038 missing values generated)
(20,783 real changes made)
(124,626 missing values generated)
(22,046 real changes made)
(124,986 missing values generated)
(22,726 real changes made)
(128,235 missing values generated)
(22,572 real changes made)

. 
. ********************************************************************************
. ** Function: walk backward through the waves and for each wave in which ego is missing  compare prev_SHHAIDD to see if we find anyone
. ********************************************************************************
. 
. gen found_prev_shhadid$first_wave = .
(130,851 missing values generated)

. forvalues wave = $final_wave (-1) $second_wave {
  2.         gen found_prev_shhadid`wave'= 0 if (missing(shhadid`wave'))
  3.         gen found_prev_shhadid_in_gap`wave'=0 if (missing(shhadid`wave'))
  4.         replace found_prev_shhadid`wave' = 1 if ((missing(shhadid`wave')) & (strpos(ssuid_shhadid`wave', " " + string(prev_shhadid`wave') + " ") != 0))
  5.         replace found_prev_shhadid_in_gap`wave' = 1 if ((missing(shhadid`wave')) & (strpos(ssuid_shhadid`wave', " " + string(prev_shhadid`wave') + " ") !=0))
  6.         if (`wave' < $final_wave) {
  7.                 local next_wave = `wave' + 1
  8.                 replace found_prev_shhadid_in_gap`wave' = 1 if ((missing(shhadid`wave')) & (found_prev_shhadid_in_gap`next_wave' == 1))
  9.         }
 10. }
(72,474 missing values generated)
(72,474 missing values generated)
(6,815 real changes made)
(6,815 real changes made)
(74,918 missing values generated)
(74,918 missing values generated)
(6,630 real changes made)
(6,630 real changes made)
(249 real changes made)
(76,034 missing values generated)
(76,034 missing values generated)
(6,400 real changes made)
(6,400 real changes made)
(375 real changes made)
(77,287 missing values generated)
(77,287 missing values generated)
(6,097 real changes made)
(6,097 real changes made)
(612 real changes made)
(78,101 missing values generated)
(78,101 missing values generated)
(5,800 real changes made)
(5,800 real changes made)
(684 real changes made)
(79,321 missing values generated)
(79,321 missing values generated)
(5,466 real changes made)
(5,466 real changes made)
(696 real changes made)
(82,260 missing values generated)
(82,260 missing values generated)
(5,097 real changes made)
(5,097 real changes made)
(649 real changes made)
(84,400 missing values generated)
(84,400 missing values generated)
(4,648 real changes made)
(4,648 real changes made)
(645 real changes made)
(85,397 missing values generated)
(85,397 missing values generated)
(4,207 real changes made)
(4,207 real changes made)
(587 real changes made)
(88,164 missing values generated)
(88,164 missing values generated)
(3,720 real changes made)
(3,720 real changes made)
(467 real changes made)
(90,477 missing values generated)
(90,477 missing values generated)
(3,153 real changes made)
(3,153 real changes made)
(412 real changes made)
(91,219 missing values generated)
(91,219 missing values generated)
(2,560 real changes made)
(2,560 real changes made)
(388 real changes made)
(95,252 missing values generated)
(95,252 missing values generated)
(1,876 real changes made)
(1,876 real changes made)
(264 real changes made)
(98,504 missing values generated)
(98,504 missing values generated)
(1,082 real changes made)
(1,082 real changes made)
(152 real changes made)

. 
. ********************************************************************************
. ** Function: walk forward through the waves 
. ********************************************************************************
. 
. gen found_future_shhadid$final_wave = .
(130,851 missing values generated)

. forvalues wave = $first_wave/$penultimate_wave {
  2.         gen found_future_shhadid`wave'= 0 if (missing(shhadid`wave'))
  3.         gen found_future_shhadid_in_gap`wave'=0 if (missing(shhadid`wave'))
  4.         replace found_future_shhadid`wave' = 1 if ((missing(shhadid`wave')) & (strpos(ssuid_shhadid`wave', " " + string(prev_shhadid`wave') + " ") != 0))
  5.         replace found_future_shhadid_in_gap`wave' = 1 if ((missing(shhadid`wave')) & (strpos(ssuid_shhadid`wave', " " + string(prev_shhadid`wave') + " ") !=0))
  6.         if (`wave' > $final_wave) {
  7.                 local prev_wave = `wave' - 1
  8.                 replace found_future_shhadid_in_gap`wave' = 1 if ((missing(shhadid`wave')) & (found_future_shhadid_in_gap`prev_wave' == 1))
  9.         }
 10. }
(105,663 missing values generated)
(105,663 missing values generated)
(0 real changes made)
(0 real changes made)
(98,504 missing values generated)
(98,504 missing values generated)
(1,082 real changes made)
(1,082 real changes made)
(95,252 missing values generated)
(95,252 missing values generated)
(1,876 real changes made)
(1,876 real changes made)
(91,219 missing values generated)
(91,219 missing values generated)
(2,560 real changes made)
(2,560 real changes made)
(90,477 missing values generated)
(90,477 missing values generated)
(3,153 real changes made)
(3,153 real changes made)
(88,164 missing values generated)
(88,164 missing values generated)
(3,720 real changes made)
(3,720 real changes made)
(85,397 missing values generated)
(85,397 missing values generated)
(4,207 real changes made)
(4,207 real changes made)
(84,400 missing values generated)
(84,400 missing values generated)
(4,648 real changes made)
(4,648 real changes made)
(82,260 missing values generated)
(82,260 missing values generated)
(5,097 real changes made)
(5,097 real changes made)
(79,321 missing values generated)
(79,321 missing values generated)
(5,466 real changes made)
(5,466 real changes made)
(78,101 missing values generated)
(78,101 missing values generated)
(5,800 real changes made)
(5,800 real changes made)
(77,287 missing values generated)
(77,287 missing values generated)
(6,097 real changes made)
(6,097 real changes made)
(76,034 missing values generated)
(76,034 missing values generated)
(6,400 real changes made)
(6,400 real changes made)
(74,918 missing values generated)
(74,918 missing values generated)
(6,630 real changes made)
(6,630 real changes made)

. 
. *******************************************************************************
. ** Function: Compute address change.
. *******************************************************************************
. 
. forvalues wave = $first_wave/$penultimate_wave {
  2.     local next_wave = `wave' + 1
  3. 
.     * Start by assuming this wave is not interesting.
.     gen addr_change`wave' = .
  4. 
.     * If we have data in both waves, just compare HH members.
.     replace addr_change`wave' = (shhadid`wave' != shhadid`next_wave') if ((!missing(shhadid`wave')) & (!missing(shhadid`next_wave')))
  5. 
.     * If we are moving from a wave in which ego is missing to one in which ego is present
.     * there is an address change if we have seen the future shhadid in the gap during which ego was missing
.     * UNLESS this is ego's birth.
.     * We also need to populate age and weight from the next wave since ego has no data in this wave.
.     replace addr_change`wave' = 1 if ((missing(shhadid`wave')) & (!missing(shhadid`next_wave')) & (found_future_shhadid_in_gap`wave' == 1))
  6.     replace adj_age`wave' = adj_age`next_wave' if ((missing(shhadid`wave')) & (!missing(shhadid`next_wave')) & (found_future_shhadid_in_gap`wave' == 1))
  7.     replace wpfinwgt`wave' = wpfinwgt`next_wave' if ((missing(shhadid`wave')) & (!missing(shhadid`next_wave')) & (found_future_shhadid_in_gap`wave' == 1))
  8.     * Undo those changes if this is birth.
.     replace addr_change`wave' = . if ((`next_wave' == my_first_wave) & (adj_age`next_wave' == 0))
  9.     replace adj_age`wave' = . if ((`next_wave' == my_first_wave) & (adj_age`next_wave' == 0))
 10.     replace wpfinwgt`wave' = . if ((`next_wave' == my_first_wave) & (adj_age`next_wave' == 0))
 11. 
.     * If we are moving from a wave in which ego is present to one in which ego is missing
.     * there is an address change if we have seen the current shhadid in the gap 
.     * during which ego is missing as we look forward.
.     replace addr_change`wave' = 1 if ((!missing(shhadid`wave')) & (missing(shhadid`next_wave')) & (found_prev_shhadid_in_gap`next_wave' == 1))
 12. 
.     * If we are moving from a wave in which ego is present to one in which ego is missing
.     * and we do not see the current shhadid in the gap looking forward,
.     * we compare the current shhadid to the future shhadid as if we move into the
.     * future household in the first missing wave, unless there is no future shhadid
.     * (ego's last appearance).
.     replace addr_change`wave' = (shhadid`wave' != future_shhadid`next_wave') if ((!missing(shhadid`wave')) & (missing(shhadid`next_wave')) & (!missing(future_shhadid`next_wave')) & (found_prev_shha
> did_in_gap`next_wave' != 1))
 13. 
. 
.     * Tab "original" addr_change and comp_change variables.
.     tab addr_change`wave' comp_change`wave', m
 14. 
.     * We once forced them up to have the same denominator by setting to zero if missing and the other variable is not missing.
.         * but this is not appropriate. Sometimes we can know if there was an address change even if we don't know household composition
.         * Keeping this here to document.
. *    replace addr_change`wave' = 0 if (missing(addr_change`wave') & (!missing(comp_change`wave')))
. *    replace comp_change`wave' = 0 if (missing(comp_change`wave') & (!missing(addr_change`wave')))
. 
. *    tab addr_change`wave' comp_change`wave', m
. }
(130,851 missing values generated)
(95,888 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1,234 real changes made)
(5,690 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e1 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    90,236      6,890          0 |    97,126 
         1 |     2,776      2,910          0 |     5,686 
         . |         0      2,422     25,617 |    28,039 
-----------+---------------------------------+----------
     Total |    93,012     12,222     25,617 |   130,851 
(130,851 missing values generated)
(89,387 real changes made)
(109 real changes made)
(32 real changes made)
(65 real changes made)
(0 real changes made)
(406 real changes made, 406 to missing)
(0 real changes made)
(1,166 real changes made)
(5,223 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e2 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    83,757      5,964          0 |    89,721 
         1 |     2,870      3,229         65 |     6,164 
         . |         0      2,532     32,434 |    34,966 
-----------+---------------------------------+----------
     Total |    86,627     11,725     32,499 |   130,851 
(130,851 missing values generated)
(84,994 real changes made)
(172 real changes made)
(100 real changes made)
(102 real changes made)
(0 real changes made)
(406 real changes made, 406 to missing)
(0 real changes made)
(1,210 real changes made)
(6,203 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e3 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    79,784      6,051          0 |    85,835 
         1 |     3,196      3,444        104 |     6,744 
         . |         0      2,604     35,668 |    38,272 
-----------+---------------------------------+----------
     Total |    82,980     12,099     35,772 |   130,851 
(130,851 missing values generated)
(82,664 real changes made)
(212 real changes made)
(45 real changes made)
(138 real changes made)
(0 real changes made)
(415 real changes made, 415 to missing)
(0 real changes made)
(1,099 real changes made)
(4,848 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e4 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    77,925      5,523          0 |    83,448 
         1 |     2,439      2,798        138 |     5,375 
         . |         0      2,375     39,653 |    42,028 
-----------+---------------------------------+----------
     Total |    80,364     10,696     39,791 |   130,851 
(130,851 missing values generated)
(81,362 real changes made)
(162 real changes made)
(55 real changes made)
(86 real changes made)
(0 real changes made)
(357 real changes made, 357 to missing)
(0 real changes made)
(1,091 real changes made)
(5,084 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e5 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    76,851      5,246          0 |    82,097 
         1 |     2,750      2,765         87 |     5,602 
         . |         0      2,321     40,831 |    43,152 
-----------+---------------------------------+----------
     Total |    79,601     10,332     40,918 |   130,851 
(130,851 missing values generated)
(78,715 real changes made)
(184 real changes made)
(87 real changes made)
(87 real changes made)
(0 real changes made)
(330 real changes made, 330 to missing)
(0 real changes made)
(1,155 real changes made)
(5,218 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e6 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    74,707      4,978          0 |    79,685 
         1 |     2,621      2,878         88 |     5,587 
         . |         0      2,092     43,487 |    45,579 
-----------+---------------------------------+----------
     Total |    77,328      9,948     43,575 |   130,851 
(130,851 missing values generated)
(77,335 real changes made)
(217 real changes made)
(39 real changes made)
(103 real changes made)
(0 real changes made)
(298 real changes made, 298 to missing)
(0 real changes made)
(1,047 real changes made)
(4,011 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e7 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    73,515      4,591          0 |    78,106 
         1 |     2,008      2,392        104 |     4,504 
         . |         0      1,871     46,370 |    48,241 
-----------+---------------------------------+----------
     Total |    75,523      8,854     46,474 |   130,851 
(130,851 missing values generated)
(76,034 real changes made)
(144 real changes made)
(43 real changes made)
(58 real changes made)
(0 real changes made)
(314 real changes made, 314 to missing)
(0 real changes made)
(1,001 real changes made)
(4,261 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e8 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    72,325      4,531          0 |    76,856 
         1 |     2,212      2,314         58 |     4,584 
         . |         0      1,940     47,471 |    49,411 
-----------+---------------------------------+----------
     Total |    74,537      8,785     47,529 |   130,851 
(130,851 missing values generated)
(73,358 real changes made)
(166 real changes made)
(69 real changes made)
(72 real changes made)
(0 real changes made)
(309 real changes made, 309 to missing)
(0 real changes made)
(1,031 real changes made)
(4,588 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e9 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    69,661      4,525          0 |    74,186 
         1 |     2,401      2,483         73 |     4,957 
         . |         0      1,845     49,863 |    51,708 
-----------+---------------------------------+----------
     Total |    72,062      8,853     49,936 |   130,851 
(130,851 missing values generated)
(71,879 real changes made)
(159 real changes made)
(19 real changes made)
(59 real changes made)
(0 real changes made)
(298 real changes made, 298 to missing)
(0 real changes made)
(911 real changes made)
(3,367 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
       e10 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    68,589      3,931          0 |    72,520 
         1 |     1,711      2,026         59 |     3,796 
         . |         0      1,556     52,979 |    54,535 
-----------+---------------------------------+----------
     Total |    70,300      7,513     53,038 |   130,851 
(130,851 missing values generated)
(70,729 real changes made)
(187 real changes made)
(41 real changes made)
(72 real changes made)
(0 real changes made)
(298 real changes made, 298 to missing)
(0 real changes made)
(882 real changes made)
(3,086 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
       e11 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    67,100      3,842          0 |    70,942 
         1 |     1,930      1,939         73 |     3,942 
         . |         0      1,464     54,503 |    55,967 
-----------+---------------------------------+----------
     Total |    69,030      7,245     54,576 |   130,851 
(130,851 missing values generated)
(69,335 real changes made)
(192 real changes made)
(84 real changes made)
(85 real changes made)
(0 real changes made)
(314 real changes made, 314 to missing)
(0 real changes made)
(797 real changes made)
(2,504 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
       e12 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    65,060      3,734          0 |    68,794 
         1 |     2,087      1,862         85 |     4,034 
         . |         0      1,682     56,341 |    58,023 
-----------+---------------------------------+----------
     Total |    67,147      7,278     56,426 |   130,851 
(130,851 missing values generated)
(68,931 real changes made)
(176 real changes made)
(28 real changes made)
(76 real changes made)
(0 real changes made)
(273 real changes made, 273 to missing)
(0 real changes made)
(770 real changes made)
(2,309 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
       e13 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    65,580      3,499          0 |    69,079 
         1 |     1,416      1,615         76 |     3,107 
         . |         0      1,309     57,356 |    58,665 
-----------+---------------------------------+----------
     Total |    66,996      6,423     57,432 |   130,851 
(130,851 missing values generated)
(69,038 real changes made)
(113 real changes made)
(13 real changes made)
(19 real changes made)
(0 real changes made)
(262 real changes made, 262 to missing)
(0 real changes made)
(701 real changes made)
(0 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
       e14 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    63,914      2,993          0 |    66,907 
         1 |     1,467      1,459         19 |     2,945 
         . |         0        996     60,003 |    60,999 
-----------+---------------------------------+----------
     Total |    65,381      5,448     60,022 |   130,851 

. 
. gen original=1 if !missing(shhadid1)
(25,188 missing values generated)

. gen agewave1=adj_age1 if original==1
(25,188 missing values generated)

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. keep ssuid epppnum shhadid* adj_age* comp_change* addr_change* comp_change_reason* original agewave1

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. reshape long shhadid adj_age comp_change addr_change comp_change_reason, i(ssuid epppnum) j(swave)
(note: j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15)
(note: comp_change15 not found)
(note: addr_change15 not found)
(note: comp_change_reason15 not found)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                   130851   -> 2.0e+06
Number of variables                  91   ->      25
j variable (15 values)                    ->   swave
xij variables:
        shhadid1 shhadid2 ... shhadid15   ->   shhadid
        adj_age1 adj_age2 ... adj_age15   ->   adj_age
comp_change1 comp_change2 ... comp_change15->  comp_change
addr_change1 addr_change2 ... addr_change15->  addr_change
comp_change_reason1 comp_change_reason2 ... comp_change_reason15->comp_change_reason
-----------------------------------------------------------------------------

. 
end of do-file

. tab agewave1

   agewave1 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |     20,595        1.30        1.30
          1 |     21,720        1.37        2.67
          2 |     23,325        1.47        4.14
          3 |     21,900        1.38        5.52
          4 |     22,320        1.41        6.93
          5 |     22,620        1.43        8.36
          6 |     21,705        1.37        9.73
          7 |     22,470        1.42       11.15
          8 |     23,055        1.45       12.60
          9 |     22,620        1.43       14.03
         10 |     22,380        1.41       15.44
         11 |     21,450        1.35       16.79
         12 |     23,370        1.47       18.27
         13 |     22,620        1.43       19.69
         14 |     23,145        1.46       21.15
         15 |     23,325        1.47       22.63
         16 |     23,865        1.51       24.13
         17 |     24,300        1.53       25.67
         18 |     21,900        1.38       27.05
         19 |     21,495        1.36       28.40
         20 |     19,890        1.25       29.66
         21 |     18,615        1.17       30.83
         22 |     19,200        1.21       32.04
         23 |     19,155        1.21       33.25
         24 |     19,800        1.25       34.50
         25 |     19,845        1.25       35.75
         26 |     20,025        1.26       37.02
         27 |     20,370        1.29       38.30
         28 |     20,730        1.31       39.61
         29 |     20,070        1.27       40.88
         30 |     20,220        1.28       42.15
         31 |     19,785        1.25       43.40
         32 |     18,885        1.19       44.59
         33 |     20,655        1.30       45.90
         34 |     18,645        1.18       47.07
         35 |     20,400        1.29       48.36
         36 |     20,445        1.29       49.65
         37 |     20,970        1.32       50.97
         38 |     21,480        1.36       52.33
         39 |     22,200        1.40       53.73
         40 |     22,950        1.45       55.18
         41 |     20,460        1.29       56.47
         42 |     21,510        1.36       57.82
         43 |     22,335        1.41       59.23
         44 |     22,920        1.45       60.68
         45 |     24,390        1.54       62.22
         46 |     23,085        1.46       63.68
         47 |     23,400        1.48       65.15
         48 |     23,190        1.46       66.61
         49 |     22,680        1.43       68.05
         50 |     25,365        1.60       69.65
         51 |     23,190        1.46       71.11
         52 |     23,070        1.46       72.56
         53 |     22,245        1.40       73.97
         54 |     21,510        1.36       75.33
         55 |     21,345        1.35       76.67
         56 |     20,400        1.29       77.96
         57 |     19,815        1.25       79.21
         58 |     19,080        1.20       80.41
         59 |     19,170        1.21       81.62
         60 |     19,665        1.24       82.86
         61 |     19,620        1.24       84.10
         62 |     16,485        1.04       85.14
         63 |     14,850        0.94       86.08
         64 |     14,595        0.92       87.00
         65 |     15,810        1.00       88.00
         66 |     13,725        0.87       88.86
         67 |     12,315        0.78       89.64
         68 |     12,390        0.78       90.42
         69 |     11,220        0.71       91.13
         70 |     11,175        0.71       91.83
         71 |      9,240        0.58       92.42
         72 |      9,450        0.60       93.01
         73 |      8,505        0.54       93.55
         74 |      8,505        0.54       94.09
         75 |      8,250        0.52       94.61
         76 |      7,770        0.49       95.10
         77 |      8,265        0.52       95.62
         78 |      7,935        0.50       96.12
         79 |      7,815        0.49       96.61
         80 |      7,290        0.46       97.07
         81 |      6,045        0.38       97.45
         82 |      6,180        0.39       97.84
         83 |     25,170        1.59       99.43
         84 |      9,000        0.57      100.00
------------+-----------------------------------
      Total |  1,584,945      100.00

. tab agewave1

   agewave1 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |     20,595        1.30        1.30
          1 |     21,720        1.37        2.67
          2 |     23,325        1.47        4.14
          3 |     21,900        1.38        5.52
          4 |     22,320        1.41        6.93
          5 |     22,620        1.43        8.36
          6 |     21,705        1.37        9.73
          7 |     22,470        1.42       11.15
          8 |     23,055        1.45       12.60
          9 |     22,620        1.43       14.03
         10 |     22,380        1.41       15.44
         11 |     21,450        1.35       16.79
         12 |     23,370        1.47       18.27
         13 |     22,620        1.43       19.69
         14 |     23,145        1.46       21.15
         15 |     23,325        1.47       22.63
         16 |     23,865        1.51       24.13
         17 |     24,300        1.53       25.67
         18 |     21,900        1.38       27.05
         19 |     21,495        1.36       28.40
         20 |     19,890        1.25       29.66
         21 |     18,615        1.17       30.83
         22 |     19,200        1.21       32.04
         23 |     19,155        1.21       33.25
         24 |     19,800        1.25       34.50
         25 |     19,845        1.25       35.75
         26 |     20,025        1.26       37.02
         27 |     20,370        1.29       38.30
         28 |     20,730        1.31       39.61
         29 |     20,070        1.27       40.88
         30 |     20,220        1.28       42.15
         31 |     19,785        1.25       43.40
         32 |     18,885        1.19       44.59
         33 |     20,655        1.30       45.90
         34 |     18,645        1.18       47.07
         35 |     20,400        1.29       48.36
         36 |     20,445        1.29       49.65
         37 |     20,970        1.32       50.97
         38 |     21,480        1.36       52.33
         39 |     22,200        1.40       53.73
         40 |     22,950        1.45       55.18
         41 |     20,460        1.29       56.47
         42 |     21,510        1.36       57.82
         43 |     22,335        1.41       59.23
         44 |     22,920        1.45       60.68
         45 |     24,390        1.54       62.22
         46 |     23,085        1.46       63.68
         47 |     23,400        1.48       65.15
         48 |     23,190        1.46       66.61
         49 |     22,680        1.43       68.05
         50 |     25,365        1.60       69.65
         51 |     23,190        1.46       71.11
         52 |     23,070        1.46       72.56
         53 |     22,245        1.40       73.97
         54 |     21,510        1.36       75.33
         55 |     21,345        1.35       76.67
         56 |     20,400        1.29       77.96
         57 |     19,815        1.25       79.21
         58 |     19,080        1.20       80.41
         59 |     19,170        1.21       81.62
         60 |     19,665        1.24       82.86
         61 |     19,620        1.24       84.10
         62 |     16,485        1.04       85.14
         63 |     14,850        0.94       86.08
         64 |     14,595        0.92       87.00
         65 |     15,810        1.00       88.00
         66 |     13,725        0.87       88.86
         67 |     12,315        0.78       89.64
         68 |     12,390        0.78       90.42
         69 |     11,220        0.71       91.13
         70 |     11,175        0.71       91.83
         71 |      9,240        0.58       92.42
         72 |      9,450        0.60       93.01
         73 |      8,505        0.54       93.55
         74 |      8,505        0.54       94.09
         75 |      8,250        0.52       94.61
         76 |      7,770        0.49       95.10
         77 |      8,265        0.52       95.62
         78 |      7,935        0.50       96.12
         79 |      7,815        0.49       96.61
         80 |      7,290        0.46       97.07
         81 |      6,045        0.38       97.45
         82 |      6,180        0.39       97.84
         83 |     25,170        1.59       99.43
         84 |      9,000        0.57      100.00
------------+-----------------------------------
      Total |  1,584,945      100.00

. tab swave

SU: Wave of |
       data |
 collection |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    130,851        6.67        6.67
          2 |    130,851        6.67       13.33
          3 |    130,851        6.67       20.00
          4 |    130,851        6.67       26.67
          5 |    130,851        6.67       33.33
          6 |    130,851        6.67       40.00
          7 |    130,851        6.67       46.67
          8 |    130,851        6.67       53.33
          9 |    130,851        6.67       60.00
         10 |    130,851        6.67       66.67
         11 |    130,851        6.67       73.33
         12 |    130,851        6.67       80.00
         13 |    130,851        6.67       86.67
         14 |    130,851        6.67       93.33
         15 |    130,851        6.67      100.00
------------+-----------------------------------
      Total |  1,962,765      100.00

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. merge 1:1 ssuid epppnum swave using "$tempdir/demo_long_all.dta"
variable swave not found
r(111);

end of do-file

r(111);

. clear

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. //========================================================================================================================//
. //=================== Children's Household Instability Project                    ========================================//
. //=================== Dataset: SIPP2008                                           ========================================//
. //=================== Purpose: This file fixes up age so the waves are consistent ========================================//
. //========================================================================================================================//
. use "$tempdir/person_wide"

. 
. gen num_ages = 0

. forvalues wave = $first_wave/$final_wave {
  2.     replace num_ages = num_ages + 1 if (!missing(tage`wave'))
  3. }
(105,663 real changes made)
(98,504 real changes made)
(95,252 real changes made)
(91,219 real changes made)
(90,477 real changes made)
(88,164 real changes made)
(85,397 real changes made)
(84,400 real changes made)
(82,260 real changes made)
(79,321 real changes made)
(78,101 real changes made)
(77,287 real changes made)
(76,034 real changes made)
(74,918 real changes made)
(72,474 real changes made)

. 
. ******************************************************************************
. *Section: create expected age variables based on age at first observation and 
. *          aging the person one year every 3 observations or based on last observation
. *          and decrementing one year every 3 observations 
. ******************************************************************************
. 
. *** We make a simple projection of expected age from the first reported age
. * and from the last reported age.  
. gen expected_age_fwd = tage$first_wave
(25,188 missing values generated)

. gen expected_age_fwd$first_wave = expected_age_fwd
(25,188 missing values generated)

. 
. * a counter; after 3 observations at current age, increase by 1
. gen num_curr_age = 0

. replace num_curr_age = 1 if (!missing(expected_age_fwd))
(105,663 real changes made)

. 
. forvalues wave = $second_wave/$final_wave {
  2.     * Increment counter of age runs if we have established an age.
.     * Set the counter to 1 if we are just now establishing an age.
.     replace num_curr_age = num_curr_age + 1 if (!missing(expected_age_fwd))
  3.     replace num_curr_age = 1 if ((!missing(tage`wave')) & (missing(expected_age_fwd)))
  4.     replace expected_age_fwd = tage`wave' if ((!missing(tage`wave')) & (missing(expected_age_fwd)))
  5. 
.     * Increment the age if we've already used it three times. Reset counter.
.     replace expected_age_fwd = expected_age_fwd + 1 if (num_curr_age > 3)
  6.     replace num_curr_age = 1 if (num_curr_age > 3)
  7. 
.     gen expected_age_fwd`wave' = expected_age_fwd
  8. }
(105,663 real changes made)
(2,616 real changes made)
(2,616 real changes made)
(0 real changes made)
(0 real changes made)
(22,572 missing values generated)
(108,279 real changes made)
(2,542 real changes made)
(2,542 real changes made)
(0 real changes made)
(0 real changes made)
(20,030 missing values generated)
(110,821 real changes made)
(2,505 real changes made)
(2,505 real changes made)
(105,663 real changes made)
(105,663 real changes made)
(17,525 missing values generated)
(113,326 real changes made)
(2,264 real changes made)
(2,264 real changes made)
(2,616 real changes made)
(2,616 real changes made)
(15,261 missing values generated)
(115,590 real changes made)
(2,113 real changes made)
(2,113 real changes made)
(2,542 real changes made)
(2,542 real changes made)
(13,148 missing values generated)
(117,703 real changes made)
(1,878 real changes made)
(1,878 real changes made)
(108,168 real changes made)
(108,168 real changes made)
(11,270 missing values generated)
(119,581 real changes made)
(1,660 real changes made)
(1,660 real changes made)
(4,880 real changes made)
(4,880 real changes made)
(9,610 missing values generated)
(121,241 real changes made)
(1,673 real changes made)
(1,673 real changes made)
(4,655 real changes made)
(4,655 real changes made)
(7,937 missing values generated)
(122,914 real changes made)
(1,597 real changes made)
(1,597 real changes made)
(110,046 real changes made)
(110,046 real changes made)
(6,340 missing values generated)
(124,511 real changes made)
(1,368 real changes made)
(1,368 real changes made)
(6,540 real changes made)
(6,540 real changes made)
(4,972 missing values generated)
(125,879 real changes made)
(1,350 real changes made)
(1,350 real changes made)
(6,328 real changes made)
(6,328 real changes made)
(3,622 missing values generated)
(127,229 real changes made)
(1,532 real changes made)
(1,532 real changes made)
(111,643 real changes made)
(111,643 real changes made)
(2,090 missing values generated)
(128,761 real changes made)
(1,161 real changes made)
(1,161 real changes made)
(7,908 real changes made)
(7,908 real changes made)
(929 missing values generated)
(129,922 real changes made)
(929 real changes made)
(929 real changes made)
(7,678 real changes made)
(7,678 real changes made)

. drop num_curr_age expected_age_fwd

. 
. * backward projection.
. gen expected_age_bkwd = tage$final_wave
(58,377 missing values generated)

. gen expected_age_bkwd$final_wave = expected_age_bkwd
(58,377 missing values generated)

. 
. gen num_curr_age = 0

. replace num_curr_age = 1 if (!missing(expected_age_bkwd))
(72,474 real changes made)

. 
. forvalues wave = $penultimate_wave (-1) $first_wave {
  2.     * Increment counter of age runs if we have established an age.
.     * Set the counter to 1 if we are just now establishing an age.
.     replace num_curr_age = num_curr_age + 1 if (!missing(expected_age_bkwd))
  3.     replace num_curr_age = 1 if ((!missing(tage`wave')) & (missing(expected_age_bkwd)))
  4.     replace expected_age_bkwd = tage`wave' if ((!missing(tage`wave')) & (missing(expected_age_bkwd)))
  5. 
.     * Decrement the age if we've already used it three times.
.     replace expected_age_bkwd = expected_age_bkwd - 1 if (num_curr_age > 3)
  6.     replace num_curr_age = 1 if (num_curr_age > 3)
  7. 
.     gen expected_age_bkwd`wave' = expected_age_bkwd
  8. }
(72,474 real changes made)
(5,880 real changes made)
(5,880 real changes made)
(0 real changes made)
(0 real changes made)
(52,497 missing values generated)
(78,354 real changes made)
(4,743 real changes made)
(4,743 real changes made)
(0 real changes made)
(0 real changes made)
(47,754 missing values generated)
(83,097 real changes made)
(5,375 real changes made)
(5,375 real changes made)
(72,474 real changes made)
(72,474 real changes made)
(42,379 missing values generated)
(88,472 real changes made)
(4,181 real changes made)
(4,181 real changes made)
(5,880 real changes made)
(5,880 real changes made)
(38,198 missing values generated)
(92,653 real changes made)
(3,937 real changes made)
(3,937 real changes made)
(4,743 real changes made)
(4,743 real changes made)
(34,261 missing values generated)
(96,590 real changes made)
(4,163 real changes made)
(4,163 real changes made)
(77,849 real changes made)
(77,849 real changes made)
(30,098 missing values generated)
(100,753 real changes made)
(3,934 real changes made)
(3,934 real changes made)
(10,061 real changes made)
(10,061 real changes made)
(26,164 missing values generated)
(104,687 real changes made)
(3,886 real changes made)
(3,886 real changes made)
(8,680 real changes made)
(8,680 real changes made)
(22,278 missing values generated)
(108,573 real changes made)
(3,964 real changes made)
(3,964 real changes made)
(82,012 real changes made)
(82,012 real changes made)
(18,314 missing values generated)
(112,537 real changes made)
(3,816 real changes made)
(3,816 real changes made)
(13,995 real changes made)
(13,995 real changes made)
(14,498 missing values generated)
(116,353 real changes made)
(3,462 real changes made)
(3,462 real changes made)
(12,566 real changes made)
(12,566 real changes made)
(11,036 missing values generated)
(119,815 real changes made)
(3,708 real changes made)
(3,708 real changes made)
(85,976 real changes made)
(85,976 real changes made)
(7,328 missing values generated)
(123,523 real changes made)
(3,572 real changes made)
(3,572 real changes made)
(17,811 real changes made)
(17,811 real changes made)
(3,756 missing values generated)
(127,095 real changes made)
(3,756 real changes made)
(3,756 real changes made)
(16,028 real changes made)
(16,028 real changes made)

. drop num_curr_age expected_age_bkwd

. 
. ********************************************************************************
. * Section: Check backwards and forwards projections against what is coded
. ********************************************************************************
. 
. *** Count the number of times age matches each projection (within one, in the correct direction).
. gen num_fwd_matches = 0

. gen num_bkwd_matches = 0

. forvalues wave = $first_wave/$final_wave {
  2.     gen fwd_match`wave' = ((!missing(tage`wave')) & (tage`wave' >= expected_age_fwd`wave') & (tage`wave' <= expected_age_fwd`wave' + 1))
  3.     replace num_fwd_matches = num_fwd_matches + 1 if (fwd_match`wave' == 1)
  4.     gen bkwd_match`wave' = ((!missing(tage`wave')) & (tage`wave' <= expected_age_bkwd`wave') & (tage`wave' >= expected_age_bkwd`wave' - 1))
  5.     replace num_bkwd_matches = num_bkwd_matches + 1 if (bkwd_match`wave' == 1)
  6. }
(105,663 real changes made)
(102,780 real changes made)
(97,314 real changes made)
(96,320 real changes made)
(93,506 real changes made)
(93,540 real changes made)
(88,641 real changes made)
(89,786 real changes made)
(88,351 real changes made)
(89,210 real changes made)
(85,975 real changes made)
(86,922 real changes made)
(82,660 real changes made)
(84,259 real changes made)
(82,135 real changes made)
(83,345 real changes made)
(79,927 real changes made)
(81,296 real changes made)
(76,659 real changes made)
(78,474 real changes made)
(75,851 real changes made)
(77,372 real changes made)
(74,953 real changes made)
(76,523 real changes made)
(73,362 real changes made)
(75,557 real changes made)
(72,670 real changes made)
(74,591 real changes made)
(70,198 real changes made)
(72,474 real changes made)

. 
. *check against number of observed waves to create problem flag 
. gen num_fwd_problem=num_ages-num_fwd_matches

. gen num_bkwd_problem=num_ages-num_bkwd_matches

. 
. gen anyproblem=0

. replace anyproblem=1 if num_fwd_problem > 0 | num_bkwd_problem > 0
(6,713 real changes made)

. 
. tab anyproblem

 anyproblem |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    124,138       94.87       94.87
          1 |      6,713        5.13      100.00
------------+-----------------------------------
      Total |    130,851      100.00

. 
. ********************************************************************************
. * Section: adjust age to projection if backwards and forwards projection are within 1
. ********************************************************************************
. 
. gen adj_age$first_wave = tage$first_wave
(25,188 missing values generated)

. forvalues wave = $second_wave/$final_wave {
  2. 
. * fix age when it is out of line with backwards and forwards projections
.     gen adj_age`wave' = tage`wave'
  3.     replace adj_age`wave' = expected_age_fwd`wave' if ((!missing(tage`wave')) & (fwd_match`wave' == 0) & (bkwd_match`wave' == 0) & (abs(expected_age_fwd`wave' - expected_age_bkwd`wave') <= 1))
  4.         
. * fix age when it is missing. Take forward projection first. If no forward projection, then take backward projection.   
.         replace adj_age`wave'= expected_age_fwd`wave' if missing(adj_age`wave') & !missing(expected_age_fwd`wave')
  5.         replace adj_age`wave'=expected_age_bkwd`wave' if missing(adj_age`wave') & !missing(expected_age_bkwd`wave')
  6. }
(32,347 missing values generated)
(186 real changes made)
(9,775 real changes made)
(22,572 real changes made)
(35,599 missing values generated)
(194 real changes made)
(15,569 real changes made)
(20,030 real changes made)
(39,632 missing values generated)
(268 real changes made)
(22,107 real changes made)
(17,525 real changes made)
(40,374 missing values generated)
(149 real changes made)
(25,113 real changes made)
(15,261 real changes made)
(42,687 missing values generated)
(141 real changes made)
(29,539 real changes made)
(13,148 real changes made)
(45,454 missing values generated)
(195 real changes made)
(34,184 real changes made)
(11,270 real changes made)
(46,451 missing values generated)
(134 real changes made)
(36,841 real changes made)
(9,610 real changes made)
(48,591 missing values generated)
(110 real changes made)
(40,654 real changes made)
(7,937 real changes made)
(51,530 missing values generated)
(139 real changes made)
(45,190 real changes made)
(6,340 real changes made)
(52,750 missing values generated)
(94 real changes made)
(47,778 real changes made)
(4,972 real changes made)
(53,564 missing values generated)
(90 real changes made)
(49,942 real changes made)
(3,622 real changes made)
(54,817 missing values generated)
(107 real changes made)
(52,727 real changes made)
(2,090 real changes made)
(55,933 missing values generated)
(47 real changes made)
(55,004 real changes made)
(929 real changes made)
(58,377 missing values generated)
(0 real changes made)
(58,377 real changes made)
(0 real changes made)

. 
. * The plan will be to replace adjusted ages when adj_age is missing and expected_age_fwd/expected_age_bkwd are not.
. 
. ********************************************************************************
. * Section: Check backwards and forwards projections against adjusted age
. ********************************************************************************
. gen num_adjfwd_matches = 0

. gen num_adjbkwd_matches = 0

. forvalues wave = $first_wave/$final_wave {
  2.     gen adjfwd_match`wave' = ((!missing(adj_age`wave')) & (adj_age`wave' >= expected_age_fwd`wave') & (adj_age`wave' <= expected_age_fwd`wave' + 1))
  3.     replace num_adjfwd_matches = num_adjfwd_matches + 1 if (adjfwd_match`wave' == 1)
  4.     gen adjbkwd_match`wave' = ((!missing(adj_age`wave')) & (adj_age`wave' <= expected_age_bkwd`wave') & (adj_age`wave' >= expected_age_bkwd`wave' - 1))
  5.     replace num_adjbkwd_matches = num_adjbkwd_matches + 1 if (adjbkwd_match`wave' == 1)
  6. }
(105,663 real changes made)
(102,780 real changes made)
(107,275 real changes made)
(124,735 real changes made)
(109,269 real changes made)
(121,046 real changes made)
(111,016 real changes made)
(118,082 real changes made)
(113,613 real changes made)
(114,745 real changes made)
(115,655 real changes made)
(110,262 real changes made)
(117,039 real changes made)
(107,025 real changes made)
(119,110 real changes made)
(103,307 real changes made)
(120,691 real changes made)
(98,919 real changes made)
(121,988 real changes made)
(95,335 real changes made)
(123,723 real changes made)
(91,620 real changes made)
(124,985 real changes made)
(87,153 real changes made)
(126,196 real changes made)
(82,462 real changes made)
(127,721 real changes made)
(77,970 real changes made)
(128,575 real changes made)
(72,474 real changes made)

. 
. gen num_adjfwd_problem=num_ages-num_adjfwd_matches

. gen num_adjbkwd_problem=num_ages-num_adjbkwd_matches

. 
. gen any_adj_problem=0

. replace any_adj_problem=1 if num_adjfwd_problem > 0 | num_adjbkwd_problem > 0
(4,770 real changes made)

. 
. *******************************************************************************
. * Section: create flags for data that remain problematic. 
. *******************************************************************************
. 
. gen monotonic = 1 /* dpes age always increase? */

. gen ageproblem=0 /* are there deviations in age from one observation to the next greater than 5 */

. gen childageproblem=0

. gen curr_age = adj_age$first_wave
(25,188 missing values generated)

. forvalues wave = $second_wave/$final_wave {
  2.     replace monotonic = 0 if ((!missing(adj_age`wave')) & (!missing(curr_age)) & (adj_age`wave' < curr_age))
  3.         replace ageproblem=1 if ((!missing(adj_age`wave')) & (!missing(curr_age)) & (abs(adj_age`wave'-curr_age) > 5))
  4.         replace childageproblem=1 if ((!missing(adj_age`wave')) & (!missing(curr_age)) & (abs(adj_age`wave'-curr_age) > 5)) & (curr_age < 18)
  5.     replace curr_age = adj_age`wave' if (!missing(adj_age`wave'))
  6. }
(534 real changes made)
(261 real changes made)
(38 real changes made)
(57,457 real changes made)
(3,627 real changes made)
(361 real changes made)
(57 real changes made)
(39,221 real changes made)
(757 real changes made)
(181 real changes made)
(40 real changes made)
(59,783 real changes made)
(662 real changes made)
(129 real changes made)
(35 real changes made)
(34,547 real changes made)
(2,799 real changes made)
(104 real changes made)
(22 real changes made)
(36,434 real changes made)
(490 real changes made)
(108 real changes made)
(32 real changes made)
(65,193 real changes made)
(476 real changes made)
(74 real changes made)
(43 real changes made)
(32,955 real changes made)
(2,165 real changes made)
(64 real changes made)
(21 real changes made)
(34,236 real changes made)
(334 real changes made)
(68 real changes made)
(23 real changes made)
(68,465 real changes made)
(426 real changes made)
(54 real changes made)
(24 real changes made)
(31,221 real changes made)
(1,762 real changes made)
(91 real changes made)
(29 real changes made)
(32,889 real changes made)
(305 real changes made)
(55 real changes made)
(34 real changes made)
(70,866 real changes made)
(352 real changes made)
(48 real changes made)
(23 real changes made)
(30,803 real changes made)
(1,140 real changes made)
(19 real changes made)
(19 real changes made)
(30,315 real changes made)

. 
. tab ageproblem anyproblem

           |      anyproblem
ageproblem |         0          1 |     Total
-----------+----------------------+----------
         0 |   124,138      5,096 |   129,234 
         1 |         0      1,617 |     1,617 
-----------+----------------------+----------
     Total |   124,138      6,713 |   130,851 

. tab childageproblem

childagepro |
       blem |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    130,411       99.66       99.66
          1 |        440        0.34      100.00
------------+-----------------------------------
      Total |    130,851      100.00

. 
. tab ageproblem any_adj_problem

           |    any_adj_problem
ageproblem |         0          1 |     Total
-----------+----------------------+----------
         0 |   125,872      3,362 |   129,234 
         1 |       209      1,408 |     1,617 
-----------+----------------------+----------
     Total |   126,081      4,770 |   130,851 

. 
. drop curr_age

. drop expected_age_bkwd* expected_age_fwd*

. drop adjbkwd* adjfwd*

. drop bkwd* fwd*

. drop monotonic

. drop num_adjbkwd_matches num_adjfwd_matches 

. drop anyproblem

. drop any_adj_problem

. drop tage*

. 
. 
. * Create dummies for whether in this interview to be able to create an indicator for whether in interview next wave
. forvalues w=1/$final_wave {
  2.   gen in`w'=0
  3.   replace in`w'=1 if !missing(errp`w')
  4.   }
(105,663 real changes made)
(98,504 real changes made)
(95,252 real changes made)
(91,219 real changes made)
(90,477 real changes made)
(88,164 real changes made)
(85,397 real changes made)
(84,400 real changes made)
(82,260 real changes made)
(79,321 real changes made)
(78,101 real changes made)
(77,287 real changes made)
(76,034 real changes made)
(74,918 real changes made)
(72,474 real changes made)

.   
. forvalues w=1/$penultimate_wave {
  2.   local x=`w'+1
  3.   gen innext`w'=0
  4.   replace innext`w'=1 if in`x'==1
  5.  }
(98,504 real changes made)
(95,252 real changes made)
(91,219 real changes made)
(90,477 real changes made)
(88,164 real changes made)
(85,397 real changes made)
(84,400 real changes made)
(82,260 real changes made)
(79,321 real changes made)
(78,101 real changes made)
(77,287 real changes made)
(76,034 real changes made)
(74,918 real changes made)
(72,474 real changes made)

. 
. save "$tempdir/person_wide_adjusted_ages", $replace
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/person_wide_adjusted_ages.dta saved

. 
. keep ssuid epppnum ems* errp* wpfinwgt* eorigin* ebornus* etypmom* etypdad* my_race my_racealt my_sex mom_educ* dad_educ* mom_immigrant* dad_immigrant* adj_age* mom_age* biomom_age* biomom_educ* da
> d_age* biodad_age* innext* ref_person* ref_person_sex* ref_person_educ* biomom_ed_first mom_ed_first dad_ed_first par_ed_first mom_measure

. 
. save "$tempdir/demo_wide.dta", $replace
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/demo_wide.dta saved

. 
. reshape long adj_age ems errp wpfinwgt eorigin ebornus etypmom etypdad mom_educ dad_educ mom_immigrant dad_immigrant mom_age biomom_age biomom_educ dad_age biodad_age innext ref_person ref_person_s
> ex ref_person_educ, i(ssuid epppnum) j(swave)
(note: j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15)
(note: innext15 not found)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                   130851   -> 2.0e+06
Number of variables                 324   ->      32
j variable (15 values)                    ->   swave
xij variables:
        adj_age1 adj_age2 ... adj_age15   ->   adj_age
                    ems1 ems2 ... ems15   ->   ems
                 errp1 errp2 ... errp15   ->   errp
     wpfinwgt1 wpfinwgt2 ... wpfinwgt15   ->   wpfinwgt
        eorigin1 eorigin2 ... eorigin15   ->   eorigin
        ebornus1 ebornus2 ... ebornus15   ->   ebornus
        etypmom1 etypmom2 ... etypmom15   ->   etypmom
        etypdad1 etypdad2 ... etypdad15   ->   etypdad
     mom_educ1 mom_educ2 ... mom_educ15   ->   mom_educ
     dad_educ1 dad_educ2 ... dad_educ15   ->   dad_educ
mom_immigrant1 mom_immigrant2 ... mom_immigrant15->mom_immigrant
dad_immigrant1 dad_immigrant2 ... dad_immigrant15->dad_immigrant
        mom_age1 mom_age2 ... mom_age15   ->   mom_age
biomom_age1 biomom_age2 ... biomom_age15  ->   biomom_age
biomom_educ1 biomom_educ2 ... biomom_educ15->  biomom_educ
        dad_age1 dad_age2 ... dad_age15   ->   dad_age
biodad_age1 biodad_age2 ... biodad_age15  ->   biodad_age
           innext1 innext2 ... innext15   ->   innext
ref_person1 ref_person2 ... ref_person15  ->   ref_person
ref_person_sex1 ref_person_sex2 ... ref_person_sex15->ref_person_sex
ref_person_educ1 ref_person_educ2 ... ref_person_educ15->ref_person_educ
-----------------------------------------------------------------------------

. 
. label variable adj_age "Adjusted Age"

. label variable innext "Is this person interviewed in next wave?"

. 
. * now includes all observations, even when missing interview. errp is missing when no interview.
. tab errp,m 

        PE: Household relationship |      Freq.     Percent        Cum.
-----------------------------------+-----------------------------------
     Reference person with related |    340,052       17.33       17.33
  Reference Person without related |    166,826        8.50       25.82
        Spouse of reference person |    251,028       12.79       38.61
         Child of reference person |    391,373       19.94       58.55
    Grandchild of reference person |     31,181        1.59       60.14
        Parent of reference person |     11,590        0.59       60.73
Brother/sister of reference person |     10,981        0.56       61.29
Other relative of reference person |     25,128        1.28       62.57
  Foster child of reference person |      1,523        0.08       62.65
    Unmarried partner of reference |     23,598        1.20       63.85
                Housemate/roommate |     10,989        0.56       64.41
                    Roomer/boarder |      3,286        0.17       64.58
   Other non-relative of reference |     11,916        0.61       65.19
                                 . |    683,294       34.81      100.00
-----------------------------------+-----------------------------------
                             Total |  1,962,765      100.00

. 
. * most important for linking to arrivers who have missing data 
. save "$tempdir/demo_long_all", $replace
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/demo_long_all.dta saved

. 
. drop if missing(errp)
(683,294 observations deleted)

. 
. save "$tempdir/demo_long_interviews", $replace
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/demo_long_interviews.dta saved

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. //==============================================================================
. //===== Children's Household Instability Project                                                    
. //===== Dataset: SIPP2008                                                                               
. //===== Purpose: Create a database with comp_change, addr_change, and sociodemographic characteristics
. //===== One record per person per wave.
. //===== create_comp_change generates the variable comp_change. This file adds addr_change
. //===== and reshapes the data to long form.
. //===== Note: this code depends on macros set in project_macros and create_comp_change
. //==============================================================================
. 
. use "$SIPP08keep/comp_change.dta", clear

. 
. #delimit ; 
delimiter now ;
. label define addr_change          0 "No move"
>                                   1 "Move";

.          #delimit cr
delimiter now cr
. 
. ********************************************************************************
. * Function Propagate shhadid_members forard into prev_shhadid for missing waves.
. ********************************************************************************
. 
. gen prev_shhadid$first_wave = .
(130,851 missing values generated)

. forvalues wave = $second_wave/$final_wave {
  2.     local prev_wave = `wave' - 1
  3.     gen prev_shhadid`wave' = shhadid`prev_wave' if (missing(shhadid`wave') & missing(prev_shhadid`prev_wave'))
  4.     replace prev_shhadid`wave' = prev_shhadid`prev_wave' if (missing(shhadid`wave') & (!missing(prev_shhadid`prev_wave')))
  5. }
(121,076 missing values generated)
(0 real changes made)
(121,734 missing values generated)
(6,452 real changes made)
(120,593 missing values generated)
(11,849 real changes made)
(122,296 missing values generated)
(16,558 real changes made)
(121,736 missing values generated)
(20,424 real changes made)
(121,402 missing values generated)
(24,735 real changes made)
(122,789 missing values generated)
(28,779 real changes made)
(122,485 missing values generated)
(32,288 real changes made)
(121,949 missing values generated)
(36,288 real changes made)
(123,409 missing values generated)
(40,336 real changes made)
(123,479 missing values generated)
(42,570 real changes made)
(122,899 missing values generated)
(44,775 real changes made)
(123,748 missing values generated)
(47,901 real changes made)
(124,971 missing values generated)
(52,497 real changes made)

. 
. ********************************************************************************
. ** Function:  Propagate shhadid_members backward into future_hh_members for missing waves.  
. ********************************************************************************
. 
. gen future_shhadid$final_wave = .
(130,851 missing values generated)

. forvalues wave = $penultimate_wave (-1) $first_wave {
  2.     local next_wave = `wave' + 1
  3.     gen future_shhadid`wave' = shhadid`next_wave' if (missing(shhadid`wave') & missing(future_shhadid`next_wave'))
  4.     replace future_shhadid`wave' = future_shhadid`next_wave' if (missing(shhadid`wave') & (!missing(future_shhadid`next_wave')))
  5. }
(127,415 missing values generated)
(0 real changes made)
(124,864 missing values generated)
(1,076 real changes made)
(124,152 missing values generated)
(4,486 real changes made)
(124,293 missing values generated)
(7,994 real changes made)
(124,629 missing values generated)
(11,047 real changes made)
(124,888 missing values generated)
(12,530 real changes made)
(124,625 missing values generated)
(14,061 real changes made)
(123,786 missing values generated)
(16,111 real changes made)
(124,169 missing values generated)
(17,691 real changes made)
(124,049 missing values generated)
(19,074 real changes made)
(123,038 missing values generated)
(20,783 real changes made)
(124,626 missing values generated)
(22,046 real changes made)
(124,986 missing values generated)
(22,726 real changes made)
(128,235 missing values generated)
(22,572 real changes made)

. 
. ********************************************************************************
. ** Function: walk backward through the waves and for each wave in which ego is missing  compare prev_SHHAIDD to see if we find anyone
. ********************************************************************************
. 
. gen found_prev_shhadid$first_wave = .
(130,851 missing values generated)

. forvalues wave = $final_wave (-1) $second_wave {
  2.         gen found_prev_shhadid`wave'= 0 if (missing(shhadid`wave'))
  3.         gen found_prev_shhadid_in_gap`wave'=0 if (missing(shhadid`wave'))
  4.         replace found_prev_shhadid`wave' = 1 if ((missing(shhadid`wave')) & (strpos(ssuid_shhadid`wave', " " + string(prev_shhadid`wave') + " ") != 0))
  5.         replace found_prev_shhadid_in_gap`wave' = 1 if ((missing(shhadid`wave')) & (strpos(ssuid_shhadid`wave', " " + string(prev_shhadid`wave') + " ") !=0))
  6.         if (`wave' < $final_wave) {
  7.                 local next_wave = `wave' + 1
  8.                 replace found_prev_shhadid_in_gap`wave' = 1 if ((missing(shhadid`wave')) & (found_prev_shhadid_in_gap`next_wave' == 1))
  9.         }
 10. }
(72,474 missing values generated)
(72,474 missing values generated)
(6,815 real changes made)
(6,815 real changes made)
(74,918 missing values generated)
(74,918 missing values generated)
(6,630 real changes made)
(6,630 real changes made)
(249 real changes made)
(76,034 missing values generated)
(76,034 missing values generated)
(6,400 real changes made)
(6,400 real changes made)
(375 real changes made)
(77,287 missing values generated)
(77,287 missing values generated)
(6,097 real changes made)
(6,097 real changes made)
(612 real changes made)
(78,101 missing values generated)
(78,101 missing values generated)
(5,800 real changes made)
(5,800 real changes made)
(684 real changes made)
(79,321 missing values generated)
(79,321 missing values generated)
(5,466 real changes made)
(5,466 real changes made)
(696 real changes made)
(82,260 missing values generated)
(82,260 missing values generated)
(5,097 real changes made)
(5,097 real changes made)
(649 real changes made)
(84,400 missing values generated)
(84,400 missing values generated)
(4,648 real changes made)
(4,648 real changes made)
(645 real changes made)
(85,397 missing values generated)
(85,397 missing values generated)
(4,207 real changes made)
(4,207 real changes made)
(587 real changes made)
(88,164 missing values generated)
(88,164 missing values generated)
(3,720 real changes made)
(3,720 real changes made)
(467 real changes made)
(90,477 missing values generated)
(90,477 missing values generated)
(3,153 real changes made)
(3,153 real changes made)
(412 real changes made)
(91,219 missing values generated)
(91,219 missing values generated)
(2,560 real changes made)
(2,560 real changes made)
(388 real changes made)
(95,252 missing values generated)
(95,252 missing values generated)
(1,876 real changes made)
(1,876 real changes made)
(264 real changes made)
(98,504 missing values generated)
(98,504 missing values generated)
(1,082 real changes made)
(1,082 real changes made)
(152 real changes made)

. 
. ********************************************************************************
. ** Function: walk forward through the waves 
. ********************************************************************************
. 
. gen found_future_shhadid$final_wave = .
(130,851 missing values generated)

. forvalues wave = $first_wave/$penultimate_wave {
  2.         gen found_future_shhadid`wave'= 0 if (missing(shhadid`wave'))
  3.         gen found_future_shhadid_in_gap`wave'=0 if (missing(shhadid`wave'))
  4.         replace found_future_shhadid`wave' = 1 if ((missing(shhadid`wave')) & (strpos(ssuid_shhadid`wave', " " + string(prev_shhadid`wave') + " ") != 0))
  5.         replace found_future_shhadid_in_gap`wave' = 1 if ((missing(shhadid`wave')) & (strpos(ssuid_shhadid`wave', " " + string(prev_shhadid`wave') + " ") !=0))
  6.         if (`wave' > $final_wave) {
  7.                 local prev_wave = `wave' - 1
  8.                 replace found_future_shhadid_in_gap`wave' = 1 if ((missing(shhadid`wave')) & (found_future_shhadid_in_gap`prev_wave' == 1))
  9.         }
 10. }
(105,663 missing values generated)
(105,663 missing values generated)
(0 real changes made)
(0 real changes made)
(98,504 missing values generated)
(98,504 missing values generated)
(1,082 real changes made)
(1,082 real changes made)
(95,252 missing values generated)
(95,252 missing values generated)
(1,876 real changes made)
(1,876 real changes made)
(91,219 missing values generated)
(91,219 missing values generated)
(2,560 real changes made)
(2,560 real changes made)
(90,477 missing values generated)
(90,477 missing values generated)
(3,153 real changes made)
(3,153 real changes made)
(88,164 missing values generated)
(88,164 missing values generated)
(3,720 real changes made)
(3,720 real changes made)
(85,397 missing values generated)
(85,397 missing values generated)
(4,207 real changes made)
(4,207 real changes made)
(84,400 missing values generated)
(84,400 missing values generated)
(4,648 real changes made)
(4,648 real changes made)
(82,260 missing values generated)
(82,260 missing values generated)
(5,097 real changes made)
(5,097 real changes made)
(79,321 missing values generated)
(79,321 missing values generated)
(5,466 real changes made)
(5,466 real changes made)
(78,101 missing values generated)
(78,101 missing values generated)
(5,800 real changes made)
(5,800 real changes made)
(77,287 missing values generated)
(77,287 missing values generated)
(6,097 real changes made)
(6,097 real changes made)
(76,034 missing values generated)
(76,034 missing values generated)
(6,400 real changes made)
(6,400 real changes made)
(74,918 missing values generated)
(74,918 missing values generated)
(6,630 real changes made)
(6,630 real changes made)

. 
. *******************************************************************************
. ** Function: Compute address change.
. *******************************************************************************
. 
. forvalues wave = $first_wave/$penultimate_wave {
  2.     local next_wave = `wave' + 1
  3. 
.     * Start by assuming this wave is not interesting.
.     gen addr_change`wave' = .
  4. 
.     * If we have data in both waves, just compare HH members.
.     replace addr_change`wave' = (shhadid`wave' != shhadid`next_wave') if ((!missing(shhadid`wave')) & (!missing(shhadid`next_wave')))
  5. 
.     * If we are moving from a wave in which ego is missing to one in which ego is present
.     * there is an address change if we have seen the future shhadid in the gap during which ego was missing
.     * UNLESS this is ego's birth.
.     * We also need to populate age and weight from the next wave since ego has no data in this wave.
.     replace addr_change`wave' = 1 if ((missing(shhadid`wave')) & (!missing(shhadid`next_wave')) & (found_future_shhadid_in_gap`wave' == 1))
  6.     replace adj_age`wave' = adj_age`next_wave' if ((missing(shhadid`wave')) & (!missing(shhadid`next_wave')) & (found_future_shhadid_in_gap`wave' == 1))
  7.     replace wpfinwgt`wave' = wpfinwgt`next_wave' if ((missing(shhadid`wave')) & (!missing(shhadid`next_wave')) & (found_future_shhadid_in_gap`wave' == 1))
  8.     * Undo those changes if this is birth.
.     replace addr_change`wave' = . if ((`next_wave' == my_first_wave) & (adj_age`next_wave' == 0))
  9.     replace adj_age`wave' = . if ((`next_wave' == my_first_wave) & (adj_age`next_wave' == 0))
 10.     replace wpfinwgt`wave' = . if ((`next_wave' == my_first_wave) & (adj_age`next_wave' == 0))
 11. 
.     * If we are moving from a wave in which ego is present to one in which ego is missing
.     * there is an address change if we have seen the current shhadid in the gap 
.     * during which ego is missing as we look forward.
.     replace addr_change`wave' = 1 if ((!missing(shhadid`wave')) & (missing(shhadid`next_wave')) & (found_prev_shhadid_in_gap`next_wave' == 1))
 12. 
.     * If we are moving from a wave in which ego is present to one in which ego is missing
.     * and we do not see the current shhadid in the gap looking forward,
.     * we compare the current shhadid to the future shhadid as if we move into the
.     * future household in the first missing wave, unless there is no future shhadid
.     * (ego's last appearance).
.     replace addr_change`wave' = (shhadid`wave' != future_shhadid`next_wave') if ((!missing(shhadid`wave')) & (missing(shhadid`next_wave')) & (!missing(future_shhadid`next_wave')) & (found_prev_shha
> did_in_gap`next_wave' != 1))
 13. 
. 
.     * Tab "original" addr_change and comp_change variables.
.     tab addr_change`wave' comp_change`wave', m
 14. 
.     * We once forced them up to have the same denominator by setting to zero if missing and the other variable is not missing.
.         * but this is not appropriate. Sometimes we can know if there was an address change even if we don't know household composition
.         * Keeping this here to document.
. *    replace addr_change`wave' = 0 if (missing(addr_change`wave') & (!missing(comp_change`wave')))
. *    replace comp_change`wave' = 0 if (missing(comp_change`wave') & (!missing(addr_change`wave')))
. 
. *    tab addr_change`wave' comp_change`wave', m
. }
(130,851 missing values generated)
(95,888 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1,234 real changes made)
(5,690 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e1 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    90,236      6,890          0 |    97,126 
         1 |     2,776      2,910          0 |     5,686 
         . |         0      2,422     25,617 |    28,039 
-----------+---------------------------------+----------
     Total |    93,012     12,222     25,617 |   130,851 
(130,851 missing values generated)
(89,387 real changes made)
(109 real changes made)
(32 real changes made)
(65 real changes made)
(0 real changes made)
(406 real changes made, 406 to missing)
(0 real changes made)
(1,166 real changes made)
(5,223 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e2 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    83,757      5,964          0 |    89,721 
         1 |     2,870      3,229         65 |     6,164 
         . |         0      2,532     32,434 |    34,966 
-----------+---------------------------------+----------
     Total |    86,627     11,725     32,499 |   130,851 
(130,851 missing values generated)
(84,994 real changes made)
(172 real changes made)
(100 real changes made)
(102 real changes made)
(0 real changes made)
(406 real changes made, 406 to missing)
(0 real changes made)
(1,210 real changes made)
(6,203 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e3 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    79,784      6,051          0 |    85,835 
         1 |     3,196      3,444        104 |     6,744 
         . |         0      2,604     35,668 |    38,272 
-----------+---------------------------------+----------
     Total |    82,980     12,099     35,772 |   130,851 
(130,851 missing values generated)
(82,664 real changes made)
(212 real changes made)
(45 real changes made)
(138 real changes made)
(0 real changes made)
(415 real changes made, 415 to missing)
(0 real changes made)
(1,099 real changes made)
(4,848 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e4 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    77,925      5,523          0 |    83,448 
         1 |     2,439      2,798        138 |     5,375 
         . |         0      2,375     39,653 |    42,028 
-----------+---------------------------------+----------
     Total |    80,364     10,696     39,791 |   130,851 
(130,851 missing values generated)
(81,362 real changes made)
(162 real changes made)
(55 real changes made)
(86 real changes made)
(0 real changes made)
(357 real changes made, 357 to missing)
(0 real changes made)
(1,091 real changes made)
(5,084 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e5 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    76,851      5,246          0 |    82,097 
         1 |     2,750      2,765         87 |     5,602 
         . |         0      2,321     40,831 |    43,152 
-----------+---------------------------------+----------
     Total |    79,601     10,332     40,918 |   130,851 
(130,851 missing values generated)
(78,715 real changes made)
(184 real changes made)
(87 real changes made)
(87 real changes made)
(0 real changes made)
(330 real changes made, 330 to missing)
(0 real changes made)
(1,155 real changes made)
(5,218 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e6 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    74,707      4,978          0 |    79,685 
         1 |     2,621      2,878         88 |     5,587 
         . |         0      2,092     43,487 |    45,579 
-----------+---------------------------------+----------
     Total |    77,328      9,948     43,575 |   130,851 
(130,851 missing values generated)
(77,335 real changes made)
(217 real changes made)
(39 real changes made)
(103 real changes made)
(0 real changes made)
(298 real changes made, 298 to missing)
(0 real changes made)
(1,047 real changes made)
(4,011 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e7 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    73,515      4,591          0 |    78,106 
         1 |     2,008      2,392        104 |     4,504 
         . |         0      1,871     46,370 |    48,241 
-----------+---------------------------------+----------
     Total |    75,523      8,854     46,474 |   130,851 
(130,851 missing values generated)
(76,034 real changes made)
(144 real changes made)
(43 real changes made)
(58 real changes made)
(0 real changes made)
(314 real changes made, 314 to missing)
(0 real changes made)
(1,001 real changes made)
(4,261 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e8 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    72,325      4,531          0 |    76,856 
         1 |     2,212      2,314         58 |     4,584 
         . |         0      1,940     47,471 |    49,411 
-----------+---------------------------------+----------
     Total |    74,537      8,785     47,529 |   130,851 
(130,851 missing values generated)
(73,358 real changes made)
(166 real changes made)
(69 real changes made)
(72 real changes made)
(0 real changes made)
(309 real changes made, 309 to missing)
(0 real changes made)
(1,031 real changes made)
(4,588 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
        e9 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    69,661      4,525          0 |    74,186 
         1 |     2,401      2,483         73 |     4,957 
         . |         0      1,845     49,863 |    51,708 
-----------+---------------------------------+----------
     Total |    72,062      8,853     49,936 |   130,851 
(130,851 missing values generated)
(71,879 real changes made)
(159 real changes made)
(19 real changes made)
(59 real changes made)
(0 real changes made)
(298 real changes made, 298 to missing)
(0 real changes made)
(911 real changes made)
(3,367 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
       e10 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    68,589      3,931          0 |    72,520 
         1 |     1,711      2,026         59 |     3,796 
         . |         0      1,556     52,979 |    54,535 
-----------+---------------------------------+----------
     Total |    70,300      7,513     53,038 |   130,851 
(130,851 missing values generated)
(70,729 real changes made)
(187 real changes made)
(41 real changes made)
(72 real changes made)
(0 real changes made)
(298 real changes made, 298 to missing)
(0 real changes made)
(882 real changes made)
(3,086 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
       e11 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    67,100      3,842          0 |    70,942 
         1 |     1,930      1,939         73 |     3,942 
         . |         0      1,464     54,503 |    55,967 
-----------+---------------------------------+----------
     Total |    69,030      7,245     54,576 |   130,851 
(130,851 missing values generated)
(69,335 real changes made)
(192 real changes made)
(84 real changes made)
(85 real changes made)
(0 real changes made)
(314 real changes made, 314 to missing)
(0 real changes made)
(797 real changes made)
(2,504 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
       e12 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    65,060      3,734          0 |    68,794 
         1 |     2,087      1,862         85 |     4,034 
         . |         0      1,682     56,341 |    58,023 
-----------+---------------------------------+----------
     Total |    67,147      7,278     56,426 |   130,851 
(130,851 missing values generated)
(68,931 real changes made)
(176 real changes made)
(28 real changes made)
(76 real changes made)
(0 real changes made)
(273 real changes made, 273 to missing)
(0 real changes made)
(770 real changes made)
(2,309 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
       e13 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    65,580      3,499          0 |    69,079 
         1 |     1,416      1,615         76 |     3,107 
         . |         0      1,309     57,356 |    58,665 
-----------+---------------------------------+----------
     Total |    66,996      6,423     57,432 |   130,851 
(130,851 missing values generated)
(69,038 real changes made)
(113 real changes made)
(13 real changes made)
(19 real changes made)
(0 real changes made)
(262 real changes made, 262 to missing)
(0 real changes made)
(701 real changes made)
(0 real changes made)

           |     Indicator for whether a
           |  composition change is observed
addr_chang |           or inferred
       e14 | No change  Compositi          . |     Total
-----------+---------------------------------+----------
         0 |    63,914      2,993          0 |    66,907 
         1 |     1,467      1,459         19 |     2,945 
         . |         0        996     60,003 |    60,999 
-----------+---------------------------------+----------
     Total |    65,381      5,448     60,022 |   130,851 

. 
. gen original=1 if !missing(shhadid1)
(25,188 missing values generated)

. gen agewave1=adj_age1 if original==1
(25,188 missing values generated)

. 
. keep ssuid epppnum shhadid* adj_age* comp_change* addr_change* comp_change_reason* original agewave1

. 
. reshape long shhadid adj_age comp_change addr_change comp_change_reason, i(ssuid epppnum) j(swave)
(note: j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15)
(note: comp_change15 not found)
(note: addr_change15 not found)
(note: comp_change_reason15 not found)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                   130851   -> 2.0e+06
Number of variables                  91   ->      25
j variable (15 values)                    ->   swave
xij variables:
        shhadid1 shhadid2 ... shhadid15   ->   shhadid
        adj_age1 adj_age2 ... adj_age15   ->   adj_age
comp_change1 comp_change2 ... comp_change15->  comp_change
addr_change1 addr_change2 ... addr_change15->  addr_change
comp_change_reason1 comp_change_reason2 ... comp_change_reason15->comp_change_reason
-----------------------------------------------------------------------------

. 
. merge 1:1 ssuid epppnum swave using "$tempdir/demo_long_all.dta"
(label educ already defined)
(label esex already defined)
(label eorigin already defined)

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                         1,962,765  (_merge==3)
    -----------------------------------------

. 
. assert _merge==3

. 
. drop _merge

. 
. gen hh_change=comp_change
(774,456 missing values generated)

. replace hh_change=1 if addr_change==1
(32,913 real changes made)

. 
. gen inwave = !missing(errp)

. 
. gen insample=0

. * Keep if in this wave and next
. replace insample=1 if inwave==1 & innext==1
(1,089,649 real changes made)

. * also keep if hh_change is not missing. This would be (for example) if not in current wave, 
. * but in next one and people you live with in next wave appear while ego is missing.
. * hh_change also ==1 if in current wave and not in next, but some of the people 
. * you are living with now appear in "next" wave while ego is missing.
. * hh_change can =0 if not in next wave but in a subsequent one and everyone ego 
. * is with in this wave is in the household in the next appearence
. replace insample=2 if insample==0 & !missing(hh_change)
(99,689 real changes made)

. 
.         label var comp_change_reason "Codes for whether comp_change is observed in adjascent waves or inferred"

.     label values comp_change_reason comp_change_reason

.         
.         label var comp_change "Indicator for whether a composition change is observed or inferred"

.         label values comp_change comp_change

.         
.         label var addr_change "Indicator for whether individual moved"

.         label values addr_change addr_change

. 
. save "$SIPP08keep/hh_change.dta", $replace
(note: file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/SIPP08_Processed/hh_change.dta not found)
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/SIPP08_Processed/hh_change.dta saved

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. //==============================================================================
. //===== Children's Household Instability Project
. //===== Dataset: SIPP2008
. //===== Purpose:  Link individuals identified as entering, leaving, or staying in
. //===== a person's (ego's) household to their relationship to ego.
. //==============================================================================
. 
. use "$SIPP08keep/comp_change.dta", clear

. 
. keep ssuid epppnum shhadid* arrivers* leavers* stayers* comp_change* comp_change_reason* adj_age* 

. 
. reshape long shhadid adj_age arrivers leavers stayers comp_change comp_change_reason, i(ssuid epppnum) j(swave)
(note: j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15)
(note: arrivers15 not found)
(note: leavers15 not found)
(note: stayers15 not found)
(note: comp_change15 not found)
(note: comp_change_reason15 not found)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                   130851   -> 2.0e+06
Number of variables                 117   ->      25
j variable (15 values)                    ->   swave
xij variables:
        shhadid1 shhadid2 ... shhadid15   ->   shhadid
        adj_age1 adj_age2 ... adj_age15   ->   adj_age
     arrivers1 arrivers2 ... arrivers15   ->   arrivers
        leavers1 leavers2 ... leavers15   ->   leavers
        stayers1 stayers2 ... stayers15   ->   stayers
comp_change1 comp_change2 ... comp_change15->  comp_change
comp_change_reason1 comp_change_reason2 ... comp_change_reason15->comp_change_reason
-----------------------------------------------------------------------------

. 
. gen have_arrivers = (indexnot(arrivers, " ") != 0)

. gen have_leavers = (indexnot(leavers, " ") != 0)

. 
. gen have_changers = (have_arrivers | have_leavers)

. 
. tab comp_change have_changers

comp_chang |     have_changers
         e |         0          1 |     Total
-----------+----------------------+----------
         0 | 1,060,888          0 | 1,060,888 
         1 |         0    127,421 |   127,421 
-----------+----------------------+----------
     Total | 1,060,888    127,421 | 1,188,309 

. 
. assert (have_changers == 0) if (comp_change == 0)

. assert (have_changers == 0) if missing(comp_change)

. assert (have_changers == 1) if (comp_change == 1)

. 
. drop if missing(comp_change)
(774,456 observations deleted)

. 
. drop if (comp_change == 0)
(1,060,888 observations deleted)

. 
. save "$tempdir/comp_change_onlychangers", $replace
(note: file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/comp_change_onlychangers.dta not found)
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/comp_change_onlychangers.dta saved

. 
. ********************************************************************************
. * Section: create long file where each record is a person who started or stopped
. *          living with ego (and stayed living with ego).
. ********************************************************************************
. 
. foreach changer in leaver arriver stayer {
  2.     clear
  3. 
.     use "$tempdir/comp_change_onlychangers"
  4. 
.     * Compute max number of leavers/arrivers.
.     gen n_`changer's = wordcount(`changer's)
  5.     egen max_`changer's = max(n_`changer's)
  6. 
.     forvalues my_`changer'_num = 1/`=max_`changer's' {
  7.         gen `changer'`my_`changer'_num' = word(`changer's, `my_`changer'_num')
  8.     }
  9.     drop `changer's max_`changer's
 10. 
.     keep ssuid epppnum shhadid swave adj_age comp_change_reason n_`changer's `changer'* 
 11. 
.     reshape long `changer', i(ssuid epppnum swave) j(`changer'_num)
 12. 
.     drop if missing(`changer')
 13. 
.     save "$tempdir/hh_`changer's", $replace
 14. }
(62,346 missing values generated)
(102,220 missing values generated)
(114,567 missing values generated)
(120,941 missing values generated)
(124,527 missing values generated)
(126,176 missing values generated)
(126,897 missing values generated)
(127,202 missing values generated)
(127,320 missing values generated)
(127,382 missing values generated)
(127,397 missing values generated)
(127,407 missing values generated)
(127,410 missing values generated)
(note: j = 1 2 3 4 5 6 7 8 9 10 11 12 13)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                   127421   -> 1.7e+06
Number of variables                  20   ->       9
j variable (13 values)                    ->   leaver_num
xij variables:
           leaver1 leaver2 ... leaver13   ->   leaver
-----------------------------------------------------------------------------
(1,541,792 observations deleted)
(note: file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/hh_leavers.dta not found)
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/hh_leavers.dta saved
(57,911 missing values generated)
(104,759 missing values generated)
(116,871 missing values generated)
(122,224 missing values generated)
(125,114 missing values generated)
(126,436 missing values generated)
(127,049 missing values generated)
(127,257 missing values generated)
(127,351 missing values generated)
(127,406 missing values generated)
(127,415 missing values generated)
(127,420 missing values generated)
(127,420 missing values generated)
(note: j = 1 2 3 4 5 6 7 8 9 10 11 12 13)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                   127421   -> 1.7e+06
Number of variables                  20   ->       9
j variable (13 values)                    ->   arriver_num
xij variables:
        arriver1 arriver2 ... arriver13   ->   arriver
-----------------------------------------------------------------------------
(1,544,633 observations deleted)
(note: file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/hh_arrivers.dta not found)
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/hh_arrivers.dta saved
(43,180 missing values generated)
(57,331 missing values generated)
(75,849 missing values generated)
(94,659 missing values generated)
(109,427 missing values generated)
(118,412 missing values generated)
(123,056 missing values generated)
(125,233 missing values generated)
(126,313 missing values generated)
(126,943 missing values generated)
(127,143 missing values generated)
(127,297 missing values generated)
(127,369 missing values generated)
(note: j = 1 2 3 4 5 6 7 8 9 10 11 12 13)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                   127421   -> 1.7e+06
Number of variables                  20   ->       9
j variable (13 values)                    ->   stayer_num
xij variables:
           stayer1 stayer2 ... stayer13   ->   stayer
-----------------------------------------------------------------------------
(1,382,212 observations deleted)
(note: file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/hh_stayers.dta not found)
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/hh_stayers.dta saved

. 
. ********************************************************************************
. * Section: Linking those who leave to relationships in that wave
. ********************************************************************************
. 
. use "$tempdir/hh_leavers", clear

. drop if missing(leaver)
(0 observations deleted)

. gen relfrom = epppnum

. destring leaver, gen(relto)
leaver: all characters numeric; relto generated as int

. merge 1:1 ssuid relfrom relto swave using "$tempdir/relationship_pairs_bywave", keepusing(relationship)
key variable relfrom is str4 in master but float in using data
    Each key variable -- the variables on which observations are matched -- must be of the same generic type in the master and using datasets.  Same generic type means both numeric or both string.
r(106);

end of do-file

r(106);

. drop relfrom

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. gen relfrom = real(epppnum)

. 
end of do-file

. describe relfrom

              storage   display    value
variable name   type    format     label      variable label
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
relfrom         float   %9.0g                 

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. use "$tempdir/hh_leavers", clear

. drop if missing(leaver)
(0 observations deleted)

. gen relfrom = real(epppnum)

. destring leaver, gen(relto)
leaver: all characters numeric; relto generated as int

. merge 1:1 ssuid relfrom relto swave using "$tempdir/relationship_pairs_bywave", keepusing(relationship)
(note: variable relto was int, now float to accommodate using data's values)

    Result                           # of obs.
    -----------------------------------------
    not matched                     2,968,011
        from master                       119  (_merge==1)
        from using                  2,967,892  (_merge==2)

    matched                           114,562  (_merge==3)
    -----------------------------------------

.         
. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. display "deleting relationships to self"
deleting relationships to self

. drop if relfrom==relto
(0 observations deleted)

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. replace relationship=40 if _merge==1
(119 real changes made)

. 
. drop if _merge == 2
(2,967,892 observations deleted)

. drop _merge

. 
. display "Relationships for leavers"
Relationships for leavers

. tab relationship, m sort

        relationship |      Freq.     Percent        Cum.
---------------------+-----------------------------------
           other_rel |     18,754       16.35       16.35
               norel |     16,463       14.36       30.71
             sibling |     15,067       13.14       43.85
            biochild |     13,211       11.52       55.37
              biomom |      7,286        6.35       61.72
              spouse |      6,375        5.56       67.28
              biodad |      5,935        5.18       72.45
         grandparent |      5,198        4.53       76.99
          grandchild |      5,189        4.52       81.51
           stepchild |      2,974        2.59       84.10
            dontknow |      2,643        2.30       86.41
             partner |      2,541        2.22       88.62
child_or_nephewniece |      1,915        1.67       90.29
 auntuncle_or_parent |      1,907        1.66       91.96
             stepdad |      1,844        1.61       93.57
   sibling_or_cousin |      1,148        1.00       94.57
             stepmom |      1,134        0.99       95.56
           auntuncle |        830        0.72       96.28
         nephewniece |        825        0.72       97.00
              parent |        615        0.54       97.53
               child |        613        0.53       98.07
         other_rel_p |        467        0.41       98.48
          adoptchild |        315        0.27       98.75
               f_sib |        277        0.24       98.99
            f_parent |        222        0.19       99.19
             f_child |        200        0.17       99.36
            adoptdad |        169        0.15       99.51
            adoptmom |        147        0.13       99.64
       grandparent_p |         99        0.09       99.72
        grandchild_p |         98        0.09       99.81
                   . |         84        0.07       99.88
    greatgrandparent |         68        0.06       99.94
     greatgrandchild |         67        0.06      100.00
                 mom |          1        0.00      100.00
---------------------+-----------------------------------
               Total |    114,681      100.00

. save "$tempdir/leaver_rels", $replace
(note: file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/leaver_rels.dta not found)
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/leaver_rels.dta saved

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. use "$tempdir/hh_arrivers", clear

. 
. * We link to relationship in next wave, since they aren't together in this wave
. replace swave=swave+1
(111,840 real changes made)

. drop if missing(arriver)
(0 observations deleted)

. gen relfrom = epppnum

. destring arriver, gen(relto)
arriver: all characters numeric; relto generated as int

. merge 1:1 ssuid relfrom relto swave using "$tempdir/relationship_pairs_bywave", keepusing(relationship)
key variable relfrom is str4 in master but float in using data
    Each key variable -- the variables on which observations are matched -- must be of the same generic type in the master and using datasets.  Same generic type means both numeric or both string.
r(106);

end of do-file

r(106);

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. use "$tempdir/hh_arrivers", clear

. 
. * We link to relationship in next wave, since they aren't together in this wave
. replace swave=swave+1
(111,840 real changes made)

. drop if missing(arriver)
(0 observations deleted)

. gen relfrom = real(epppnum)

. destring arriver, gen(relto)
arriver: all characters numeric; relto generated as int

. merge 1:1 ssuid relfrom relto swave using "$tempdir/relationship_pairs_bywave", keepusing(relationship)
(note: variable relto was int, now float to accommodate using data's values)

    Result                           # of obs.
    -----------------------------------------
    not matched                     2,986,000
        from master                     7,693  (_merge==1)
        from using                  2,978,307  (_merge==2)

    matched                           104,147  (_merge==3)
    -----------------------------------------

. 
. * return swave to its original value. (Yiwen, this is the silly error I made 
. * that broke the code. I forgot to put swave back to its original value).       
. replace swave=swave-1
(3,090,147 real changes made)

. 
. display "deleting relationships to self"
deleting relationships to self

. drop if relfrom==relto
(0 observations deleted)

. 
. replace relationship=40 if _merge==1
(7,693 real changes made)

. 
. drop if _merge == 2
(2,978,307 observations deleted)

. drop _merge

. 
. display "Relationships for arrivers"
Relationships for arrivers

. tab relationship, m sort

        relationship |      Freq.     Percent        Cum.
---------------------+-----------------------------------
           other_rel |     15,714       14.05       14.05
               norel |     15,584       13.93       27.98
             sibling |     13,281       11.88       39.86
            dontknow |      9,896        8.85       48.71
            biochild |      9,381        8.39       57.10
              biomom |      8,642        7.73       64.82
              biodad |      6,610        5.91       70.73
         grandparent |      5,571        4.98       75.71
          grandchild |      4,488        4.01       79.73
              spouse |      3,999        3.58       83.30
             partner |      3,553        3.18       86.48
           stepchild |      2,678        2.39       88.87
 auntuncle_or_parent |      2,064        1.85       90.72
             stepdad |      1,742        1.56       92.28
child_or_nephewniece |      1,407        1.26       93.54
             stepmom |      1,142        1.02       94.56
   sibling_or_cousin |        941        0.84       95.40
              parent |        862        0.77       96.17
           auntuncle |        857        0.77       96.93
               child |        769        0.69       97.62
         nephewniece |        742        0.66       98.29
         other_rel_p |        432        0.39       98.67
               f_sib |        270        0.24       98.91
            f_parent |        228        0.20       99.12
          adoptchild |        205        0.18       99.30
             f_child |        192        0.17       99.47
            adoptdad |        110        0.10       99.57
            adoptmom |        102        0.09       99.66
       grandparent_p |         97        0.09       99.75
    greatgrandparent |         82        0.07       99.82
        grandchild_p |         78        0.07       99.89
                   . |         62        0.06       99.95
     greatgrandchild |         55        0.05      100.00
                 mom |          3        0.00      100.00
                 dad |          1        0.00      100.00
---------------------+-----------------------------------
               Total |    111,840      100.00

. save "$tempdir/arriver_rels", $replace
(note: file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/arriver_rels.dta not found)
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/arriver_rels.dta saved

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. foreach changer in leaver arriver {
  2.         clear
  3.     display "Processing `changer's"
  4.         
.         use "$tempdir/`changer'_rels"
  5. 
.     rename adj_age from_age
  6. 
.         drop epppnum
  7.         
.         * get changer age *
.     gen epppnum = relto
  8.     merge m:1 ssuid epppnum swave using "$tempdir/demo_long_all", keepusing(adj_age)
  9.     drop if (_merge == 2)
 10.     assert (_merge == 3)
 11.         
.     drop _merge
 12.     drop epppnum
 13.     rename adj_age to_age
 14.         
.         * bring back ego's person number
.         rename relfrom epppnum
 15.         
.         save "$tempdir/`changer'_rels_withage", $replace
 16. }    
Processing leavers
key variable epppnum is float in master but str4 in using data
    Each key variable -- the variables on which observations are matched -- must be of the same generic type in the master and using datasets.  Same generic type means both numeric or both string.
r(106);

end of do-file

r(106);

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. foreach changer in leaver arriver {
  2.         clear
  3.     display "Processing `changer's"
  4.         
.         use "$tempdir/`changer'_rels"
  5. 
.     rename adj_age from_age
  6. 
.         drop epppnum
  7.         
.         * get changer age *
.     gen epppnum = string(relto)
  8.     merge m:1 ssuid epppnum swave using "$tempdir/demo_long_all", keepusing(adj_age)
  9.     drop if (_merge == 2)
 10.     assert (_merge == 3)
 11.         
.     drop _merge
 12.     drop epppnum
 13.     rename adj_age to_age
 14.         
.         * bring back ego's person number
.         rename relfrom epppnum
 15.         
.         save "$tempdir/`changer'_rels_withage", $replace
 16. }    
Processing leavers

    Result                           # of obs.
    -----------------------------------------
    not matched                     2,070,244
        from master                   109,881  (_merge==1)
        from using                  1,960,363  (_merge==2)

    matched                             4,800  (_merge==3)
    -----------------------------------------
(1,960,363 observations deleted)
109,881 contradictions in 114,681 observations
assertion is false
r(9);

end of do-file

r(9);

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. gen change_type=1

. 
. append using "$tempdir/leaver_rels_withage"
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/leaver_rels_withage not found
r(601);

end of do-file

r(601);

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. foreach changer in leaver arriver {
  2.         clear
  3.     display "Processing `changer's"
  4.         
.         use "$tempdir/`changer'_rels"
  5. 
.     rename adj_age from_age
  6. 
.         drop epppnum
  7.         
.         * get changer age *
.     gen epppnum = string(relto)
  8.     merge m:1 ssuid epppnum swave using "$tempdir/demo_long_all", keepusing(adj_age)
  9.     drop if (_merge == 2)
 10.     assert (_merge == 3)
 11.         
.     drop _merge
 12.     drop epppnum
 13.     rename adj_age to_age
 14.         
.         * bring back ego's person number
.         rename relfrom epppnum
 15.         
.         save "$tempdir/`changer'_rels_withage", $replace
 16. }    
Processing leavers

    Result                           # of obs.
    -----------------------------------------
    not matched                     2,070,244
        from master                   109,881  (_merge==1)
        from using                  1,960,363  (_merge==2)

    matched                             4,800  (_merge==3)
    -----------------------------------------
(1,960,363 observations deleted)
109,881 contradictions in 114,681 observations
assertion is false
r(9);

end of do-file

r(9);

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. use "$tempdir/hh_leavers", clear

. drop if missing(leaver)
(0 observations deleted)

. gen relfrom = real(epppnum)

. destring leaver, gen(relto)
leaver: all characters numeric; relto generated as int

. merge 1:1 ssuid relfrom relto swave using "$tempdir/relationship_pairs_bywave", keepusing(relationship)
(note: variable relto was int, now float to accommodate using data's values)

    Result                           # of obs.
    -----------------------------------------
    not matched                     2,968,011
        from master                       119  (_merge==1)
        from using                  2,967,892  (_merge==2)

    matched                           114,562  (_merge==3)
    -----------------------------------------

.         
. display "deleting relationships to self"
deleting relationships to self

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. drop if relfrom==real(relto)
type mismatch
r(109);

end of do-file

r(109);

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. drop if relfrom==relto
(0 observations deleted)

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. replace relationship=40 if _merge==1
(119 real changes made)

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. drop if _merge == 2
(2,967,892 observations deleted)

. drop _merge

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. display "Relationships for leavers"
Relationships for leavers

. tab relationship, m sort

        relationship |      Freq.     Percent        Cum.
---------------------+-----------------------------------
           other_rel |     18,754       16.35       16.35
               norel |     16,463       14.36       30.71
             sibling |     15,067       13.14       43.85
            biochild |     13,211       11.52       55.37
              biomom |      7,286        6.35       61.72
              spouse |      6,375        5.56       67.28
              biodad |      5,935        5.18       72.45
         grandparent |      5,198        4.53       76.99
          grandchild |      5,189        4.52       81.51
           stepchild |      2,974        2.59       84.10
            dontknow |      2,643        2.30       86.41
             partner |      2,541        2.22       88.62
child_or_nephewniece |      1,915        1.67       90.29
 auntuncle_or_parent |      1,907        1.66       91.96
             stepdad |      1,844        1.61       93.57
   sibling_or_cousin |      1,148        1.00       94.57
             stepmom |      1,134        0.99       95.56
           auntuncle |        830        0.72       96.28
         nephewniece |        825        0.72       97.00
              parent |        615        0.54       97.53
               child |        613        0.53       98.07
         other_rel_p |        467        0.41       98.48
          adoptchild |        315        0.27       98.75
               f_sib |        277        0.24       98.99
            f_parent |        222        0.19       99.19
             f_child |        200        0.17       99.36
            adoptdad |        169        0.15       99.51
            adoptmom |        147        0.13       99.64
       grandparent_p |         99        0.09       99.72
        grandchild_p |         98        0.09       99.81
                   . |         84        0.07       99.88
    greatgrandparent |         68        0.06       99.94
     greatgrandchild |         67        0.06      100.00
                 mom |          1        0.00      100.00
---------------------+-----------------------------------
               Total |    114,681      100.00

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. save "$tempdir/leaver_rels", $replace
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/leaver_rels.dta saved

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. use "$tempdir/hh_arrivers", clear

. 
. * We link to relationship in next wave, since they aren't together in this wave
. replace swave=swave+1
(111,840 real changes made)

. drop if missing(arriver)
(0 observations deleted)

. gen relfrom = real(epppnum)

. destring arriver, gen(relto)
arriver: all characters numeric; relto generated as int

. merge 1:1 ssuid relfrom relto swave using "$tempdir/relationship_pairs_bywave", keepusing(relationship)
(note: variable relto was int, now float to accommodate using data's values)

    Result                           # of obs.
    -----------------------------------------
    not matched                     2,986,000
        from master                     7,693  (_merge==1)
        from using                  2,978,307  (_merge==2)

    matched                           104,147  (_merge==3)
    -----------------------------------------

. 
. * return swave to its original value. (Yiwen, this is the silly error I made 
. * that broke the code. I forgot to put swave back to its original value).       
. replace swave=swave-1
(3,090,147 real changes made)

. 
. display "deleting relationships to self"
deleting relationships to self

. drop if relfrom==relto
(0 observations deleted)

. 
. replace relationship=40 if _merge==1
(7,693 real changes made)

. 
. drop if _merge == 2
(2,978,307 observations deleted)

. drop _merge

. 
. display "Relationships for arrivers"
Relationships for arrivers

. tab relationship, m sort

        relationship |      Freq.     Percent        Cum.
---------------------+-----------------------------------
           other_rel |     15,714       14.05       14.05
               norel |     15,584       13.93       27.98
             sibling |     13,281       11.88       39.86
            dontknow |      9,896        8.85       48.71
            biochild |      9,381        8.39       57.10
              biomom |      8,642        7.73       64.82
              biodad |      6,610        5.91       70.73
         grandparent |      5,571        4.98       75.71
          grandchild |      4,488        4.01       79.73
              spouse |      3,999        3.58       83.30
             partner |      3,553        3.18       86.48
           stepchild |      2,678        2.39       88.87
 auntuncle_or_parent |      2,064        1.85       90.72
             stepdad |      1,742        1.56       92.28
child_or_nephewniece |      1,407        1.26       93.54
             stepmom |      1,142        1.02       94.56
   sibling_or_cousin |        941        0.84       95.40
              parent |        862        0.77       96.17
           auntuncle |        857        0.77       96.93
               child |        769        0.69       97.62
         nephewniece |        742        0.66       98.29
         other_rel_p |        432        0.39       98.67
               f_sib |        270        0.24       98.91
            f_parent |        228        0.20       99.12
          adoptchild |        205        0.18       99.30
             f_child |        192        0.17       99.47
            adoptdad |        110        0.10       99.57
            adoptmom |        102        0.09       99.66
       grandparent_p |         97        0.09       99.75
    greatgrandparent |         82        0.07       99.82
        grandchild_p |         78        0.07       99.89
                   . |         62        0.06       99.95
     greatgrandchild |         55        0.05      100.00
                 mom |          3        0.00      100.00
                 dad |          1        0.00      100.00
---------------------+-----------------------------------
               Total |    111,840      100.00

. save "$tempdir/arriver_rels", $replace
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/arriver_rels.dta saved

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

.     rename adj_age from_age

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

.         drop epppnum

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

.     gen epppnum = string(relto)

.     merge m:1 ssuid epppnum swave using "$tempdir/demo_long_all", keepusing(adj_age)

    Result                           # of obs.
    -----------------------------------------
    not matched                     2,048,734
        from master                    93,910  (_merge==1)
        from using                  1,954,824  (_merge==2)

    matched                            17,930  (_merge==3)
    -----------------------------------------

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

.     drop if (_merge == 2)
(1,954,824 observations deleted)

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

.     assert (_merge == 3)
93,910 contradictions in 111,840 observations
assertion is false
r(9);

end of do-file

r(9);

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. foreach changer in leaver arriver {
  2.         clear
  3.     display "Processing `changer's"
  4.         
.         use "$tempdir/`changer'_rels"
  5. 
.     rename adj_age from_age
  6. 
.         drop epppnum
  7.         
.         * get changer age *
.     gen epppnum = string(relto)
  8.     merge m:1 ssuid epppnum swave using "$tempdir/demo_long_all", keepusing(adj_age)
  9.     drop if (_merge == 2)
 10.     keep if merge== 3 /*assert (_merge == 3) THIS ISN'T WORKING */
 11.         
.     drop _merge
 12.     drop epppnum
 13.     rename adj_age to_age
 14.         
.         * bring back ego's person number
.         rename relfrom epppnum
 15.         
.         save "$tempdir/`changer'_rels_withage", $replace
 16. }    
Processing leavers

    Result                           # of obs.
    -----------------------------------------
    not matched                     2,070,244
        from master                   109,881  (_merge==1)
        from using                  1,960,363  (_merge==2)

    matched                             4,800  (_merge==3)
    -----------------------------------------
(1,960,363 observations deleted)
merge not found
r(111);

end of do-file

r(111);

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. use "$tempdir/hh_leavers", clear

. drop if missing(leaver)
(0 observations deleted)

. gen relfrom = real(epppnum)

. destring leaver, gen(relto)
leaver: all characters numeric; relto generated as int

. merge 1:1 ssuid relfrom relto swave using "$tempdir/relationship_pairs_bywave", keepusing(relationship)
(note: variable relto was int, now float to accommodate using data's values)

    Result                           # of obs.
    -----------------------------------------
    not matched                     2,968,011
        from master                       119  (_merge==1)
        from using                  2,967,892  (_merge==2)

    matched                           114,562  (_merge==3)
    -----------------------------------------

.         
. display "deleting relationships to self"
deleting relationships to self

. drop if relfrom==relto
(0 observations deleted)

. 
. replace relationship=40 if _merge==1
(119 real changes made)

. 
. drop if _merge == 2
(2,967,892 observations deleted)

. drop _merge

. 
. display "Relationships for leavers"
Relationships for leavers

. tab relationship, m sort

        relationship |      Freq.     Percent        Cum.
---------------------+-----------------------------------
           other_rel |     18,754       16.35       16.35
               norel |     16,463       14.36       30.71
             sibling |     15,067       13.14       43.85
            biochild |     13,211       11.52       55.37
              biomom |      7,286        6.35       61.72
              spouse |      6,375        5.56       67.28
              biodad |      5,935        5.18       72.45
         grandparent |      5,198        4.53       76.99
          grandchild |      5,189        4.52       81.51
           stepchild |      2,974        2.59       84.10
            dontknow |      2,643        2.30       86.41
             partner |      2,541        2.22       88.62
child_or_nephewniece |      1,915        1.67       90.29
 auntuncle_or_parent |      1,907        1.66       91.96
             stepdad |      1,844        1.61       93.57
   sibling_or_cousin |      1,148        1.00       94.57
             stepmom |      1,134        0.99       95.56
           auntuncle |        830        0.72       96.28
         nephewniece |        825        0.72       97.00
              parent |        615        0.54       97.53
               child |        613        0.53       98.07
         other_rel_p |        467        0.41       98.48
          adoptchild |        315        0.27       98.75
               f_sib |        277        0.24       98.99
            f_parent |        222        0.19       99.19
             f_child |        200        0.17       99.36
            adoptdad |        169        0.15       99.51
            adoptmom |        147        0.13       99.64
       grandparent_p |         99        0.09       99.72
        grandchild_p |         98        0.09       99.81
                   . |         84        0.07       99.88
    greatgrandparent |         68        0.06       99.94
     greatgrandchild |         67        0.06      100.00
                 mom |          1        0.00      100.00
---------------------+-----------------------------------
               Total |    114,681      100.00

. save "$tempdir/leaver_rels", $replace
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/leaver_rels.dta saved

. 
. ********************************************************************************
. * Section: Linking those who arrive to relationships
. *          We have to link in wave+n because they aren't with ego in the current 
. *          wave else they wouldn't be arrivers 
. ********************************************************************************
. 
. use "$tempdir/hh_arrivers", clear

. 
. * We link to relationship in next wave, since they aren't together in this wave
. replace swave=swave+1
(111,840 real changes made)

. drop if missing(arriver)
(0 observations deleted)

. gen relfrom = real(epppnum)

. destring arriver, gen(relto)
arriver: all characters numeric; relto generated as int

. merge 1:1 ssuid relfrom relto swave using "$tempdir/relationship_pairs_bywave", keepusing(relationship)
(note: variable relto was int, now float to accommodate using data's values)

    Result                           # of obs.
    -----------------------------------------
    not matched                     2,986,000
        from master                     7,693  (_merge==1)
        from using                  2,978,307  (_merge==2)

    matched                           104,147  (_merge==3)
    -----------------------------------------

. 
. * return swave to its original value. (Yiwen, this is the silly error I made 
. * that broke the code. I forgot to put swave back to its original value).       
. replace swave=swave-1
(3,090,147 real changes made)

. 
. display "deleting relationships to self"
deleting relationships to self

. drop if relfrom==relto
(0 observations deleted)

. 
. replace relationship=40 if _merge==1
(7,693 real changes made)

. 
. drop if _merge == 2
(2,978,307 observations deleted)

. drop _merge

. 
. display "Relationships for arrivers"
Relationships for arrivers

. tab relationship, m sort

        relationship |      Freq.     Percent        Cum.
---------------------+-----------------------------------
           other_rel |     15,714       14.05       14.05
               norel |     15,584       13.93       27.98
             sibling |     13,281       11.88       39.86
            dontknow |      9,896        8.85       48.71
            biochild |      9,381        8.39       57.10
              biomom |      8,642        7.73       64.82
              biodad |      6,610        5.91       70.73
         grandparent |      5,571        4.98       75.71
          grandchild |      4,488        4.01       79.73
              spouse |      3,999        3.58       83.30
             partner |      3,553        3.18       86.48
           stepchild |      2,678        2.39       88.87
 auntuncle_or_parent |      2,064        1.85       90.72
             stepdad |      1,742        1.56       92.28
child_or_nephewniece |      1,407        1.26       93.54
             stepmom |      1,142        1.02       94.56
   sibling_or_cousin |        941        0.84       95.40
              parent |        862        0.77       96.17
           auntuncle |        857        0.77       96.93
               child |        769        0.69       97.62
         nephewniece |        742        0.66       98.29
         other_rel_p |        432        0.39       98.67
               f_sib |        270        0.24       98.91
            f_parent |        228        0.20       99.12
          adoptchild |        205        0.18       99.30
             f_child |        192        0.17       99.47
            adoptdad |        110        0.10       99.57
            adoptmom |        102        0.09       99.66
       grandparent_p |         97        0.09       99.75
    greatgrandparent |         82        0.07       99.82
        grandchild_p |         78        0.07       99.89
                   . |         62        0.06       99.95
     greatgrandchild |         55        0.05      100.00
                 mom |          3        0.00      100.00
                 dad |          1        0.00      100.00
---------------------+-----------------------------------
               Total |    111,840      100.00

. save "$tempdir/arriver_rels", $replace
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/arriver_rels.dta saved

. 
. ********************************************************************************
. * Section: getting the age of each person so that we can calculate an age difference
. ********************************************************************************
. foreach changer in leaver arriver {
  2.         clear
  3.     display "Processing `changer's"
  4.         
.         use "$tempdir/`changer'_rels"
  5. 
.     rename adj_age from_age
  6. 
.         drop epppnum
  7.         
.         * get changer age *
.     gen epppnum = string(relto)
  8.     merge m:1 ssuid epppnum swave using "$tempdir/demo_long_all", keepusing(adj_age)
  9.     drop if (_merge == 2)
 10.     keep if merge== 3 /*assert (_merge == 3) THIS ISN'T WORKING */
 11.         
.     drop _merge
 12.     drop epppnum
 13.     rename adj_age to_age
 14.         
.         * bring back ego's person number
.         rename relfrom epppnum
 15.         
.         save "$tempdir/`changer'_rels_withage", $replace
 16. }    
Processing leavers

    Result                           # of obs.
    -----------------------------------------
    not matched                     2,070,244
        from master                   109,881  (_merge==1)
        from using                  1,960,363  (_merge==2)

    matched                             4,800  (_merge==3)
    -----------------------------------------
(1,960,363 observations deleted)
merge not found
r(111);

end of do-file

r(111);

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. foreach changer in leaver arriver {
  2.         clear
  3.     display "Processing `changer's"
  4.         
.         use "$tempdir/`changer'_rels"
  5. 
.     rename adj_age from_age
  6. 
.         drop epppnum
  7.         
.         * get changer age *
.     gen epppnum = string(relto)
  8.     merge m:1 ssuid epppnum swave using "$tempdir/demo_long_all", keepusing(adj_age)
  9.     drop if (_merge == 2)
 10.     keep if _merge== 3 /*assert (_merge == 3) THIS ISN'T WORKING */
 11.         
.     drop _merge
 12.     drop epppnum
 13.     rename adj_age to_age
 14.         
.         * bring back ego's person number
.         rename relfrom epppnum
 15.         
.         save "$tempdir/`changer'_rels_withage", $replace
 16. }    
Processing leavers

    Result                           # of obs.
    -----------------------------------------
    not matched                     2,070,244
        from master                   109,881  (_merge==1)
        from using                  1,960,363  (_merge==2)

    matched                             4,800  (_merge==3)
    -----------------------------------------
(1,960,363 observations deleted)
(109,881 observations deleted)
(note: file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/leaver_rels_withage.dta not found)
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/leaver_rels_withage.dta saved
Processing arrivers

    Result                           # of obs.
    -----------------------------------------
    not matched                     2,048,734
        from master                    93,910  (_merge==1)
        from using                  1,954,824  (_merge==2)

    matched                            17,930  (_merge==3)
    -----------------------------------------
(1,954,824 observations deleted)
(93,910 observations deleted)
(note: file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/arriver_rels_withage.dta not found)
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/arriver_rels_withage.dta saved

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. gen change_type=1

. 
. append using "$tempdir/leaver_rels_withage"
(label relationship already defined)

. replace change_type=2 if missing(change_type)
(4,800 real changes made)

. 
. label variable change_type "Indicator for whether this person arrive in or left from ego's household"

. label define change_type 1 "arriver" 2 "leaver" 

. 
. label values change_type change_type 

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. do "$sipp2008_code/simple_rel_label"

. 
. *** Define the label for our compact representation of relationships.
. capture label drop ultra_simple_rel

. local lnum = 1

. local llist ""

. foreach r in CHILD SIBLING GRANDCHILD OTHER_ADULT OTHER_CHILD {
  2.     local llist = `"`llist' `lnum' "`r'""'
  3.     local lnum = `lnum' + 1
  4. }

. label define ultra_simple_rel `llist'

. 
. 
end of do-file

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. gen bioparent=1 if relationship==1
(22,113 missing values generated)

. gen parent=1 if inlist(relationship,1,4,7,19,21)
(21,504 missing values generated)

. gen sibling=1 if inlist(relationship,17)
(20,259 missing values generated)

. gen child=1 if inlist(relationship,2,3,5,6,8,9,10,11,23)
(18,624 missing values generated)

. gen spartner=1 if inlist(relationship,12,18)
(21,589 missing values generated)

. gen nonrel=1 if inlist(relationship,20,22,34,37,38,40)
(15,799 missing values generated)

. gen foster=1 if inlist(relationship,20,22,34,38)
(22,632 missing values generated)

. gen grandparent=1 if inlist(relationship,13,14,27)
(22,121 missing values generated)

. gen other_rel=1 if inlist(relationship, 15,16,24,25,26,28,29,30,31,33,32,35,36) //not parents, siblings, children, spouses, or grandparents
(16,496 missing values generated)

. gen unknown=1 if relationship==40 | missing(relationship)
(19,232 missing values generated)

. gen nonnuke=1 if nonrel==1 | grandparent==1 | other_rel==1 | unknown==1
(8,944 missing values generated)

. gen allelse=1 if inlist(relationship,2,3,5,6,8,9,10,11,23,12,18) // children, spouses
(17,483 missing values generated)

. 
. gen adult_arrive=1 if change_type==1 & to_age >= $adult_age
(13,852 missing values generated)

. gen adult_leave=1 if change_type==2 & to_age >= $adult_age
(19,511 missing values generated)

. 
. *create variables for parent_arrive and parent_leave
. gen parent_arrive=1 if change_type==1 & parent==1
(21,844 missing values generated)

. gen parent_leave=1 if change_type==2 & parent==1
(22,390 missing values generated)

. 
. save "$tempdir/changer_rels", $replace
(note: file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/changer_rels.dta not found)
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/changer_rels.dta saved

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. //====================================================================//
. //===== Children's Household Instability Project                    
. //===== Dataset: SIPP2008                                           
. //===== Purpose: This code merges a file with information on the relationship
. //                 of household members who arrive or leave in the next wave                
. //               to comp_change hh_change and addr_change. And then collapses
. //               to an individual data file with dummy indicators of whether 
. //               ego saw anyone leave, anyone arrive, a parent leave or arrive,
. //               a sibling leave or arrive, anyone else leave or arrive.
. //=====================================================================//
. 
. * hh_change has one record per person per wave
. use "$SIPP08keep/hh_change.dta"

. 
. keep ssuid epppnum swave comp_change hh_change addr_change 

. 
. * changer_rels.dta has one record for every person arriving or leaving ego's 
. * household between this wave and the next. There may be records for both 
. * arrivers and leavers. An "arriver" might be someone that ego moves in with
. * or someone who moves in with ego. Analogously, a leaver could be someone ego
. * leaves ego's household or someone who ego leaves behind when she leaves.   
. 
. * changer_rels includes no records for individuals who experienced no composition change in the wave
. * we get these records from hh_change.dta. Thus any variable we pull in with "changer_rels" is missing for everyone
. * who did not experience a composition change. For example, adult_arrive is missing for everyone with comp_change==0
. merge 1:m ssuid epppnum swave using "$tempdir/changer_rels", keepusing(relationship parent sibling grandparent nonrel other_rel foster allelse adult_arrive adult_leave parent_arrive parent_leave ch
> ange_type)
key variable epppnum is str4 in master but float in using data
    Each key variable -- the variables on which observations are matched -- must be of the same generic type in the master and using datasets.  Same generic type means both numeric or both string.
r(106);

end of do-file

r(106);

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. use "$SIPP08keep/hh_change.dta"
no; data in memory would be lost
r(4);

end of do-file

r(4);

. clear

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. use "$SIPP08keep/hh_change.dta"

. 
. keep ssuid epppnum swave comp_change hh_change addr_change 

. gen epppnum_n = real(epppnum)

. drop epppnum

. rename epppnum_n epppnum

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. merge 1:m ssuid epppnum swave using "$tempdir/changer_rels", keepusing(relationship parent sibling grandparent nonrel other_rel foster allelse adult_arrive adult_leave parent_arrive parent_leave ch
> ange_type)

    Result                           # of obs.
    -----------------------------------------
    not matched                     1,946,170
        from master                 1,946,170  (_merge==1)
        from using                          0  (_merge==2)

    matched                            22,730  (_merge==3)
    -----------------------------------------

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. assert _merge==3 if comp_change==1
110,826 contradictions in 133,556 observations
assertion is false
r(9);

end of do-file

r(9);

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. //==============================================================================
. //===== Children's Household Instability Project
. //===== Dataset: SIPP2008
. //===== Purpose:  Link individuals identified as entering, leaving, or staying in
. //===== a person's (ego's) household to their relationship to ego.
. //==============================================================================
. 
. use "$SIPP08keep/comp_change.dta", clear

. 
. keep ssuid epppnum shhadid* arrivers* leavers* stayers* comp_change* comp_change_reason* adj_age* 

. 
. reshape long shhadid adj_age arrivers leavers stayers comp_change comp_change_reason, i(ssuid epppnum) j(swave)
(note: j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15)
(note: arrivers15 not found)
(note: leavers15 not found)
(note: stayers15 not found)
(note: comp_change15 not found)
(note: comp_change_reason15 not found)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                   130851   -> 2.0e+06
Number of variables                 117   ->      25
j variable (15 values)                    ->   swave
xij variables:
        shhadid1 shhadid2 ... shhadid15   ->   shhadid
        adj_age1 adj_age2 ... adj_age15   ->   adj_age
     arrivers1 arrivers2 ... arrivers15   ->   arrivers
        leavers1 leavers2 ... leavers15   ->   leavers
        stayers1 stayers2 ... stayers15   ->   stayers
comp_change1 comp_change2 ... comp_change15->  comp_change
comp_change_reason1 comp_change_reason2 ... comp_change_reason15->comp_change_reason
-----------------------------------------------------------------------------

. 
. gen have_arrivers = (indexnot(arrivers, " ") != 0)

. gen have_leavers = (indexnot(leavers, " ") != 0)

. 
. gen have_changers = (have_arrivers | have_leavers)

. 
. tab comp_change have_changers

comp_chang |     have_changers
         e |         0          1 |     Total
-----------+----------------------+----------
         0 | 1,060,888          0 | 1,060,888 
         1 |         0    127,421 |   127,421 
-----------+----------------------+----------
     Total | 1,060,888    127,421 | 1,188,309 

. 
. assert (have_changers == 0) if (comp_change == 0)

. assert (have_changers == 0) if missing(comp_change)

. assert (have_changers == 1) if (comp_change == 1)

. 
. drop if missing(comp_change)
(774,456 observations deleted)

. 
. drop if (comp_change == 0)
(1,060,888 observations deleted)

. 
. save "$tempdir/comp_change_onlychangers", $replace
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/comp_change_onlychangers.dta saved

. 
. ********************************************************************************
. * Section: create long file where each record is a person who started or stopped
. *          living with ego (and stayed living with ego).
. ********************************************************************************
. 
. foreach changer in leaver arriver stayer {
  2.     clear
  3. 
.     use "$tempdir/comp_change_onlychangers"
  4. 
.     * Compute max number of leavers/arrivers.
.     gen n_`changer's = wordcount(`changer's)
  5.     egen max_`changer's = max(n_`changer's)
  6. 
.     forvalues my_`changer'_num = 1/`=max_`changer's' {
  7.         gen `changer'`my_`changer'_num' = word(`changer's, `my_`changer'_num')
  8.     }
  9.     drop `changer's max_`changer's
 10. 
.     keep ssuid epppnum shhadid swave adj_age comp_change_reason n_`changer's `changer'* 
 11. 
.     reshape long `changer', i(ssuid epppnum swave) j(`changer'_num)
 12. 
.     drop if missing(`changer')
 13. 
.     save "$tempdir/hh_`changer's", $replace
 14. }
(62,346 missing values generated)
(102,220 missing values generated)
(114,567 missing values generated)
(120,941 missing values generated)
(124,527 missing values generated)
(126,176 missing values generated)
(126,897 missing values generated)
(127,202 missing values generated)
(127,320 missing values generated)
(127,382 missing values generated)
(127,397 missing values generated)
(127,407 missing values generated)
(127,410 missing values generated)
(note: j = 1 2 3 4 5 6 7 8 9 10 11 12 13)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                   127421   -> 1.7e+06
Number of variables                  20   ->       9
j variable (13 values)                    ->   leaver_num
xij variables:
           leaver1 leaver2 ... leaver13   ->   leaver
-----------------------------------------------------------------------------
(1,541,792 observations deleted)
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/hh_leavers.dta saved
(57,911 missing values generated)
(104,759 missing values generated)
(116,871 missing values generated)
(122,224 missing values generated)
(125,114 missing values generated)
(126,436 missing values generated)
(127,049 missing values generated)
(127,257 missing values generated)
(127,351 missing values generated)
(127,406 missing values generated)
(127,415 missing values generated)
(127,420 missing values generated)
(127,420 missing values generated)
(note: j = 1 2 3 4 5 6 7 8 9 10 11 12 13)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                   127421   -> 1.7e+06
Number of variables                  20   ->       9
j variable (13 values)                    ->   arriver_num
xij variables:
        arriver1 arriver2 ... arriver13   ->   arriver
-----------------------------------------------------------------------------
(1,544,633 observations deleted)
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/hh_arrivers.dta saved
(43,180 missing values generated)
(57,331 missing values generated)
(75,849 missing values generated)
(94,659 missing values generated)
(109,427 missing values generated)
(118,412 missing values generated)
(123,056 missing values generated)
(125,233 missing values generated)
(126,313 missing values generated)
(126,943 missing values generated)
(127,143 missing values generated)
(127,297 missing values generated)
(127,369 missing values generated)
(note: j = 1 2 3 4 5 6 7 8 9 10 11 12 13)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                   127421   -> 1.7e+06
Number of variables                  20   ->       9
j variable (13 values)                    ->   stayer_num
xij variables:
           stayer1 stayer2 ... stayer13   ->   stayer
-----------------------------------------------------------------------------
(1,382,212 observations deleted)
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/hh_stayers.dta saved

. 
. ********************************************************************************
. * Section: Linking those who leave to relationships in that wave
. ********************************************************************************
. 
. use "$tempdir/hh_leavers", clear

. drop if missing(leaver)
(0 observations deleted)

. gen relfrom = real(epppnum)

. destring leaver, gen(relto)
leaver: all characters numeric; relto generated as int

. merge 1:1 ssuid relfrom relto swave using "$tempdir/relationship_pairs_bywave", keepusing(relationship)
(note: variable relto was int, now float to accommodate using data's values)

    Result                           # of obs.
    -----------------------------------------
    not matched                     2,968,011
        from master                       119  (_merge==1)
        from using                  2,967,892  (_merge==2)

    matched                           114,562  (_merge==3)
    -----------------------------------------

.         
. display "deleting relationships to self"
deleting relationships to self

. drop if relfrom==relto
(0 observations deleted)

. 
. replace relationship=40 if _merge==1
(119 real changes made)

. 
. drop if _merge == 2
(2,967,892 observations deleted)

. drop _merge

. 
. display "Relationships for leavers"
Relationships for leavers

. tab relationship, m sort

        relationship |      Freq.     Percent        Cum.
---------------------+-----------------------------------
           other_rel |     18,754       16.35       16.35
               norel |     16,463       14.36       30.71
             sibling |     15,067       13.14       43.85
            biochild |     13,211       11.52       55.37
              biomom |      7,286        6.35       61.72
              spouse |      6,375        5.56       67.28
              biodad |      5,935        5.18       72.45
         grandparent |      5,198        4.53       76.99
          grandchild |      5,189        4.52       81.51
           stepchild |      2,974        2.59       84.10
            dontknow |      2,643        2.30       86.41
             partner |      2,541        2.22       88.62
child_or_nephewniece |      1,915        1.67       90.29
 auntuncle_or_parent |      1,907        1.66       91.96
             stepdad |      1,844        1.61       93.57
   sibling_or_cousin |      1,148        1.00       94.57
             stepmom |      1,134        0.99       95.56
           auntuncle |        830        0.72       96.28
         nephewniece |        825        0.72       97.00
              parent |        615        0.54       97.53
               child |        613        0.53       98.07
         other_rel_p |        467        0.41       98.48
          adoptchild |        315        0.27       98.75
               f_sib |        277        0.24       98.99
            f_parent |        222        0.19       99.19
             f_child |        200        0.17       99.36
            adoptdad |        169        0.15       99.51
            adoptmom |        147        0.13       99.64
       grandparent_p |         99        0.09       99.72
        grandchild_p |         98        0.09       99.81
                   . |         84        0.07       99.88
    greatgrandparent |         68        0.06       99.94
     greatgrandchild |         67        0.06      100.00
                 mom |          1        0.00      100.00
---------------------+-----------------------------------
               Total |    114,681      100.00

. save "$tempdir/leaver_rels", $replace
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/leaver_rels.dta saved

. 
. ********************************************************************************
. * Section: Linking those who arrive to relationships
. *          We have to link in wave+n because they aren't with ego in the current 
. *          wave else they wouldn't be arrivers 
. ********************************************************************************
. 
. use "$tempdir/hh_arrivers", clear

. 
. * We link to relationship in next wave, since they aren't together in this wave
. replace swave=swave+1
(111,840 real changes made)

. drop if missing(arriver)
(0 observations deleted)

. gen relfrom = real(epppnum)

. destring arriver, gen(relto)
arriver: all characters numeric; relto generated as int

. merge 1:1 ssuid relfrom relto swave using "$tempdir/relationship_pairs_bywave", keepusing(relationship)
(note: variable relto was int, now float to accommodate using data's values)

    Result                           # of obs.
    -----------------------------------------
    not matched                     2,986,000
        from master                     7,693  (_merge==1)
        from using                  2,978,307  (_merge==2)

    matched                           104,147  (_merge==3)
    -----------------------------------------

. 
. * return swave to its original value. (Yiwen, this is the silly error I made 
. * that broke the code. I forgot to put swave back to its original value).       
. replace swave=swave-1
(3,090,147 real changes made)

. 
. display "deleting relationships to self"
deleting relationships to self

. drop if relfrom==relto
(0 observations deleted)

. 
. replace relationship=40 if _merge==1
(7,693 real changes made)

. 
. drop if _merge == 2
(2,978,307 observations deleted)

. drop _merge

. 
. display "Relationships for arrivers"
Relationships for arrivers

. tab relationship, m sort

        relationship |      Freq.     Percent        Cum.
---------------------+-----------------------------------
           other_rel |     15,714       14.05       14.05
               norel |     15,584       13.93       27.98
             sibling |     13,281       11.88       39.86
            dontknow |      9,896        8.85       48.71
            biochild |      9,381        8.39       57.10
              biomom |      8,642        7.73       64.82
              biodad |      6,610        5.91       70.73
         grandparent |      5,571        4.98       75.71
          grandchild |      4,488        4.01       79.73
              spouse |      3,999        3.58       83.30
             partner |      3,553        3.18       86.48
           stepchild |      2,678        2.39       88.87
 auntuncle_or_parent |      2,064        1.85       90.72
             stepdad |      1,742        1.56       92.28
child_or_nephewniece |      1,407        1.26       93.54
             stepmom |      1,142        1.02       94.56
   sibling_or_cousin |        941        0.84       95.40
              parent |        862        0.77       96.17
           auntuncle |        857        0.77       96.93
               child |        769        0.69       97.62
         nephewniece |        742        0.66       98.29
         other_rel_p |        432        0.39       98.67
               f_sib |        270        0.24       98.91
            f_parent |        228        0.20       99.12
          adoptchild |        205        0.18       99.30
             f_child |        192        0.17       99.47
            adoptdad |        110        0.10       99.57
            adoptmom |        102        0.09       99.66
       grandparent_p |         97        0.09       99.75
    greatgrandparent |         82        0.07       99.82
        grandchild_p |         78        0.07       99.89
                   . |         62        0.06       99.95
     greatgrandchild |         55        0.05      100.00
                 mom |          3        0.00      100.00
                 dad |          1        0.00      100.00
---------------------+-----------------------------------
               Total |    111,840      100.00

. save "$tempdir/arriver_rels", $replace
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/arriver_rels.dta saved

. 
end of do-file

. tab relationship

        relationship |      Freq.     Percent        Cum.
---------------------+-----------------------------------
            biochild |      9,381        8.39        8.39
              biomom |      8,642        7.73       16.12
              biodad |      6,610        5.91       22.04
           stepchild |      2,678        2.40       24.43
             stepmom |      1,142        1.02       25.45
             stepdad |      1,742        1.56       27.01
          adoptchild |        205        0.18       27.20
            adoptmom |        102        0.09       27.29
            adoptdad |        110        0.10       27.39
                 mom |          3        0.00       27.39
                 dad |          1        0.00       27.39
              spouse |      3,999        3.58       30.97
          grandchild |      4,488        4.02       34.98
        grandchild_p |         78        0.07       35.05
         grandparent |      5,571        4.98       40.04
       grandparent_p |         97        0.09       40.12
             sibling |     13,281       11.88       52.00
             partner |      3,553        3.18       55.18
             f_child |        192        0.17       55.36
               child |        769        0.69       56.04
            f_parent |        228        0.20       56.25
              parent |        862        0.77       57.02
           auntuncle |        857        0.77       57.79
 auntuncle_or_parent |      2,064        1.85       59.63
     greatgrandchild |         55        0.05       59.68
    greatgrandparent |         82        0.07       59.75
         nephewniece |        742        0.66       60.42
child_or_nephewniece |      1,407        1.26       61.68
   sibling_or_cousin |        941        0.84       62.52
               f_sib |        270        0.24       62.76
           other_rel |     15,714       14.06       76.82
         other_rel_p |        432        0.39       77.20
               norel |     15,584       13.94       91.15
            dontknow |      9,896        8.85      100.00
---------------------+-----------------------------------
               Total |    111,778      100.00

. tab relationship, nolabel

relationshi |
          p |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |      9,381        8.39        8.39
          2 |      8,642        7.73       16.12
          3 |      6,610        5.91       22.04
          4 |      2,678        2.40       24.43
          5 |      1,142        1.02       25.45
          6 |      1,742        1.56       27.01
          7 |        205        0.18       27.20
          8 |        102        0.09       27.29
          9 |        110        0.10       27.39
         10 |          3        0.00       27.39
         11 |          1        0.00       27.39
         12 |      3,999        3.58       30.97
         13 |      4,488        4.02       34.98
         14 |         78        0.07       35.05
         15 |      5,571        4.98       40.04
         16 |         97        0.09       40.12
         17 |     13,281       11.88       52.00
         18 |      3,553        3.18       55.18
         20 |        192        0.17       55.36
         21 |        769        0.69       56.04
         22 |        228        0.20       56.25
         23 |        862        0.77       57.02
         24 |        857        0.77       57.79
         25 |      2,064        1.85       59.63
         27 |         55        0.05       59.68
         28 |         82        0.07       59.75
         29 |        742        0.66       60.42
         30 |      1,407        1.26       61.68
         33 |        941        0.84       62.52
         34 |        270        0.24       62.76
         35 |     15,714       14.06       76.82
         36 |        432        0.39       77.20
         37 |     15,584       13.94       91.15
         40 |      9,896        8.85      100.00
------------+-----------------------------------
      Total |    111,778      100.00

. tab relationship, nolabel m

relationshi |
          p |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |      9,381        8.39        8.39
          2 |      8,642        7.73       16.11
          3 |      6,610        5.91       22.03
          4 |      2,678        2.39       24.42
          5 |      1,142        1.02       25.44
          6 |      1,742        1.56       27.00
          7 |        205        0.18       27.18
          8 |        102        0.09       27.27
          9 |        110        0.10       27.37
         10 |          3        0.00       27.37
         11 |          1        0.00       27.37
         12 |      3,999        3.58       30.95
         13 |      4,488        4.01       34.96
         14 |         78        0.07       35.03
         15 |      5,571        4.98       40.01
         16 |         97        0.09       40.10
         17 |     13,281       11.88       51.98
         18 |      3,553        3.18       55.15
         20 |        192        0.17       55.32
         21 |        769        0.69       56.01
         22 |        228        0.20       56.22
         23 |        862        0.77       56.99
         24 |        857        0.77       57.75
         25 |      2,064        1.85       59.60
         27 |         55        0.05       59.65
         28 |         82        0.07       59.72
         29 |        742        0.66       60.38
         30 |      1,407        1.26       61.64
         33 |        941        0.84       62.48
         34 |        270        0.24       62.73
         35 |     15,714       14.05       76.78
         36 |        432        0.39       77.16
         37 |     15,584       13.93       91.10
         40 |      9,896        8.85       99.94
          . |         62        0.06      100.00
------------+-----------------------------------
      Total |    111,840      100.00

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. foreach changer in leaver arriver {
  2.         clear
  3.     display "Processing `changer's"
  4.         
.         use "$tempdir/`changer'_rels"
  5. 
.     rename adj_age from_age
  6. 
.         drop epppnum
  7.         
.         * get changer age *
.     gen epppnum = string(relto)
  8.     merge m:1 ssuid epppnum swave using "$tempdir/demo_long_all", keepusing(adj_age)
  9.     drop if (_merge == 2)
 10.     assert (_merge == 3)
 11.         
.     drop _merge
 12.     drop epppnum
 13.     rename adj_age to_age
 14.         
.         * bring back ego's person number
.         rename relfrom epppnum
 15.         
.         save "$tempdir/`changer'_rels_withage", $replace
 16. }    
Processing leavers

    Result                           # of obs.
    -----------------------------------------
    not matched                     2,070,244
        from master                   109,881  (_merge==1)
        from using                  1,960,363  (_merge==2)

    matched                             4,800  (_merge==3)
    -----------------------------------------
(1,960,363 observations deleted)
109,881 contradictions in 114,681 observations
assertion is false
r(9);

end of do-file

r(9);

. edit _merge if _merge==1

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. use "$tempdir/person_wide"
no; data in memory would be lost
r(4);

end of do-file

r(4);

. clear

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. use "$tempdir/person_wide"

. 
. gen num_ages = 0

. forvalues wave = $first_wave/$final_wave {
  2.     replace num_ages = num_ages + 1 if (!missing(tage`wave'))
  3. }
(105,663 real changes made)
(98,504 real changes made)
(95,252 real changes made)
(91,219 real changes made)
(90,477 real changes made)
(88,164 real changes made)
(85,397 real changes made)
(84,400 real changes made)
(82,260 real changes made)
(79,321 real changes made)
(78,101 real changes made)
(77,287 real changes made)
(76,034 real changes made)
(74,918 real changes made)
(72,474 real changes made)

. 
end of do-file

. count
  130,851

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. gen expected_age_fwd = tage$first_wave
(25,188 missing values generated)

. gen expected_age_fwd$first_wave = expected_age_fwd
(25,188 missing values generated)

. 
. * a counter; after 3 observations at current age, increase by 1
. gen num_curr_age = 0

. replace num_curr_age = 1 if (!missing(expected_age_fwd))
(105,663 real changes made)

. 
. forvalues wave = $second_wave/$final_wave {
  2.     * Increment counter of age runs if we have established an age.
.     * Set the counter to 1 if we are just now establishing an age.
.     replace num_curr_age = num_curr_age + 1 if (!missing(expected_age_fwd))
  3.     replace num_curr_age = 1 if ((!missing(tage`wave')) & (missing(expected_age_fwd)))
  4.     replace expected_age_fwd = tage`wave' if ((!missing(tage`wave')) & (missing(expected_age_fwd)))
  5. 
.     * Increment the age if we've already used it three times. Reset counter.
.     replace expected_age_fwd = expected_age_fwd + 1 if (num_curr_age > 3)
  6.     replace num_curr_age = 1 if (num_curr_age > 3)
  7. 
.     gen expected_age_fwd`wave' = expected_age_fwd
  8. }
(105,663 real changes made)
(2,616 real changes made)
(2,616 real changes made)
(0 real changes made)
(0 real changes made)
(22,572 missing values generated)
(108,279 real changes made)
(2,542 real changes made)
(2,542 real changes made)
(0 real changes made)
(0 real changes made)
(20,030 missing values generated)
(110,821 real changes made)
(2,505 real changes made)
(2,505 real changes made)
(105,663 real changes made)
(105,663 real changes made)
(17,525 missing values generated)
(113,326 real changes made)
(2,264 real changes made)
(2,264 real changes made)
(2,616 real changes made)
(2,616 real changes made)
(15,261 missing values generated)
(115,590 real changes made)
(2,113 real changes made)
(2,113 real changes made)
(2,542 real changes made)
(2,542 real changes made)
(13,148 missing values generated)
(117,703 real changes made)
(1,878 real changes made)
(1,878 real changes made)
(108,168 real changes made)
(108,168 real changes made)
(11,270 missing values generated)
(119,581 real changes made)
(1,660 real changes made)
(1,660 real changes made)
(4,880 real changes made)
(4,880 real changes made)
(9,610 missing values generated)
(121,241 real changes made)
(1,673 real changes made)
(1,673 real changes made)
(4,655 real changes made)
(4,655 real changes made)
(7,937 missing values generated)
(122,914 real changes made)
(1,597 real changes made)
(1,597 real changes made)
(110,046 real changes made)
(110,046 real changes made)
(6,340 missing values generated)
(124,511 real changes made)
(1,368 real changes made)
(1,368 real changes made)
(6,540 real changes made)
(6,540 real changes made)
(4,972 missing values generated)
(125,879 real changes made)
(1,350 real changes made)
(1,350 real changes made)
(6,328 real changes made)
(6,328 real changes made)
(3,622 missing values generated)
(127,229 real changes made)
(1,532 real changes made)
(1,532 real changes made)
(111,643 real changes made)
(111,643 real changes made)
(2,090 missing values generated)
(128,761 real changes made)
(1,161 real changes made)
(1,161 real changes made)
(7,908 real changes made)
(7,908 real changes made)
(929 missing values generated)
(129,922 real changes made)
(929 real changes made)
(929 real changes made)
(7,678 real changes made)
(7,678 real changes made)

. drop num_curr_age expected_age_fwd

. 
. * backward projection.
. gen expected_age_bkwd = tage$final_wave
(58,377 missing values generated)

. gen expected_age_bkwd$final_wave = expected_age_bkwd
(58,377 missing values generated)

. 
. gen num_curr_age = 0

. replace num_curr_age = 1 if (!missing(expected_age_bkwd))
(72,474 real changes made)

. 
. forvalues wave = $penultimate_wave (-1) $first_wave {
  2.     * Increment counter of age runs if we have established an age.
.     * Set the counter to 1 if we are just now establishing an age.
.     replace num_curr_age = num_curr_age + 1 if (!missing(expected_age_bkwd))
  3.     replace num_curr_age = 1 if ((!missing(tage`wave')) & (missing(expected_age_bkwd)))
  4.     replace expected_age_bkwd = tage`wave' if ((!missing(tage`wave')) & (missing(expected_age_bkwd)))
  5. 
.     * Decrement the age if we've already used it three times.
.     replace expected_age_bkwd = expected_age_bkwd - 1 if (num_curr_age > 3)
  6.     replace num_curr_age = 1 if (num_curr_age > 3)
  7. 
.     gen expected_age_bkwd`wave' = expected_age_bkwd
  8. }
(72,474 real changes made)
(5,880 real changes made)
(5,880 real changes made)
(0 real changes made)
(0 real changes made)
(52,497 missing values generated)
(78,354 real changes made)
(4,743 real changes made)
(4,743 real changes made)
(0 real changes made)
(0 real changes made)
(47,754 missing values generated)
(83,097 real changes made)
(5,375 real changes made)
(5,375 real changes made)
(72,474 real changes made)
(72,474 real changes made)
(42,379 missing values generated)
(88,472 real changes made)
(4,181 real changes made)
(4,181 real changes made)
(5,880 real changes made)
(5,880 real changes made)
(38,198 missing values generated)
(92,653 real changes made)
(3,937 real changes made)
(3,937 real changes made)
(4,743 real changes made)
(4,743 real changes made)
(34,261 missing values generated)
(96,590 real changes made)
(4,163 real changes made)
(4,163 real changes made)
(77,849 real changes made)
(77,849 real changes made)
(30,098 missing values generated)
(100,753 real changes made)
(3,934 real changes made)
(3,934 real changes made)
(10,061 real changes made)
(10,061 real changes made)
(26,164 missing values generated)
(104,687 real changes made)
(3,886 real changes made)
(3,886 real changes made)
(8,680 real changes made)
(8,680 real changes made)
(22,278 missing values generated)
(108,573 real changes made)
(3,964 real changes made)
(3,964 real changes made)
(82,012 real changes made)
(82,012 real changes made)
(18,314 missing values generated)
(112,537 real changes made)
(3,816 real changes made)
(3,816 real changes made)
(13,995 real changes made)
(13,995 real changes made)
(14,498 missing values generated)
(116,353 real changes made)
(3,462 real changes made)
(3,462 real changes made)
(12,566 real changes made)
(12,566 real changes made)
(11,036 missing values generated)
(119,815 real changes made)
(3,708 real changes made)
(3,708 real changes made)
(85,976 real changes made)
(85,976 real changes made)
(7,328 missing values generated)
(123,523 real changes made)
(3,572 real changes made)
(3,572 real changes made)
(17,811 real changes made)
(17,811 real changes made)
(3,756 missing values generated)
(127,095 real changes made)
(3,756 real changes made)
(3,756 real changes made)
(16,028 real changes made)
(16,028 real changes made)

. drop num_curr_age expected_age_bkwd

. 
. 
end of do-file

. count
  130,851

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. gen num_fwd_matches = 0

. gen num_bkwd_matches = 0

. forvalues wave = $first_wave/$final_wave {
  2.     gen fwd_match`wave' = ((!missing(tage`wave')) & (tage`wave' >= expected_age_fwd`wave') & (tage`wave' <= expected_age_fwd`wave' + 1))
  3.     replace num_fwd_matches = num_fwd_matches + 1 if (fwd_match`wave' == 1)
  4.     gen bkwd_match`wave' = ((!missing(tage`wave')) & (tage`wave' <= expected_age_bkwd`wave') & (tage`wave' >= expected_age_bkwd`wave' - 1))
  5.     replace num_bkwd_matches = num_bkwd_matches + 1 if (bkwd_match`wave' == 1)
  6. }
(105,663 real changes made)
(102,780 real changes made)
(97,314 real changes made)
(96,320 real changes made)
(93,506 real changes made)
(93,540 real changes made)
(88,641 real changes made)
(89,786 real changes made)
(88,351 real changes made)
(89,210 real changes made)
(85,975 real changes made)
(86,922 real changes made)
(82,660 real changes made)
(84,259 real changes made)
(82,135 real changes made)
(83,345 real changes made)
(79,927 real changes made)
(81,296 real changes made)
(76,659 real changes made)
(78,474 real changes made)
(75,851 real changes made)
(77,372 real changes made)
(74,953 real changes made)
(76,523 real changes made)
(73,362 real changes made)
(75,557 real changes made)
(72,670 real changes made)
(74,591 real changes made)
(70,198 real changes made)
(72,474 real changes made)

. 
. *check against number of observed waves to create problem flag 
. gen num_fwd_problem=num_ages-num_fwd_matches

. gen num_bkwd_problem=num_ages-num_bkwd_matches

. 
. gen anyproblem=0

. replace anyproblem=1 if num_fwd_problem > 0 | num_bkwd_problem > 0
(6,713 real changes made)

. 
. tab anyproblem

 anyproblem |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    124,138       94.87       94.87
          1 |      6,713        5.13      100.00
------------+-----------------------------------
      Total |    130,851      100.00

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. gen adj_age$first_wave = tage$first_wave
(25,188 missing values generated)

. forvalues wave = $second_wave/$final_wave {
  2. 
. * fix age when it is out of line with backwards and forwards projections
.     gen adj_age`wave' = tage`wave'
  3.     replace adj_age`wave' = expected_age_fwd`wave' if ((!missing(tage`wave')) & (fwd_match`wave' == 0) & (bkwd_match`wave' == 0) & (abs(expected_age_fwd`wave' - expected_age_bkwd`wave') <= 1))
  4.         
. * fix age when it is missing. Take forward projection first. If no forward projection, then take backward projection.   
.         replace adj_age`wave'= expected_age_fwd`wave' if missing(adj_age`wave') & !missing(expected_age_fwd`wave')
  5.         replace adj_age`wave'=expected_age_bkwd`wave' if missing(adj_age`wave') & !missing(expected_age_bkwd`wave')
  6. }
(32,347 missing values generated)
(186 real changes made)
(9,775 real changes made)
(22,572 real changes made)
(35,599 missing values generated)
(194 real changes made)
(15,569 real changes made)
(20,030 real changes made)
(39,632 missing values generated)
(268 real changes made)
(22,107 real changes made)
(17,525 real changes made)
(40,374 missing values generated)
(149 real changes made)
(25,113 real changes made)
(15,261 real changes made)
(42,687 missing values generated)
(141 real changes made)
(29,539 real changes made)
(13,148 real changes made)
(45,454 missing values generated)
(195 real changes made)
(34,184 real changes made)
(11,270 real changes made)
(46,451 missing values generated)
(134 real changes made)
(36,841 real changes made)
(9,610 real changes made)
(48,591 missing values generated)
(110 real changes made)
(40,654 real changes made)
(7,937 real changes made)
(51,530 missing values generated)
(139 real changes made)
(45,190 real changes made)
(6,340 real changes made)
(52,750 missing values generated)
(94 real changes made)
(47,778 real changes made)
(4,972 real changes made)
(53,564 missing values generated)
(90 real changes made)
(49,942 real changes made)
(3,622 real changes made)
(54,817 missing values generated)
(107 real changes made)
(52,727 real changes made)
(2,090 real changes made)
(55,933 missing values generated)
(47 real changes made)
(55,004 real changes made)
(929 real changes made)
(58,377 missing values generated)
(0 real changes made)
(58,377 real changes made)
(0 real changes made)

. 
. 
end of do-file

. count
  130,851

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. gen num_adjfwd_matches = 0

. gen num_adjbkwd_matches = 0

. forvalues wave = $first_wave/$final_wave {
  2.     gen adjfwd_match`wave' = ((!missing(adj_age`wave')) & (adj_age`wave' >= expected_age_fwd`wave') & (adj_age`wave' <= expected_age_fwd`wave' + 1))
  3.     replace num_adjfwd_matches = num_adjfwd_matches + 1 if (adjfwd_match`wave' == 1)
  4.     gen adjbkwd_match`wave' = ((!missing(adj_age`wave')) & (adj_age`wave' <= expected_age_bkwd`wave') & (adj_age`wave' >= expected_age_bkwd`wave' - 1))
  5.     replace num_adjbkwd_matches = num_adjbkwd_matches + 1 if (adjbkwd_match`wave' == 1)
  6. }
(105,663 real changes made)
(102,780 real changes made)
(107,275 real changes made)
(124,735 real changes made)
(109,269 real changes made)
(121,046 real changes made)
(111,016 real changes made)
(118,082 real changes made)
(113,613 real changes made)
(114,745 real changes made)
(115,655 real changes made)
(110,262 real changes made)
(117,039 real changes made)
(107,025 real changes made)
(119,110 real changes made)
(103,307 real changes made)
(120,691 real changes made)
(98,919 real changes made)
(121,988 real changes made)
(95,335 real changes made)
(123,723 real changes made)
(91,620 real changes made)
(124,985 real changes made)
(87,153 real changes made)
(126,196 real changes made)
(82,462 real changes made)
(127,721 real changes made)
(77,970 real changes made)
(128,575 real changes made)
(72,474 real changes made)

. 
. gen num_adjfwd_problem=num_ages-num_adjfwd_matches

. gen num_adjbkwd_problem=num_ages-num_adjbkwd_matches

. 
. gen any_adj_problem=0

. replace any_adj_problem=1 if num_adjfwd_problem > 0 | num_adjbkwd_problem > 0
(4,770 real changes made)

. 
end of do-file

. count
  130,851

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. gen monotonic = 1 /* dpes age always increase? */

. gen ageproblem=0 /* are there deviations in age from one observation to the next greater than 5 */

. gen childageproblem=0

. gen curr_age = adj_age$first_wave
(25,188 missing values generated)

. forvalues wave = $second_wave/$final_wave {
  2.     replace monotonic = 0 if ((!missing(adj_age`wave')) & (!missing(curr_age)) & (adj_age`wave' < curr_age))
  3.         replace ageproblem=1 if ((!missing(adj_age`wave')) & (!missing(curr_age)) & (abs(adj_age`wave'-curr_age) > 5))
  4.         replace childageproblem=1 if ((!missing(adj_age`wave')) & (!missing(curr_age)) & (abs(adj_age`wave'-curr_age) > 5)) & (curr_age < 18)
  5.     replace curr_age = adj_age`wave' if (!missing(adj_age`wave'))
  6. }
(534 real changes made)
(261 real changes made)
(38 real changes made)
(57,457 real changes made)
(3,627 real changes made)
(361 real changes made)
(57 real changes made)
(39,221 real changes made)
(757 real changes made)
(181 real changes made)
(40 real changes made)
(59,783 real changes made)
(662 real changes made)
(129 real changes made)
(35 real changes made)
(34,547 real changes made)
(2,799 real changes made)
(104 real changes made)
(22 real changes made)
(36,434 real changes made)
(490 real changes made)
(108 real changes made)
(32 real changes made)
(65,193 real changes made)
(476 real changes made)
(74 real changes made)
(43 real changes made)
(32,955 real changes made)
(2,165 real changes made)
(64 real changes made)
(21 real changes made)
(34,236 real changes made)
(334 real changes made)
(68 real changes made)
(23 real changes made)
(68,465 real changes made)
(426 real changes made)
(54 real changes made)
(24 real changes made)
(31,221 real changes made)
(1,762 real changes made)
(91 real changes made)
(29 real changes made)
(32,889 real changes made)
(305 real changes made)
(55 real changes made)
(34 real changes made)
(70,866 real changes made)
(352 real changes made)
(48 real changes made)
(23 real changes made)
(30,803 real changes made)
(1,140 real changes made)
(19 real changes made)
(19 real changes made)
(30,315 real changes made)

. 
. tab ageproblem anyproblem

           |      anyproblem
ageproblem |         0          1 |     Total
-----------+----------------------+----------
         0 |   124,138      5,096 |   129,234 
         1 |         0      1,617 |     1,617 
-----------+----------------------+----------
     Total |   124,138      6,713 |   130,851 

. tab childageproblem

childagepro |
       blem |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    130,411       99.66       99.66
          1 |        440        0.34      100.00
------------+-----------------------------------
      Total |    130,851      100.00

. 
. tab ageproblem any_adj_problem

           |    any_adj_problem
ageproblem |         0          1 |     Total
-----------+----------------------+----------
         0 |   125,872      3,362 |   129,234 
         1 |       209      1,408 |     1,617 
-----------+----------------------+----------
     Total |   126,081      4,770 |   130,851 

. 
end of do-file

. count
  130,851

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. drop curr_age

. drop expected_age_bkwd* expected_age_fwd*

. drop adjbkwd* adjfwd*

. drop bkwd* fwd*

. drop monotonic

. drop num_adjbkwd_matches num_adjfwd_matches 

. drop anyproblem

. drop any_adj_problem

. drop tage*

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. * Create dummies for whether in this interview to be able to create an indicator for whether in interview next wave
. forvalues w=1/$final_wave {
  2.   gen in`w'=0
  3.   replace in`w'=1 if !missing(errp`w')
  4.   }
(105,663 real changes made)
(98,504 real changes made)
(95,252 real changes made)
(91,219 real changes made)
(90,477 real changes made)
(88,164 real changes made)
(85,397 real changes made)
(84,400 real changes made)
(82,260 real changes made)
(79,321 real changes made)
(78,101 real changes made)
(77,287 real changes made)
(76,034 real changes made)
(74,918 real changes made)
(72,474 real changes made)

.   
. forvalues w=1/$penultimate_wave {
  2.   local x=`w'+1
  3.   gen innext`w'=0
  4.   replace innext`w'=1 if in`x'==1
  5.  }
(98,504 real changes made)
(95,252 real changes made)
(91,219 real changes made)
(90,477 real changes made)
(88,164 real changes made)
(85,397 real changes made)
(84,400 real changes made)
(82,260 real changes made)
(79,321 real changes made)
(78,101 real changes made)
(77,287 real changes made)
(76,034 real changes made)
(74,918 real changes made)
(72,474 real changes made)

. 
. 
end of do-file

. count
  130,851

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. save "$tempdir/person_wide_adjusted_ages", $replace
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/person_wide_adjusted_ages.dta saved

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. keep ssuid epppnum ems* errp* wpfinwgt* eorigin* ebornus* etypmom* etypdad* my_race my_racealt my_sex mom_educ* dad_educ* mom_immigrant* dad_immigrant* adj_age* mom_age* biomom_age* biomom_educ* da
> d_age* biodad_age* innext* ref_person* ref_person_sex* ref_person_educ* biomom_ed_first mom_ed_first dad_ed_first par_ed_first mom_measure

. 
end of do-file

. count
  130,851

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. save "$tempdir/demo_wide.dta", $replace
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/demo_wide.dta saved

. 
. reshape long adj_age ems errp wpfinwgt eorigin ebornus etypmom etypdad mom_educ dad_educ mom_immigrant dad_immigrant mom_age biomom_age biomom_educ dad_age biodad_age innext ref_person ref_person_s
> ex ref_person_educ, i(ssuid epppnum) j(swave)
(note: j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15)
(note: innext15 not found)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                   130851   -> 2.0e+06
Number of variables                 324   ->      32
j variable (15 values)                    ->   swave
xij variables:
        adj_age1 adj_age2 ... adj_age15   ->   adj_age
                    ems1 ems2 ... ems15   ->   ems
                 errp1 errp2 ... errp15   ->   errp
     wpfinwgt1 wpfinwgt2 ... wpfinwgt15   ->   wpfinwgt
        eorigin1 eorigin2 ... eorigin15   ->   eorigin
        ebornus1 ebornus2 ... ebornus15   ->   ebornus
        etypmom1 etypmom2 ... etypmom15   ->   etypmom
        etypdad1 etypdad2 ... etypdad15   ->   etypdad
     mom_educ1 mom_educ2 ... mom_educ15   ->   mom_educ
     dad_educ1 dad_educ2 ... dad_educ15   ->   dad_educ
mom_immigrant1 mom_immigrant2 ... mom_immigrant15->mom_immigrant
dad_immigrant1 dad_immigrant2 ... dad_immigrant15->dad_immigrant
        mom_age1 mom_age2 ... mom_age15   ->   mom_age
biomom_age1 biomom_age2 ... biomom_age15  ->   biomom_age
biomom_educ1 biomom_educ2 ... biomom_educ15->  biomom_educ
        dad_age1 dad_age2 ... dad_age15   ->   dad_age
biodad_age1 biodad_age2 ... biodad_age15  ->   biodad_age
           innext1 innext2 ... innext15   ->   innext
ref_person1 ref_person2 ... ref_person15  ->   ref_person
ref_person_sex1 ref_person_sex2 ... ref_person_sex15->ref_person_sex
ref_person_educ1 ref_person_educ2 ... ref_person_educ15->ref_person_educ
-----------------------------------------------------------------------------

. 
. label variable adj_age "Adjusted Age"

. label variable innext "Is this person interviewed in next wave?"

. 
. * now includes all observations, even when missing interview. errp is missing when no interview.
. tab errp,m 

        PE: Household relationship |      Freq.     Percent        Cum.
-----------------------------------+-----------------------------------
     Reference person with related |    340,052       17.33       17.33
  Reference Person without related |    166,826        8.50       25.82
        Spouse of reference person |    251,028       12.79       38.61
         Child of reference person |    391,373       19.94       58.55
    Grandchild of reference person |     31,181        1.59       60.14
        Parent of reference person |     11,590        0.59       60.73
Brother/sister of reference person |     10,981        0.56       61.29
Other relative of reference person |     25,128        1.28       62.57
  Foster child of reference person |      1,523        0.08       62.65
    Unmarried partner of reference |     23,598        1.20       63.85
                Housemate/roommate |     10,989        0.56       64.41
                    Roomer/boarder |      3,286        0.17       64.58
   Other non-relative of reference |     11,916        0.61       65.19
                                 . |    683,294       34.81      100.00
-----------------------------------+-----------------------------------
                             Total |  1,962,765      100.00

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. * most important for linking to arrivers who have missing data 
. save "$tempdir/demo_long_all", $replace
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/demo_long_all.dta saved

. 
. drop if missing(errp)
(683,294 observations deleted)

. 
. save "$tempdir/demo_long_interviews", $replace
file C:\Users\Joanna/Dropbox/Repositories/SIPP_Breadwinning/childhh//stata_data/stata_tmp/demo_long_interviews.dta saved

. 
end of do-file

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. foreach changer in leaver arriver {
  2.         clear
  3.     display "Processing `changer's"
  4.         
.         use "$tempdir/`changer'_rels"
  5. 
.     rename adj_age from_age
  6. 
.         drop epppnum
  7.         
.         * get changer age *
.     gen epppnum = string(relto)
  8.     merge m:1 ssuid epppnum swave using "$tempdir/demo_long_all", keepusing(adj_age)
  9.     drop if (_merge == 2)
 10.     assert (_merge == 3)
 11.         
.     drop _merge
 12.     drop epppnum
 13.     rename adj_age to_age
 14.         
.         * bring back ego's person number
.         rename relfrom epppnum
 15.         
.         save "$tempdir/`changer'_rels_withage", $replace
 16. }    
Processing leavers

    Result                           # of obs.
    -----------------------------------------
    not matched                     2,070,244
        from master                   109,881  (_merge==1)
        from using                  1,960,363  (_merge==2)

    matched                             4,800  (_merge==3)
    -----------------------------------------
(1,960,363 observations deleted)
109,881 contradictions in 114,681 observations
assertion is false
r(9);

end of do-file

r(9);

. do "C:\Users\Joanna\AppData\Local\Temp\STD3f6c_000000.tmp"

. do "$childhh_base_code/do_and_log" "$sipp2008_code" "$sipp2008_logs" create_changer_rels 

. * This file executes do files, but first executes
. * standard startup boilerplate and last executes
. * standard completion boilerplate.
. 
. * It takes three parameters, 
. *  1. the directory where the project code lives.
. *  2. the directory where log files should go.
. *  3. the basename of the do file.  
. *
. * "Basename" just means the name without the .do or .log on the end.
. * The basename is also used as the basename of the log file.
. 
. 
. 
. args codedir logdir fname

. 
. 
. do "$childhh_base_code/childhh_prolog" "`logdir'" "`fname'"

. * Boilerplate prolog for ChildHH project.
. * This should be executed at least once at the
. * beginning of running (sub)project code.
. 
. * It takes two parameters, the log directory and the basename of the log file.  
. * "Basename" just means the name without the .log on the end.
. 
. 
. args logdir fname

. 
. capture log close
